<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Distribution Systems Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        .input-section, .output-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light);
            color: var(--primary);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .financial-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .unit-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .unit-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--light);
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .unit-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .standard-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .standard-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--light);
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .standard-btn.active {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .work-item {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }

        .work-item-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .bill-of-quantity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .bill-of-quantity-table th,
        .bill-of-quantity-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .bill-of-quantity-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .bill-of-quantity-table tr:hover {
            background-color: #f5f5f5;
        }

        .total-row {
            font-weight: 600;
            background-color: var(--light) !important;
        }

        .section-header {
            font-weight: 600;
            background-color: #e9ecef;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .cost-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 1rem;
        }

        .cost-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-top: 4px solid var(--secondary);
        }

        .cost-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin: 10px 0;
        }

        .validation-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }

        .tab-container {
            margin-bottom: 1rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        .unit-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        .help-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--success);
        }

        .formula-box {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid var(--secondary);
            font-family: 'Courier New', monospace;
        }

        .reference-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid var(--warning);
        }

        .step-guide {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid var(--secondary);
        }

        .step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            margin-right: 10px;
            font-weight: bold;
        }

        /* Added for better user-friendliness */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .crew-sizing {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        .crew-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .crew-option {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Power Distribution Systems Calculator</h1>
                <div class="controls">
                    <button class="btn btn-success" id="exportPdfBtn">Export PDF</button>
                    <button class="btn btn-success" id="exportExcelBtn">Export Excel</button>
                    <button class="btn btn-danger" id="resetBtn">Reset</button>
                </div>
            </div>
        </header>

        <div class="calculator-grid">
            <div class="input-section">
                <h2 class="section-title">Project Inputs</h2>

                <div class="input-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" placeholder="Enter project name">
                </div>

                <div class="input-group">
                    <label>Client Name</label>
                    <input type="text" id="clientName" placeholder="Enter client name">
                </div>

                <div class="input-group">
                    <label>Project Location</label>
                    <input type="text" id="projectLocation" placeholder="e.g., Manila, Philippines">
                </div>

                <div class="input-group">
                    <label>Prepared By</label>
                    <input type="text" id="preparedBy" placeholder="Enter preparer name">
                </div>

                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="projectDate">
                </div>

                <div class="input-group">
                    <label>Unit System</label>
                    <div class="unit-toggle">
                        <div class="unit-btn active" data-unit="metric">Metric (SI)</div>
                        <div class="unit-btn" data-unit="imperial">Imperial (US)</div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Electrical Standards</label>
                    <div class="standard-toggle">
                        <div class="standard-btn active" data-standard="philippine">Philippine (PEC)</div>
                        <div class="standard-btn" data-standard="international">International (IEC)</div>
                    </div>
                </div>

                <div class="tab-container">
                    <div class="tabs" role="tablist" aria-label="Project input sections">
                        <div class="tab active" role="tab" aria-selected="true" aria-controls="general-tab" data-tab="general" id="tab-general">General Parameters</div>
                        <div class="tab" role="tab" aria-selected="false" aria-controls="distribution-tab" data-tab="distribution" id="tab-distribution">Distribution Systems</div>
                        <div class="tab" role="tab" aria-selected="false" aria-controls="cables-tab" data-tab="cables" id="tab-cables">Cables & Wiring</div>
                        <div class="tab" role="tab" aria-selected="false" aria-controls="costs-tab" data-tab="costs" id="tab-costs">Additional Costs</div>
                        <div class="tab" role="tab" aria-selected="false" aria-controls="help-tab" data-tab="help" id="tab-help">Help & Reference</div>
                    </div>

                    <div class="tab-content active" id="general-tab" role="tabpanel" aria-labelledby="tab-general">
                        <div class="input-row">
                            <div class="input-group">
                                <label class="tooltip">Labor Rate (per hour)<span class="tooltiptext">Hourly rate for labor, adjust based on region and standards</span></label>
                                <input type="number" id="laborRate" value="250" step="0.01">
                                <div class="unit-label">PHP/hour</div>
                            </div>
                            <div class="input-group">
                                <label class="tooltip">Overhead Rate (%)<span class="tooltiptext">Percentage for general overhead costs</span></label>
                                <input type="number" id="overheadRate" value="15" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="tooltip">Profit Margin (%)<span class="tooltiptext">Desired profit margin percentage</span></label>
                                <input type="number" id="profitMarginRate" value="20" step="0.1">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Currency</label>
                                <select id="currency">
                                    <option value="PHP">Philippine Peso (₱)</option>
                                    <option value="USD">US Dollar ($)</option>
                                    <option value="EUR">Euro (€)</option>
                                    <option value="JPY">Japanese Yen (¥)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="distribution-tab" role="tabpanel" aria-labelledby="tab-distribution">
                        <div class="work-item">
                            <div class="work-item-title">Main Distribution Boards (MDBs)</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Quantity</label>
                                    <input type="number" id="mdbQty" value="1" min="0">
                                    <div class="unit-label">pcs</div>
                                </div>
                                <div class="input-group">
                                    <label>Unit Cost</label>
                                    <input type="number" id="mdbUnitCost" value="50000" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per Unit</label>
                                    <input type="number" id="mdbLaborHours" value="16" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">Sub-Main Distribution Boards (SMDBs)</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Quantity</label>
                                    <input type="number" id="smdbQty" value="4" min="0">
                                    <div class="unit-label">pcs</div>
                                </div>
                                <div class="input-group">
                                    <label>Unit Cost</label>
                                    <input type="number" id="smdbUnitCost" value="10000" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per Unit</label>
                                    <input type="number" id="smdbLaborHours" value="12" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">Distribution Panels</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Quantity</label>
                                    <input type="number" id="panelQty" value="8" min="0">
                                    <div class="unit-label">pcs</div>
                                </div>
                                <div class="input-group">
                                    <label>Unit Cost</label>
                                    <input type="number" id="panelUnitCost" value="8000" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per Unit</label>
                                    <input type="number" id="panelLaborHours" value="6" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">Circuit Breakers</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Quantity</label>
                                    <input type="number" id="breakerQty" value="24" min="0">
                                    <div class="unit-label">pcs</div>
                                </div>
                                <div class="input-group">
                                    <label>Unit Cost</label>
                                    <input type="number" id="breakerUnitCost" value="1200" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per Unit</label>
                                    <input type="number" id="breakerLaborHours" value="0.5" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="cables-tab" role="tabpanel" aria-labelledby="tab-cables">
                        <div class="work-item">
                            <div class="work-item-title">Power Cables</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Length</label>
                                    <input type="number" id="cableLength" value="500" min="0" step="0.1">
                                    <div class="unit-label length-unit">meters</div>
                                </div>
                                <div class="input-group">
                                    <label>Cost per Unit</label>
                                    <input type="number" id="cableCostPerUnit" value="150" step="0.01">
                                    <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per 100<span class="length-unit-short">m</span></label>
                                    <input type="number" id="cableLaborHours" value="8" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>
                        <div class="work-item">
                            <div class="work-item-title">Cable Trays</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Length</label>
                                    <input type="number" id="trayLength" value="200" min="0" step="0.1">
                                    <div class="unit-label length-unit">meters</div>
                                </div>
                                <div class="input-group">
                                    <label>Cost per Unit</label>
                                    <input type="number" id="trayCostPerUnit" value="120" step="0.01">
                                    <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per 100<span class="length-unit-short">m</span></label>
                                    <input type="number" id="trayLaborHours" value="10" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>
                        <div class="work-item">
                            <div class="work-item-title">Conduits</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Length</label>
                                    <input type="number" id="conduitLength" value="100" min="0" step="0.1">
                                    <div class="unit-label length-unit">meters</div>
                                </div>
                                <div class="input-group">
                                    <label>Cost per Unit</label>
                                    <input type="number" id="conduitCostPerUnit" value="80" step="0.01">
                                    <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per 100<span class="length-unit-short">m</span></label>
                                    <input type="number" id="conduitLaborHours" value="15" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>
                        <div class="work-item">
                            <div class="work-item-title">Bus Ducts</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Length</label>
                                    <input type="number" id="busductLength" value="50" min="0" step="0.1">
                                    <div class="unit-label length-unit">meters</div>
                                </div>
                                <div class="input-group">
                                    <label>Cost per Unit</label>
                                    <input type="number" id="busductCostPerUnit" value="2000" step="0.01">
                                    <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per 10<span class="length-unit-short">m</span></label>
                                    <input type="number" id="busductLaborHours" value="16" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>
                        <div class="work-item">
                            <div class="work-item-title">Outlets</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Quantity</label>
                                    <input type="number" id="outletQty" value="40" min="0">
                                    <div class="unit-label">pcs</div>
                                </div>
                                <div class="input-group">
                                    <label>Unit Cost</label>
                                    <input type="number" id="outletUnitCost" value="180" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per Unit</label>
                                    <input type="number" id="outletLaborHours" value="0.3" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">Switches</div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Quantity</label>
                                    <input type="number" id="switchQty" value="20" min="0">
                                    <div class="unit-label">pcs</div>
                                </div>
                                <div class="input-group">
                                    <label>Unit Cost</label>
                                    <input type="number" id="switchUnitCost" value="120" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                                <div class="input-group">
                                    <label>Labor Hours per Unit</label>
                                    <input type="number" id="switchLaborHours" value="0.2" step="0.1">
                                    <div class="unit-label">hours</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="costs-tab" role="tabpanel" aria-labelledby="tab-costs">
                        <div class="work-item">
                            <div class="work-item-title">Direct Costs</div>
                            <div class="financial-input-row">
                                <div class="input-group">
                                    <label>Equipment Rental/Mobilization</label>
                                    <input type="number" id="equipmentCost" value="15000" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                                <div class="input-group">
                                    <label>Tools & Consumables</label>
                                    <input type="number" id="toolsCost" value="5000" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                            </div>
                        </div>

                        <div class="work-item">
                            <div class="work-item-title">Indirect Costs</div>
                            <div class="financial-input-row">
                                <div class="input-group">
                                    <label>Contingency (%)</label>
                                    <input type="number" id="contingencyRate" value="10" step="0.1">
                                </div>
                                <div class="input-group">
                                    <label>VAT Tax Rate (%)</label>
                                    <input type="number" id="taxRate" value="12" step="0.1">
                                </div>
                            </div>
                            <div class="financial-input-row">
                                <div class="input-group">
                                    <label>Permits & Fees</label>
                                    <input type="number" id="permitsCost" value="10000" step="0.01">
                                    <div class="unit-label">currency</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="help-tab" role="tabpanel" aria-labelledby="tab-help">
                        <div class="help-section">
                            <h3>How to Use This Calculator</h3>
                            <div class="step-guide">
                                <p><span class="step-number">1</span> <strong>Project Information:</strong> Enter basic project details including project name, client name, location, and select your preferred unit system and electrical standards.</p>
                                <p><span class="step-number">2</span> <strong>Distribution Systems:</strong> Input quantities and costs for main distribution boards (MDBs), sub-main boards (SMDBs), distribution panels, and circuit breakers.</p>
                                <p><span class="step-number">3</span> <strong>Cables & Wiring:</strong> Specify lengths and costs for power cables, cable trays, conduits, bus ducts, outlets, and switches. Unit system switch automatically converts values.</p>
                                <p><span class="step-number">4</span> <strong>Additional Costs:</strong> Configure direct costs (equipment, tools, permits) and indirect costs (contingency, profit margin, VAT).</p>
                                <p><span class="step-number">5</span> <strong>Calculate:</strong> Click "Calculate" to generate your cost breakdown and labor requirements.</p>
                                <p><span class="step-number">6</span> <strong>Export:</strong> Use the export buttons to save your estimate as PDF or Excel for professional submissions.</p>
                            </div>
                        </div>

                        <div class="help-section">
                            <h3>Calculation Formulas</h3>
                            <div class="formula-box">
                                <h4>Direct Costs:</h4>
                                <p><strong>Total Material Cost</strong> = ∑(Quantity × Unit Cost)</p>
                                <p><strong>Total Labor Cost</strong> = ∑(Quantity × Labor Hours × Labor Rate)</p>
                                <p><strong>Total Direct Cost</strong> = Materials + Labor + Equipment + Tools + Permits</p>

                                <h4>Indirect Costs:</h4>
                                <p><strong>Overhead Cost</strong> = Total Direct Cost × Overhead Rate</p>
                                <p><strong>Contingency Cost</strong> = Total Direct Cost × Contingency Rate</p>
                                <p><strong>Total Indirect Cost</strong> = Overhead + Contingency</p>

                                <h4>Profit & Tax:</h4>
                                <p><strong>Cost Before Profit</strong> = Direct Costs + Indirect Costs</p>
                                <p><strong>Profit</strong> = Cost Before Profit × Profit Margin Rate</p>
                                <p><strong>Total Before Tax</strong> = Cost Before Profit + Profit</p>
                                <p><strong>VAT Tax</strong> = Total Before Tax × VAT Rate</p>
                                <p><strong>Final Price</strong> = Total Before Tax + VAT Tax</p>
                            </div>
                        </div>

                        <div class="help-section">
                            <h3>References & Standards</h3>
                            <div class="reference-box">
                                <h4>Philippine Electrical Code (PEC) References:</h4>
                                <ul>
                                    <li><strong>PEC Article 2.40.1.1</strong> - Requirements for Main Distribution Boards</li>
                                    <li><strong>PEC Article 3.10.2.12</strong> - Cable Installation Standards</li>
                                    <li><strong>PEC Article 2.30.6.1</strong> - Circuit Breaker Specifications</li>
                                    <li><strong>PEC Article 1.10.1.2</strong> - General Installation Requirements</li>
                                </ul>

                                <h4>International Standards (IEC):</h4>
                                <ul>
                                    <li><strong>IEC 61439</strong> - Low-voltage switchgear and controlgear assemblies</li>
                                    <li><strong>IEC 60364</strong> - Electrical installations of buildings</li>
                                    <li><strong>IEC 60947</strong> - Low-voltage switchgear and controlgear</li>
                                    <li><strong>IEC 60204</strong> - Safety of machinery - Electrical equipment</li>
                                </ul>

                                <h4>Legal & Tax References:</h4>
                                <ul>
                                    <li><strong>Philippine VAT Law</strong> - 12% Value Added Tax (RA 9337)</li>
                                    <li><strong>Construction Industry Authority</strong> - Standard markup practices</li>
                                    <li><strong>DOLE Department Order</strong> - Standard labor rates for electrical works</li>
                                </ul>
                            </div>
                        </div>

                        <div class="help-section">
                            <h3>Labor & Productivity Rates</h3>
                            <div class="reference-box">
                                <h4>Standard Labor Rates (Philippines):</h4>
                                <ul>
                                    <li><strong>Master Electrician</strong>: ₱300-400/hour</li>
                                    <li><strong>Journeyman Electrician</strong>: ₱250-350/hour</li>
                                    <li><strong>Apprentice/Electrician Helper</strong>: ₱150-250/hour</li>
                                </ul>

                                <h4>Productivity Standards:</h4>
                                <ul>
                                    <li><strong>MDB Installation</strong>: 12-16 hours per unit</li>
                                    <li><strong>SMDB Installation</strong>: 8-12 hours per unit</li>
                                    <li><strong>Cable Installations</strong>: 8-12 hours per 100 meters</li>
                                    <li><strong>Cable Tray Installation</strong>: 8-12 hours per 100 meters</li>
                                    <li><strong>Conduit Installation</strong>: 12-18 hours per 100 meters</li>
                                    <li><strong>Bus Duct Installation</strong>: 12-16 hours per 10 meters</li>
                                    <li><strong>Outlet Installation</strong>: 0.25-0.4 hours per unit</li>
                                    <li><strong>Switch Installation</strong>: 0.15-0.3 hours per unit</li>
                                </ul>

                                <h4>Basis for Rates:</h4>
                                <ul>
                                    <li>Philippine Construction Industry Authority guidelines</li>
                                    <li>DOLE prescribed wage rates</li>
                                    <li>Industry standard productivity benchmarks</li>
                                    <li>Historical project data analysis</li>
                                </ul>
                            </div>
                        </div>

                        <div class="help-section">
                            <h3>Cost Categorization</h3>
                            <div class="reference-box">
                                <h4>Direct Costs (Project-Specific):</h4>
                                <ul>
                                    <li>Materials (MDBs, SMDBs, cables, panels, breakers)</li>
                                    <li>Labor (Installation workforce)</li>
                                    <li>Equipment Rental & Mobilization</li>
                                    <li>Tools & Consumables</li>
                                    <li>Permits & Regulatory Fees</li>
                                </ul>

                                <h4>Indirect Costs (Overhead):</h4>
                                <ul>
                                    <li>General & Administrative Overhead (15-25%)</li>
                                    <li>Contingency (5-15%)</li>
                                </ul>

                                <h4>Markup:</h4>
                                <ul>
                                    <li>Profit Margin (15-25%)</li>
                                    <li>VAT Tax (12% in Philippines)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="validation-error" id="validationError">
                        Please check your inputs. Some values are missing or invalid.
                    </div>

                    <button class="btn btn-primary" id="calculateBtn" style="width: 100%; padding: 12px; margin-top: 20px;">
                        Calculate
                    </button>
                </div>
            </div>

            <div class="output-section">
                <h2 class="section-title">Estimate Results</h2>

                <div id="resultsPlaceholder">
                    <p>Enter your project details and click "Calculate" to see results.</p>
                </div>

                <div id="resultsContent" class="hidden">
                    <h3>Project: <span id="resultProjectName"></span></h3>
                    <p><strong>Client:</strong> <span id="resultClientName"></span></p>
                    <p><strong>Location:</strong> <span id="resultProjectLocation"></span></p>
                    <p><strong>Prepared By:</strong> <span id="resultPreparedBy"></span></p>
                    <p><strong>Date:</strong> <span id="resultProjectDate"></span></p>
                    <p><strong>Standard:</strong> <span id="resultStandard"></span></p>

                    <h4 style="margin-top: 20px;">Bill of Quantity</h4>
                    <table class="bill-of-quantity-table" id="billOfQuantityTable">
                        <thead>
                            <tr>
                                <th class="text-center">Item No.</th>
                                <th>Scope of Work</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-center">Unit</th>
                                <th class="text-right">Material Cost</th>
                                <th class="text-right">Labor Hours</th>
                                <th class="text-right">Labor Cost</th>
                                <th class="text-right">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="billOfQuantityTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>

                    <h4 style="margin-top: 20px;">Other Costs (Permits & Fees)</h4>
                    <table class="bill-of-quantity-table">
                        <thead>
                            <tr>
                                <th class="text-center">Item No.</th>
                                <th>Scope of Work</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-center">Unit</th>
                                <th class="text-right">Material Cost</th>
                                <th class="text-right">Labor Hours</th>
                                <th class="text-right">Labor Cost</th>
                                <th class="text-right">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="otherCostsTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>

                    <h4 style="margin-top: 20px;">Indirect Costs & Markup</h4>
                    <table class="bill-of-quantity-table">
                        <thead>
                            <tr>
                                <th class="text-center">Item No.</th>
                                <th>Scope of Work</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-center">Unit</th>
                                <th class="text-right">Material Cost</th>
                                <th class="text-right">Labor Hours</th>
                                <th class="text-right">Labor Cost</th>
                                <th class="text-right">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="indirectCostsTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>

                    <h4 style="margin-top: 20px;">Summary</h4>
                    <table class="bill-of-quantity-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="text-right">Material Cost</th>
                                <th class="text-right">Labor Hours</th>
                                <th class="text-right">Labor Cost</th>
                                <th class="text-right">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>

                    <div id="crewSizingSection" class="crew-sizing hidden">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUnitSystem = 'metric';
        let currentStandard = 'philippine';
        let projectData = {};
        const FEET_PER_METER = 3.28084;

        // DOM elements
        const unitButtons = document.querySelectorAll('.unit-btn');
        const standardButtons = document.querySelectorAll('.standard-btn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const validationError = document.getElementById('validationError');
        const resultsPlaceholder = document.getElementById('resultsPlaceholder');
        const resultsContent = document.getElementById('resultsContent');
        const crewSizingSection = document.getElementById('crewSizingSection');

        // Initialize date to today
        document.getElementById('projectDate').valueAsDate = new Date();

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Unit system toggle
            unitButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const newUnit = this.getAttribute('data-unit');
                    if (newUnit != currentUnitSystem) {
                        convertUnits(newUnit);
                    }
                    unitButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentUnitSystem = newUnit;
                    updateUnitLabels();
                });
            });

            // Standard toggle
            standardButtons.forEach(button => {
                button.addEventListener('click', function() {
                    standardButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentStandard = this.getAttribute('data-standard');
                    updateStandards();
                });
            });

            // Tab navigation with accessibility
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');

                    // Update tab states
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    tabContents.forEach(c => {
                        c.classList.remove('active');
                    });

                    // Activate selected tab
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    const content = document.getElementById(`${tabId}-tab`);
                    content.classList.add('active');
                });

                // Add keyboard navigation
                tab.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });

            // Calculate button
            calculateBtn.addEventListener('click', calculateEstimate);

            // Reset button
            resetBtn.addEventListener('click', resetCalculator);

            // Export buttons
            exportPdfBtn.addEventListener('click', exportToPdf);
            exportExcelBtn.addEventListener('click', exportToExcel);

            // Input validation
            setupInputValidation();
        });

        // Utility functions
        function safeNumber(v, fallback = 0) {
            if (v === "" || v === null || v === undefined) return fallback;
            const n = Number(v);
            return isNaN(n) ? fallback : n;
        }

        function formatNumber(num, dp = 2) {
            if (typeof num !== 'number' || isNaN(num)) return "";
            const rounded = Math.round((num + Number.EPSILON) * Math.pow(10, dp)) / Math.pow(10, dp);
            return rounded.toLocaleString(undefined, { minimumFractionDigits: dp, maximumFractionDigits: dp });
        }

        function formatCurrency(n) {
            if (typeof n !== 'number' || isNaN(n)) return "";
            const c = document.getElementById('currency').value;
            
            let symbol = '';
            switch (c) {
                case 'PHP':
                    symbol = '₱'; // Philippine Peso
                    break;
                case 'USD':
                    symbol = '$'; // US Dollar
                    break;
                case 'EUR':
                    symbol = '€'; // Euro
                    break;
                case 'JPY':
                    symbol = '¥'; // Japanese Yen
                    break;
                default:
                    symbol = c + ' '; // Fallback to code + space
            }
            
            return symbol + ' ' + formatNumber(n, 2);
        }

        // Functions
        function updateUnitLabels() {
            const lengthUnit = currentUnitSystem === 'metric' ? 'meters' : 'feet';
            const lengthUnitShort = currentUnitSystem === 'metric' ? 'm' : 'ft';
            document.querySelectorAll('.length-unit').forEach(unit => {
                unit.textContent = lengthUnit;
            });
            document.querySelectorAll('.length-unit-short').forEach(unit => {
                unit.textContent = lengthUnitShort;
            });
        }

        function convertUnits(newUnit) {
            const factor = (newUnit === 'imperial' && currentUnitSystem === 'metric') ? FEET_PER_METER :
                (newUnit === 'metric' && currentUnitSystem === 'imperial') ? 1 / FEET_PER_METER : 1;
            if (factor === 1) return;

            // Length fields
            const lengthIds = ['cableLength', 'trayLength', 'conduitLength', 'busductLength'];
            lengthIds.forEach(id => {
                const input = document.getElementById(id);
                input.value = safeNumber(input.value) * factor;
            });
            // Cost per unit fields
            const costIds = ['cableCostPerUnit', 'trayCostPerUnit', 'conduitCostPerUnit', 'busductCostPerUnit'];
            costIds.forEach(id => {
                const input = document.getElementById(id);
                input.value = safeNumber(input.value) / factor;
            });
            // Labor hours per unit length
            const laborIds = ['cableLaborHours', 'trayLaborHours', 'conduitLaborHours', 'busductLaborHours'];
            laborIds.forEach(id => {
                const input = document.getElementById(id);
                input.value = safeNumber(input.value) / factor;
            });
        }

        function updateStandards() {
            // Update labor rates based on standards
            const laborRateInput = document.getElementById('laborRate');
            if (currentStandard === 'philippine') {
                laborRateInput.value = '250'; // PHP average rate
                document.getElementById('taxRate').value = '12'; // VAT in Philippines
            } else {
                laborRateInput.value = '45'; // USD average rate
                document.getElementById('taxRate').value = '0';
            }
        }

        function setupInputValidation() {
            const numberInputs = document.querySelectorAll('input[type="number"]');

            numberInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value < 0) {
                        this.value = 0;
                    }
                    if (this.hasAttribute('min') && this.value < this.getAttribute('min')) {
                        this.value = this.getAttribute('min');
                    }
                });
            });
        }

        function validateInputs() {
            let isValid = true;
            const requiredInputs = document.querySelectorAll('input[type="number"]');

            requiredInputs.forEach(input => {
                if (!input.value || isNaN(parseFloat(input.value))) {
                    isValid = false;
                    input.style.borderColor = 'var(--danger)';
                } else {
                    input.style.borderColor = "";
                }
            });

            if (!isValid) {
                validationError.style.display = 'block';
            } else {
                validationError.style.display = 'none';
            }

            return isValid;
        }

        function calculateEstimate() {
            if (!validateInputs()) {
                return;
            }
            
            // Get general parameters using safeNumber
            const laborRate = safeNumber(document.getElementById('laborRate').value, 250);
            const overheadRate = safeNumber(document.getElementById('overheadRate').value, 15) / 100;
            const profitMarginRate = safeNumber(document.getElementById('profitMarginRate').value, 20) / 100;
            const currency = document.getElementById('currency').value;
            const equipmentCost = safeNumber(document.getElementById('equipmentCost').value, 0);
            const permitsCost = safeNumber(document.getElementById('permitsCost').value, 0);
            const toolsCost = safeNumber(document.getElementById('toolsCost').value, 0);
            const contingencyRate = safeNumber(document.getElementById('contingencyRate').value, 10) / 100;
            const taxRate = safeNumber(document.getElementById('taxRate').value, 12) / 100;
            
            // Calculate costs for each work item using safeNumber
            const workItems = [
                {
                    name: 'Main Distribution Boards (MDBs)',
                    quantity: safeNumber(document.getElementById('mdbQty').value, 0),
                    unit: 'pcs',
                    unitCost: safeNumber(document.getElementById('mdbUnitCost').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('mdbLaborHours').value, 0),
                    laborHours: safeNumber(document.getElementById('mdbQty').value, 0) * safeNumber(document.getElementById('mdbLaborHours').value, 0)
                },
                {
                    name: 'Sub-Main Distribution Boards (SMDBs)',
                    quantity: safeNumber(document.getElementById('smdbQty').value, 0),
                    unit: 'pcs',
                    unitCost: safeNumber(document.getElementById('smdbUnitCost').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('smdbLaborHours').value, 0),
                    laborHours: safeNumber(document.getElementById('smdbQty').value, 0) * safeNumber(document.getElementById('smdbLaborHours').value, 0)
                },
                {
                    name: 'Distribution Panels',
                    quantity: safeNumber(document.getElementById('panelQty').value, 0),
                    unit: 'pcs',
                    unitCost: safeNumber(document.getElementById('panelUnitCost').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('panelLaborHours').value, 0),
                    laborHours: safeNumber(document.getElementById('panelQty').value, 0) * safeNumber(document.getElementById('panelLaborHours').value, 0)
                },
                {
                    name: 'Circuit Breakers',
                    quantity: safeNumber(document.getElementById('breakerQty').value, 0),
                    unit: 'pcs',
                    unitCost: safeNumber(document.getElementById('breakerUnitCost').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('breakerLaborHours').value, 0),
                    laborHours: safeNumber(document.getElementById('breakerQty').value, 0) * safeNumber(document.getElementById('breakerLaborHours').value, 0)
                },
                {
                    name: 'Power Cables',
                    quantity: safeNumber(document.getElementById('cableLength').value, 0),
                    unit: currentUnitSystem === 'metric' ? 'meters' : 'feet',
                    unitCost: safeNumber(document.getElementById('cableCostPerUnit').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('cableLaborHours').value, 0) / 100,
                    laborHours: (safeNumber(document.getElementById('cableLength').value, 0) * safeNumber(document.getElementById('cableLaborHours').value, 0)) / 100
                },
                {
                    name: 'Cable Trays',
                    quantity: safeNumber(document.getElementById('trayLength').value, 0),
                    unit: currentUnitSystem === 'metric' ? 'meters' : 'feet',
                    unitCost: safeNumber(document.getElementById('trayCostPerUnit').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('trayLaborHours').value, 0) / 100,
                    laborHours: (safeNumber(document.getElementById('trayLength').value, 0) * safeNumber(document.getElementById('trayLaborHours').value, 0)) / 100
                },
                {
                    name: 'Conduits',
                    quantity: safeNumber(document.getElementById('conduitLength').value, 0),
                    unit: currentUnitSystem === 'metric' ? 'meters' : 'feet',
                    unitCost: safeNumber(document.getElementById('conduitCostPerUnit').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('conduitLaborHours').value, 0) / 100,
                    laborHours: (safeNumber(document.getElementById('conduitLength').value, 0) * safeNumber(document.getElementById('conduitLaborHours').value, 0)) / 100
                },
                {
                    name: 'Bus Ducts',
                    quantity: safeNumber(document.getElementById('busductLength').value, 0),
                    unit: currentUnitSystem === 'metric' ? 'meters' : 'feet',
                    unitCost: safeNumber(document.getElementById('busductCostPerUnit').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('busductLaborHours').value, 0) / 10,
                    laborHours: (safeNumber(document.getElementById('busductLength').value, 0) * safeNumber(document.getElementById('busductLaborHours').value, 0)) / 10
                },
                {
                    name: 'Outlets',
                    quantity: safeNumber(document.getElementById('outletQty').value, 0),
                    unit: 'pcs',
                    unitCost: safeNumber(document.getElementById('outletUnitCost').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('outletLaborHours').value, 0),
                    laborHours: safeNumber(document.getElementById('outletQty').value, 0) * safeNumber(document.getElementById('outletLaborHours').value, 0)
                },
                {
                    name: 'Switches',
                    quantity: safeNumber(document.getElementById('switchQty').value, 0),
                    unit: 'pcs',
                    unitCost: safeNumber(document.getElementById('switchUnitCost').value, 0),
                    laborHoursPerUnit: safeNumber(document.getElementById('switchLaborHours').value, 0),
                    laborHours: safeNumber(document.getElementById('switchQty').value, 0) * safeNumber(document.getElementById('switchLaborHours').value, 0)
                },
                {
                    name: 'Equipment Rental/Mobilization',
                    quantity: 1,
                    unit: 'lot',
                    unitCost: equipmentCost,
                    laborHoursPerUnit: 0,
                    laborHours: 0
                },
                {
                    name: 'Tools & Consumables',
                    quantity: 1,
                    unit: 'lot',
                    unitCost: toolsCost,
                    laborHoursPerUnit: 0,
                    laborHours: 0
                }
            ];

            // Calculate totals
            let totalMaterialCost = 0;
            let totalLaborHours = 0;
            let totalLaborCost = 0;

            workItems.forEach(item => {
                item.materialCost = item.quantity * item.unitCost;
                item.laborCost = item.laborHours * laborRate;
                item.totalCost = item.materialCost + item.laborCost;

                totalMaterialCost += item.materialCost;
                totalLaborHours += item.laborHours;
                totalLaborCost += item.laborCost;
            });

            // Calculate Direct Costs (Materials + Labor + Equipment + Tools)
            const totalDirectCost = totalMaterialCost + totalLaborCost;

            // Calculate Indirect Costs (Overhead + Contingency)
            const overheadCost = totalDirectCost * overheadRate;
            const contingencyCost = totalDirectCost * contingencyRate;
            const totalIndirectCost = overheadCost + contingencyCost + permitsCost; // Include permits as indirect

            // Calculate Profit
            const costBeforeProfit = totalDirectCost + totalIndirectCost;
            const profit = costBeforeProfit * profitMarginRate;

            // Calculate Tax (VAT)
            const totalBeforeTax = costBeforeProfit + profit;
            const tax = totalBeforeTax * taxRate;

            // Final Price
            const finalPrice = totalBeforeTax + tax;

            // Store results for export
            projectData = {
                projectName: document.getElementById('projectName').value || 'Unnamed Project',
                clientName: document.getElementById('clientName').value,
                projectLocation: document.getElementById('projectLocation').value,
                preparedBy: document.getElementById('preparedBy').value,
                projectDate: document.getElementById('projectDate').value,
                timestamp: new Date().toISOString(),
                unitSystem: currentUnitSystem,
                standard: currentStandard,
                currency: currency,
                parameters: {
                    laborRate,
                    overheadRate: overheadRate * 100,
                    profitMarginRate: profitMarginRate * 100,
                    equipmentCost,
                    permitsCost,
                    toolsCost,
                    contingencyRate: contingencyRate * 100,
                    taxRate: taxRate * 100
                },
                workItems,
                totals: {
                    totalMaterialCost,
                    totalLaborHours,
                    totalLaborCost,
                    totalDirectCost,
                    overheadCost,
                    contingencyCost,
                    totalIndirectCost,
                    costBeforeProfit,
                    profit,
                    totalBeforeTax,
                    tax,
                    finalPrice
                }
            };
            
            // Display results
            displayResults(workItems, totalDirectCost, overheadCost, contingencyCost, totalIndirectCost, profit, tax, finalPrice, totalLaborHours, currency);
        }

        function displayResults(workItems, totalDirectCost, overheadCost, contingencyCost, totalIndirectCost, profit, tax, finalPrice, totalLaborHours, currency) {
            // Update project info
            document.getElementById('resultProjectName').textContent = document.getElementById('projectName').value || 'Unnamed Project';
            document.getElementById('resultClientName').textContent = document.getElementById('clientName').value || 'Not specified';
            document.getElementById('resultProjectLocation').textContent = document.getElementById('projectLocation').value || 'Not specified';
            document.getElementById('resultPreparedBy').textContent = document.getElementById('preparedBy').value || 'Not specified';
            document.getElementById('resultProjectDate').textContent = document.getElementById('projectDate').value || 'Not specified';
            document.getElementById('resultStandard').textContent = currentStandard === 'philippine' ? 'Philippine Electrical Code (PEC)' : 'International Electrotechnical Commission (IEC)';

            // Update Bill of Quantity table
            const billOfQuantityTableBody = document.getElementById('billOfQuantityTableBody');
            billOfQuantityTableBody.innerHTML = "";
            let itemNo = 1;

            // Add direct cost items
            workItems.forEach(item => {
                if (item.quantity > 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-center">${itemNo++}</td>
                        <td>${item.name}</td>
                        <td class="text-center">${formatNumber(item.quantity)}</td>
                        <td class="text-center">${item.unit}</td>
                        <td class="text-right">${formatCurrency(item.materialCost)}</td>
                        <td class="text-right">${formatNumber(item.laborHours, 1)}</td>
                        <td class="text-right">${formatCurrency(item.laborCost)}</td>
                        <td class="text-right">${formatCurrency(item.totalCost)}</td>
                    `;
                    billOfQuantityTableBody.appendChild(row);
                }
            });
            
            // Add Total Direct Cost row
            const totalDirectRow = document.createElement('tr');
            totalDirectRow.className = 'total-row';
            totalDirectRow.innerHTML = `
                <td class="text-center"></td>
                <td><strong>TOTAL DIRECT COSTS</strong></td>
                <td class="text-center"></td>
                <td class="text-center"></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalMaterialCost)}</strong></td>
                <td class="text-right"><strong>${formatNumber(totalLaborHours, 1)}</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalLaborCost)}</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalDirectCost)}</strong></td>
            `;
            billOfQuantityTableBody.appendChild(totalDirectRow);

            // Update Other Costs table (Permits & Fees) - now part of indirect, but keep for compatibility
            const otherCostsTableBody = document.getElementById('otherCostsTableBody');
            otherCostsTableBody.innerHTML = "";

            const permitsRow = document.createElement('tr');
            permitsRow.innerHTML = `
                <td class="text-center">${itemNo++}</td>
                <td>Permits & Fees</td>
                <td class="text-center">1</td>
                <td class="text-center">lot</td>
                <td class="text-right">${formatCurrency(projectData.parameters.permitsCost)}</td>
                <td class="text-right"></td>
                <td class="text-right"></td>
                <td class="text-right">${formatCurrency(projectData.parameters.permitsCost)}</td>
            `;
            otherCostsTableBody.appendChild(permitsRow);

            // Update Indirect Costs & Markup table
            const indirectCostsTableBody = document.getElementById('indirectCostsTableBody');
            indirectCostsTableBody.innerHTML = "";

            // Overhead
            const overheadRow = document.createElement('tr');
            overheadRow.innerHTML = `
                <td class="text-center">${itemNo++}</td>
                <td>Overhead (${projectData.parameters.overheadRate}%)</td>
                <td class="text-center">1</td>
                <td class="text-center">lot</td>
                <td class="text-right">${formatCurrency(overheadCost)}</td>
                <td class="text-right"></td>
                <td class="text-right"></td>
                <td class="text-right">${formatCurrency(overheadCost)}</td>
            `;
            indirectCostsTableBody.appendChild(overheadRow);

            // Contingency
            const contingencyRow = document.createElement('tr');
            contingencyRow.innerHTML = `
                <td class="text-center">${itemNo++}</td>
                <td>Contingency (${projectData.parameters.contingencyRate}%)</td>
                <td class="text-center">1</td>
                <td class="text-center">lot</td>
                <td class="text-right">${formatCurrency(contingencyCost)}</td>
                <td class="text-right">-</td>
                <td class="text-right">-</td>
                <td class="text-right">${formatCurrency(contingencyCost)}</td>
            `;
            indirectCostsTableBody.appendChild(contingencyRow);

            // Profit Margin
            const profitRow = document.createElement('tr');
            profitRow.innerHTML = `
                <td class="text-center">${itemNo++}</td>
                <td>Profit Margin (${projectData.parameters.profitMarginRate}%)</td>
                <td class="text-center">1</td>
                <td class="text-center">lot</td>
                <td class="text-right">${formatCurrency(profit)}</td>
                <td class="text-right">-</td>
                <td class="text-right">-</td>
                <td class="text-right">${formatCurrency(profit)}</td>
            `;
            indirectCostsTableBody.appendChild(profitRow);

            // VAT
            const vatRow = document.createElement('tr');
            vatRow.innerHTML = `
                <td class="text-center">${itemNo++}</td>
                <td>Tax (VAT) (${projectData.parameters.taxRate}%)</td>
                <td class="text-center">1</td>
                <td class="text-center">lot</td>
                <td class="text-right">${formatCurrency(tax)}</td>
                <td class="text-right">-</td>
                <td class="text-right">-</td>
                <td class="text-right">${formatCurrency(tax)}</td>
            `;
            indirectCostsTableBody.appendChild(vatRow);

            // Add Total Indirect & Markup Cost row
            const totalAdditional = totalIndirectCost + profit + tax - permitsCost;
            const totalAdditionalRow = document.createElement('tr');
            totalAdditionalRow.className = 'total-row';
            totalAdditionalRow.innerHTML = `
                <td class="text-center">-</td>
                <td><strong>TOTAL INDIRECT COSTS & MARKUP</strong></td>
                <td class="text-center">-</td>
                <td class="text-center">-</td>
                <td class="text-right"><strong>${formatCurrency(totalIndirectCost + profit + tax)}</strong></td>
                <td class="text-right"><strong>-</strong></td>
                <td class="text-right"><strong>-</strong></td>
                <td class="text-right"><strong>${formatCurrency(totalIndirectCost + profit + tax)}</strong></td>
            `;
            indirectCostsTableBody.appendChild(totalAdditionalRow);

            // Update Summary table
            const summaryTableBody = document.getElementById('summaryTableBody');
            summaryTableBody.innerHTML = '';
            
            // Total Direct Cost
            const directRow = document.createElement('tr');
            directRow.innerHTML = `
                <td>Total Direct Costs</td>
                <td class="text-right">${formatCurrency(projectData.totals.totalMaterialCost)}</td>
                <td class="text-right">${formatNumber(totalLaborHours, 1)}</td>
                <td class="text-right">${formatCurrency(projectData.totals.totalLaborCost)}</td>
                <td class="text-right">${formatCurrency(projectData.totals.totalDirectCost)}</td>
            `;
            summaryTableBody.appendChild(directRow);
            
            // Total Indirect & Markup Cost
            const indirectRow = document.createElement('tr');
            indirectRow.innerHTML = `
                <td>Total Indirect Costs & Markup</td>
                <td class="text-right">${formatCurrency(totalIndirectCost + profit + tax)}</td>
                <td class="text-right"></td>
                <td class="text-right"></td>
                <td class="text-right">${formatCurrency(totalIndirectCost + profit + tax)}</td>
            `;
            summaryTableBody.appendChild(indirectRow);
            
            // Final Price
            const finalRow = document.createElement('tr');
            finalRow.className = 'total-row';
            finalRow.innerHTML = `
                <td><strong>GRAND TOTAL</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalMaterialCost + totalIndirectCost + profit + tax)}</strong></td>
                <td class="text-right"><strong>${formatNumber(totalLaborHours, 1)}</strong></td>
                <td class="text-right"><strong>${formatCurrency(projectData.totals.totalLaborCost)}</strong></td>
                <td class="text-right"><strong>${formatCurrency(finalPrice)}</strong></td>
            `;
            summaryTableBody.appendChild(finalRow);

            // Add Crew Sizing Summary
            addCrewSizingSummary(totalLaborHours, currency);

            // Show results
            resultsPlaceholder.classList.add('hidden');
            resultsContent.classList.remove('hidden');
        }

        function addCrewSizingSummary(totalLaborHours, currency) {
            const laborRate = safeNumber(document.getElementById('laborRate').value, 250);

            // Calculate labor metrics
            const HOURS_PER_DAY = 8;
            const DAYS_PER_WEEK = 5;
            const totalLaborDays = totalLaborHours / HOURS_PER_DAY;
            const totalWeeks = totalLaborDays / DAYS_PER_WEEK;

            // Crew size suggestions
            const smallCrew = 2;
            const mediumCrew = 4;
            const largeCrew = 6;

            const smallCrewDays = totalLaborDays / smallCrew;
            const mediumCrewDays = totalLaborDays / mediumCrew;
            const largeCrewDays = totalLaborDays / largeCrew;

            const smallCrewWeeks = smallCrewDays / DAYS_PER_WEEK;
            const mediumCrewWeeks = mediumCrewDays / DAYS_PER_WEEK;
            const largeCrewWeeks = largeCrewDays / DAYS_PER_WEEK;

            // Create crew sizing section
            crewSizingSection.innerHTML = `
                <h4 style="margin-bottom: 15px;">Labor & Crew Planning</h4>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;"> 
                    <div class="cost-card"> 
                        <div>Total Labor Hours</div>
                        <div class="cost-value">${formatNumber(totalLaborHours, 1)}</div>
                        <div>hours</div>
                    </div>
                    <div class="cost-card"> 
                        <div>Total Labor Cost</div>
                        <div class="cost-value">${formatCurrency(totalLaborHours * laborRate)}</div>
                        <div>${currency}</div>
                    </div>
                    <div class="cost-card"> 
                        <div>Equivalent Work Days</div>
                        <div class="cost-value">${formatNumber(totalLaborDays, 1)}</div>
                        <div>days (8h/day)</div>
                    </div>
                </div>

                <h5 style="margin-bottom: 10px;">Recommended Crew Sizes & Timelines:</h5>
                <div class="crew-options">
                    <div class="crew-option">
                        <div style="font-weight: bold; color: var(--success);">Small Crew</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin: 8px 0;">${smallCrew} workers</div>
                        <div>${formatNumber(smallCrewDays, 1)} days</div>
                        <div>${formatNumber(smallCrewWeeks, 1)} weeks</div>
                    </div>
                    <div class="crew-option">
                        <div style="font-weight: bold; color: var(--warning);">Medium Crew</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin: 8px 0;">${mediumCrew} workers</div>
                        <div>${formatNumber(mediumCrewDays, 1)} days</div>
                        <div>${formatNumber(mediumCrewWeeks, 1)} weeks</div>
                    </div>
                    <div class="crew-option">
                        <div style="font-weight: bold; color: var(--danger);">Large Crew</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin: 8px 0;">${largeCrew} workers</div>
                        <div>${formatNumber(largeCrewDays, 1)} days</div>
                        <div>${formatNumber(largeCrewWeeks, 1)} weeks</div>
                    </div>
                </div>

                <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                    <strong>Note:</strong> Based on ${HOURS_PER_DAY} hours per day, ${DAYS_PER_WEEK} days per week.
                    Adjust based on project constraints and safety requirements.
                </div>
            `;

            crewSizingSection.classList.remove("hidden");
        }

        function resetCalculator() {
            if (confirm('Are you sure you want to reset all inputs? This cannot be undone.')) {
                document.querySelectorAll('input').forEach(input => {
                    if (input.type === 'number') {
                        input.value = input.getAttribute('value') || '0';
                    } else if (input.type === 'text') {
                        input.value = "";
                    } else if (input.type === 'date') {
                        input.valueAsDate = new Date();
                    }
                });

                document.querySelectorAll('select').forEach(select => {
                    select.selectedIndex = 0;
                });

                // Reset toggles
                unitButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.unit-btn[data-unit="metric"]').classList.add('active');
                currentUnitSystem = 'metric';

                standardButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.standard-btn[data-standard="philippine"]').classList.add('active');
                currentStandard = 'philippine';

                updateUnitLabels();
                updateStandards();

                resultsPlaceholder.classList.remove('hidden');
                resultsContent.classList.add('hidden');
                crewSizingSection.classList.add('hidden');
                validationError.style.display = 'none';
            }
        }

// Currency functions for PDF
function getSelectedCurrency() {
    const c = document.getElementById('currency')?.value || 'PHP';
    return c;
}

function getCurrencySymbol(c) {
    switch (c) {
        case 'PHP': return '₱';
        case 'USD': return '$';
        case 'EUR': return '€';
        case 'JPY': return '¥';
        default:    return c + ' ';
    }
}

function formatCurrencyForPDF(n) {
    if (typeof n !== 'number' || isNaN(n)) return '0.00';
    const c = getSelectedCurrency();
    const symbol = getCurrencySymbol(c);

    // Ensure consistent number formatting
    const formatted = n.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });

    return `${symbol}${formatted}`;
}

function exportToPdf() {
    const { jsPDF } = window.jspdf;
    
    if (!projectData.totals) {
        alert('No results to export. Please calculate an estimate first.');
        return;
    }

    try {
        const doc = new jsPDF({ 
            orientation: 'portrait', 
            unit: 'pt', 
            format: 'a4'
        });

        // Set font to support Unicode characters
        doc.setFont('helvetica', 'normal');

        // Page dimensions and margins
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = { left: 40, right: 40, top: 80, bottom: 60 };
        
        // Track current Y position
        let currentY = margin.top;

        // Header function
        function drawPageHeader() {
            const headerY = 30;
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('POWER DISTRIBUTION SYSTEMS ESTIMATE', pageWidth / 2, headerY, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            const clientName = document.getElementById('clientName').value || 'Not specified';
            const preparedBy = document.getElementById('preparedBy').value || 'Not specified';
            const dateStr = document.getElementById('projectDate').value || '';
            
            doc.text(`Project: ${projectName}`, margin.left, headerY + 20);
            doc.text(`Client: ${clientName}`, margin.left, headerY + 35);
            doc.text(`Prepared By: ${preparedBy}`, pageWidth - margin.right, headerY + 20, { align: 'right' });
            doc.text(`Date: ${dateStr}`, pageWidth - margin.right, headerY + 35, { align: 'right' });
            
            doc.setLineWidth(0.5);
            doc.line(margin.left, headerY + 45, pageWidth - margin.right, headerY + 45);
        }

        // Footer function
        function drawPageFooter(pageNumber, totalPages) {
            const footerY = pageHeight - 30;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Page ${pageNumber} of ${totalPages}`, pageWidth / 2, footerY, { align: 'center' });
            doc.text(`Generated on ${new Date().toLocaleDateString()}`, margin.left, footerY);
            doc.text(`Standard: ${currentStandard === 'philippine' ? 'PEC' : 'IEC'}`, pageWidth - margin.right, footerY, { align: 'right' });
        }

        // Section title function
        function writeSectionTitle(text) {
            if (currentY > pageHeight - 150) {
                doc.addPage();
                currentY = margin.top;
                drawPageHeader();
            }
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(text, margin.left, currentY);
            currentY += 20;
            return currentY;
        }

        // Format number for PDF
        function formatNumberForPDF(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return "0";
            return num.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // Draw header on first page
        drawPageHeader();
        currentY = margin.top + 60;

        // Define column widths (total ~510pt to fit A4 page width of 595pt - 80pt margins)
        const columnWidths = {
            itemNo: 40,
            scope: 130,
            quantity: 50,
            unit: 40,
            materialCost: 80,
            laborHours: 60,
            laborCost: 80,
            totalCost: 80
        };

        // Table 1: Direct Costs
        writeSectionTitle('BILL OF QUANTITIES - DIRECT COSTS');

        const directHead = [['Item No.', 'Scope of Work', 'Quantity', 'Unit', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']];
        const directBody = [];
        
        let itemNo = 1;
        projectData.workItems.forEach(item => {
            if (item.quantity > 0) {
                directBody.push([
                    itemNo.toString(),
                    item.name,
                    formatNumberForPDF(item.quantity, item.unit === 'pcs' ? 0 : 2),
                    item.unit,
                    formatCurrencyForPDF(item.materialCost),
                    formatNumberForPDF(item.laborHours, 1),
                    formatCurrencyForPDF(item.laborCost),
                    formatCurrencyForPDF(item.totalCost)
                ]);
                itemNo++;
            }
        });

        directBody.push([
            '',
            'TOTAL DIRECT COSTS',
            '',
            '',
            formatCurrencyForPDF(projectData.totals.totalMaterialCost),
            formatNumberForPDF(projectData.totals.totalLaborHours, 1),
            formatCurrencyForPDF(projectData.totals.totalLaborCost),
            formatCurrencyForPDF(projectData.totals.totalDirectCost)
        ]);

        doc.autoTable({
            head: directHead,
            body: directBody,
            startY: currentY,
            margin: { left: margin.left, right: margin.right },
            styles: {
                font: 'helvetica',
                fontSize: 8,
                cellPadding: 4,
                overflow: 'linebreak',
                minCellHeight: 12,
                lineWidth: 0.25,
                lineColor: 100
            },
            headStyles: {
                fillColor: [44, 62, 80],
                textColor: 255,
                fontStyle: 'bold',
                fontSize: 8,
                halign: 'left' // Left-align header for consistency
            },
            bodyStyles: {
                fontSize: 8,
                halign: 'left' // Left-align all body cells
            },
            columnStyles: {
                0: { cellWidth: columnWidths.itemNo },
                1: { cellWidth: columnWidths.scope, overflow: 'linebreak' },
                2: { cellWidth: columnWidths.quantity },
                3: { cellWidth: columnWidths.unit },
                4: { cellWidth: columnWidths.materialCost },
                5: { cellWidth: columnWidths.laborHours },
                6: { cellWidth: columnWidths.laborCost },
                7: { cellWidth: columnWidths.totalCost }
            }
        });

        currentY = doc.lastAutoTable.finalY + 20;

        // Table 2: Indirect Costs
        writeSectionTitle('INDIRECT COSTS & MARKUP');

        const indirectBody = [];
        itemNo = 1;

        if (projectData.parameters.permitsCost > 0) {
            indirectBody.push([
                itemNo.toString(),
                'Permits & Fees',
                '1',
                'lot',
                formatCurrencyForPDF(projectData.parameters.permitsCost),
                '',
                '',
                formatCurrencyForPDF(projectData.parameters.permitsCost)
            ]);
            itemNo++;
        }

        indirectBody.push([
            itemNo.toString(),
            `Overhead (${projectData.parameters.overheadRate}%)`,
            '1',
            'lot',
            formatCurrencyForPDF(projectData.totals.overheadCost),
            '',
            '',
            formatCurrencyForPDF(projectData.totals.overheadCost)
        ]);
        itemNo++;

        indirectBody.push([
            itemNo.toString(),
            `Contingency (${projectData.parameters.contingencyRate}%)`,
            '1',
            'lot',
            formatCurrencyForPDF(projectData.totals.contingencyCost),
            '',
            '',
            formatCurrencyForPDF(projectData.totals.contingencyCost)
        ]);
        itemNo++;

        indirectBody.push([
            itemNo.toString(),
            `Profit Margin (${projectData.parameters.profitMarginRate}%)`,
            '1',
            'lot',
            formatCurrencyForPDF(projectData.totals.profit),
            '',
            '',
            formatCurrencyForPDF(projectData.totals.profit)
        ]);
        itemNo++;

        indirectBody.push([
            itemNo.toString(),
            `Tax (VAT) (${projectData.parameters.taxRate}%)`,
            '1',
            'lot',
            formatCurrencyForPDF(projectData.totals.tax),
            '',
            '',
            formatCurrencyForPDF(projectData.totals.tax)
        ]);

        const totalIndirect = projectData.totals.totalIndirectCost + projectData.totals.profit + projectData.totals.tax;
        indirectBody.push([
            '',
            'TOTAL INDIRECT COSTS & MARKUP',
            '',
            '',
            formatCurrencyForPDF(totalIndirect),
            '',
            '',
            formatCurrencyForPDF(totalIndirect)
        ]);

        doc.autoTable({
            head: directHead,
            body: indirectBody,
            startY: currentY,
            margin: { left: margin.left, right: margin.right },
            styles: {
                font: 'helvetica',
                fontSize: 8,
                cellPadding: 4,
                overflow: 'linebreak',
                minCellHeight: 12,
                lineWidth: 0.25,
                lineColor: 100
            },
            headStyles: {
                fillColor: [44, 62, 80],
                textColor: 255,
                fontStyle: 'bold',
                fontSize: 8,
                halign: 'left'
            },
            bodyStyles: {
                fontSize: 8,
                halign: 'left'
            },
            columnStyles: {
                0: { cellWidth: columnWidths.itemNo },
                1: { cellWidth: columnWidths.scope, overflow: 'linebreak' },
                2: { cellWidth: columnWidths.quantity },
                3: { cellWidth: columnWidths.unit },
                4: { cellWidth: columnWidths.materialCost },
                5: { cellWidth: columnWidths.laborHours },
                6: { cellWidth: columnWidths.laborCost },
                7: { cellWidth: columnWidths.totalCost }
            }
        });

        currentY = doc.lastAutoTable.finalY + 20;

        // Table 3: Summary
        writeSectionTitle('SUMMARY');

        const summaryHead = [['Category', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']];
        const summaryBody = [
            [
                'TOTAL DIRECT COSTS',
                formatCurrencyForPDF(projectData.totals.totalMaterialCost),
                formatNumberForPDF(projectData.totals.totalLaborHours, 1),
                formatCurrencyForPDF(projectData.totals.totalLaborCost),
                formatCurrencyForPDF(projectData.totals.totalDirectCost)
            ],
            [
                'TOTAL INDIRECT COSTS & MARKUP',
                formatCurrencyForPDF(totalIndirect),
                '',
                '',
                formatCurrencyForPDF(totalIndirect)
            ],
            [
                'GRAND TOTAL',
                formatCurrencyForPDF(projectData.totals.totalMaterialCost + totalIndirect),
                formatNumberForPDF(projectData.totals.totalLaborHours, 1),
                formatCurrencyForPDF(projectData.totals.totalLaborCost),
                formatCurrencyForPDF(projectData.totals.finalPrice)
            ]
        ];

        doc.autoTable({
            head: summaryHead,
            body: summaryBody,
            startY: currentY,
            margin: { left: margin.left, right: margin.right },
            styles: {
                font: 'helvetica',
                fontSize: 8,
                cellPadding: 4,
                overflow: 'linebreak',
                minCellHeight: 12,
                lineWidth: 0.25,
                lineColor: 100
            },
            headStyles: {
                fillColor: [44, 62, 80],
                textColor: 255,
                fontStyle: 'bold',
                fontSize: 8,
                halign: 'left'
            },
            bodyStyles: {
                fontSize: 8,
                halign: 'left'
            },
            columnStyles: {
                0: { cellWidth: columnWidths.scope + columnWidths.itemNo, overflow: 'linebreak' },
                1: { cellWidth: columnWidths.materialCost },
                2: { cellWidth: columnWidths.laborHours },
                3: { cellWidth: columnWidths.laborCost },
                4: { cellWidth: columnWidths.totalCost, fontStyle: 'bold' }
            }
        });

        // Add footers to all pages
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            drawPageFooter(i, totalPages);
        }

        // Save the PDF
        const fileName = (projectData.projectName || 'estimate').replace(/[^a-z0-9]/gi, '_') + '_power_distribution_estimate.pdf';
        doc.save(fileName);

    } catch (err) {
        console.error('PDF Generation Error:', err);
        alert('Error generating PDF: ' + err.message);
    }
}
        function exportToExcel() {
            if (!projectData.totals) {
                alert('No results to export. Please calculate an estimate first.');
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Main Data Sheet (Matches the Excel template structure)
                const mainData = [
                    // Project Information
                    ['Project:', projectData.projectName || ''],
                    ['Client:', projectData.clientName || ''],
                    ['Location:', projectData.projectLocation || ''],
                    ['Prepared By:', projectData.preparedBy || ''],
                    ['Date:', projectData.projectDate || ''],
                    [], // Empty row
                    
                    // Direct Costs Header
                    ['Item No.', 'Scope of Work', 'Quantity', 'Unit', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost'],
                ];

                let itemNo = 1;

                // Direct Costs Items
                projectData.workItems.forEach(item => {
                    if (item.quantity > 0) {
                        mainData.push([
                            itemNo++,
                            item.name,
                            item.quantity,
                            item.unit,
                            item.materialCost,
                            item.laborHours,
                            item.laborCost,
                            item.totalCost
                        ]);
                    }
                });

                // Total Direct Costs
                mainData.push([
                    "",
                    "TOTAL DIRECT COSTS",
                    "",
                    "",
                    projectData.totals.totalMaterialCost,
                    projectData.totals.totalLaborHours,
                    projectData.totals.totalLaborCost,
                    projectData.totals.totalDirectCost
                ]);

                mainData.push([]); // Empty row

                // Indirect Costs Header
                mainData.push(['Item No.', 'Scope of Work', 'Quantity', 'Unit', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']);

                // Indirect Costs Items
                // Permits & Fees
                mainData.push([
                    itemNo++,
                    'Permits & Fees',
                    1,
                    'lot',
                    projectData.parameters.permitsCost,
                    "",
                    "",
                    projectData.parameters.permitsCost
                ]);

                // Overhead
                mainData.push([
                    itemNo++,
                    `Overhead (${projectData.parameters.overheadRate}%)`,
                    1,
                    'lot',
                    projectData.totals.overheadCost,
                    "",
                    "",
                    projectData.totals.overheadCost
                ]);

                // Contingency
                mainData.push([
                    itemNo++,
                    `Contingency (${projectData.parameters.contingencyRate}%)`,
                    1,
                    'lot',
                    projectData.totals.contingencyCost,
                    "",
                    "",
                    projectData.totals.contingencyCost
                ]);

                // Profit Margin
                mainData.push([
                    itemNo++,
                    `Profit Margin (${projectData.parameters.profitMarginRate}%)`,
                    1,
                    'lot',
                    projectData.totals.profit,
                    "",
                    "",
                    projectData.totals.profit
                ]);

                // VAT Tax
                mainData.push([
                    itemNo++,
                    `Tax (VAT) (${projectData.parameters.taxRate}%)`,
                    1,
                    'lot',
                    projectData.totals.tax,
                    "",
                    "",
                    projectData.totals.tax
                ]);

                // Total Indirect Costs & Markup
                const totalIndirectMarkup = projectData.totals.totalIndirectCost + projectData.totals.profit + projectData.totals.tax;
                mainData.push([
                    "",
                    "TOTAL INDIRECT COSTS & MARKUP",
                    "",
                    "",
                    totalIndirectMarkup,
                    "",
                    "",
                    totalIndirectMarkup
                ]);

                mainData.push([]); // Empty row

                // Summary Section
                mainData.push(['Category', '', '', '', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']);
                
                mainData.push([
                    'TOTAL DIRECT COSTS',
                    '', '', '',
                    projectData.totals.totalMaterialCost,
                    projectData.totals.totalLaborHours,
                    projectData.totals.totalLaborCost,
                    projectData.totals.totalDirectCost
                ]);

                mainData.push([
                    'TOTAL INDIRECT COSTS & MARKUP',
                    '', '', '',
                    totalIndirectMarkup,
                    "", "",
                    totalIndirectMarkup
                ]);

                mainData.push([
                    'GRAND TOTAL',
                    '', '', '',
                    projectData.totals.totalMaterialCost + totalIndirectMarkup,
                    projectData.totals.totalLaborHours,
                    projectData.totals.totalLaborCost,
                    projectData.totals.finalPrice
                ]);

                mainData.push([]); // Empty row

                // Labor & Crew Planning Section
                mainData.push(['LABOR & CREW PLANNING']);
                mainData.push(['Total Labor Hours:', projectData.totals.totalLaborHours]);
                mainData.push(['Total Labor Cost:', projectData.totals.totalLaborCost]);
                mainData.push(['Equivalent Work Days:', projectData.totals.totalLaborHours / 8]);
                mainData.push([]);
                
                mainData.push(['Crew Size', 'Workers', 'Days Required', 'Weeks Required', 'Total Hours', 'Daily Hours', 'Notes']);
                
                mainData.push([
                    'Small crew',
                    2,
                    projectData.totals.totalLaborHours / 16,
                    projectData.totals.totalLaborHours / 80,
                    projectData.totals.totalLaborHours,
                    '8 hours/day',
                    'Basic installation crew'
                ]);

                mainData.push([
                    'Medium crew',
                    4,
                    projectData.totals.totalLaborHours / 32,
                    projectData.totals.totalLaborHours / 160,
                    projectData.totals.totalLaborHours,
                    '8 hours/day',
                    'Standard project crew'
                ]);

                mainData.push([
                    'Large crew',
                    6,
                    projectData.totals.totalLaborHours / 48,
                    projectData.totals.totalLaborHours / 240,
                    projectData.totals.totalLaborHours,
                    '8 hours/day',
                    'Accelerated timeline'
                ]);

                const wsMain = XLSX.utils.aoa_to_sheet(mainData);

                // Apply formatting
                const currencyCols = [4, 6, 7]; // Material Cost, Labor Cost, Total Cost columns (0-indexed)
                const numberCols = [2, 5]; // Quantity, Labor Hours columns (0-indexed)

                for (let r = 0; r < mainData.length; r++) {
                    // Currency formatting
                    currencyCols.forEach(col => {
                        const cellRef = XLSX.utils.encode_cell({r: r, c: col});
                        if (wsMain[cellRef] && typeof wsMain[cellRef].v === 'number') {
                            wsMain[cellRef].z = '#,##0.00';
                        }
                    });

                    // Number formatting
                    numberCols.forEach(col => {
                        const cellRef = XLSX.utils.encode_cell({r: r, c: col});
                        if (wsMain[cellRef] && typeof wsMain[cellRef].v === 'number') {
                            wsMain[cellRef].z = col === 5 ? '0.0' : '0';
                        }
                    });
                }

                XLSX.utils.book_append_sheet(wb, wsMain, 'Power Distribution Estimate');

                // Save Excel file
                const safeName = (projectData.projectName || 'project').replace(/[^a-z0-9]/gi, '_');
                XLSX.writeFile(wb, `${safeName}_power_distribution_estimate.xlsx`);

            } catch (err) {
                console.error(err);
                alert('Error generating Excel file: ' + err.message);
            }
        }
    </script>
</body>
</html>
