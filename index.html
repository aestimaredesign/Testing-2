<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Electrical Boxes & Covers Estimator – NEC 2023 Compliant with Multi-Wire Box Fill Calculations">
    <meta name="author" content="AestimareDesign">
    <title>Professional Electrical Boxes & Covers Estimator | Multi-Wire NEC 2023 Compliant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    :root {
    --primary: #2c3e50;
    --secondary: #3498db;
    --success: #27ae60;
    --warning: #e67e22;
    --danger: #e0392b;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --text-dark: #2c3e50;
    --text-medium: #5d6d7e;
    --text-light: #7f8c8d;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: var(--text-dark);
    background-color: #f8f9fa;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}

header {
    background: var(--primary);
    color: white;
    padding: 1rem 0;
    margin-bottom: 2rem;
    border-radius: 8px;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
}

h1 {
    font-size: 2rem;
    font-weight: 600;
}

.controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--secondary);
    color: white;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.85rem;
}

.btn:hover, .btn:focus {
    opacity: 0.9;
    transform: translateY(-1px);
    outline: 2px solid var(--secondary);
    outline-offset: 2px;
}

.calculator-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 2rem;
}

@media (max-width: 1024px) {
    .calculator-grid {
    grid-template-columns: 1fr;
    }
}

.input-section, .output-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--light);
    color: var(--primary);
}

.input-group {
    margin-bottom: 1rem;
}

.input-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
    align-items: end;
}

.input-row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
    align-items: end;
}

.input-row-dynamic {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr auto;
    gap: 10px;
    margin-bottom: 10px;
    align-items: end;
}

.input-row-circuit {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto;
    gap: 8px;
    margin-bottom: 10px;
    align-items: end;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--text-dark);
}

input, select, textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

textarea {
    min-height: 80px;
    resize: vertical;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.work-item {
    background: var(--light);
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    border-left: 4px solid var(--secondary);
}

.work-item-title {
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.bill-of-quantity-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.bill-of-quantity-table th,
.bill-of-quantity-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.bill-of-quantity-table th {
    background: var(--primary);
    color: white;
    font-weight: 600;
}

.bill-of-quantity-table tr:hover {
    background-color: #f5f5f5;
}

.total-row {
    font-weight: 600;
    background-color: var(--light) !important;
}

.text-right {
    text-align: right;
}

.text-center {
    text-align: center;
}

.cost-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 1rem;
}

.cost-card {
    background: white;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-top: 4px solid var(--secondary);
}

.cost-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
    margin: 10px 0;
}

.validation-error {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: 5px;
    display: none;
}

.tab-container {
    margin-bottom: 1rem;
}

.tabs {
    display: flex;
    border-bottom: 1px solid #ddd;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
}

.tab.active {
    border-bottom-color: var(--secondary);
    color: var(--secondary);
    font-weight: 600;
}

.tab.focus {
    outline: 2px solid var(--secondary);
    outline-offset: -2px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.unit-label {
    font-size: 0.8rem;
    color: var(--text-medium);
    margin-top: 2px;
}

.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    width: 200px;
    background-color: var(--dark);
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -100px;
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

.crew-sizing {
    margin-top: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--success);
}

.crew-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.crew-option {
    background: white;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
}

.bill-of-quantity-table td:nth-child(3),
.bill-of-quantity-table td:nth-child(5),
.bill-of-quantity-table td:nth-child(6),
.bill-of-quantity-table td:nth-child(7),
.bill-of-quantity-table td:nth-child(8),
.bill-of-quantity-table th:nth-child(8) { text-align: right; }
.bill-of-quantity-table td:nth-child(1),
.bill-of-quantity-table td:nth-child(4) { text-align: center; }

.hidden {
    display: none;
}

.remove-btn {
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 5px 10px;
    font-size: 0.85rem;
}

.remove-btn:hover, .remove-btn:focus {
    opacity: 0.9;
    outline: 2px solid var(--danger);
    outline-offset: 2px;
}

.input-error {
    border-color: var(--danger) !important;
    box-shadow: 0 0 0 2px rgba(192, 57, 43, 0.2) !important;
}

.error-message {
    color: var(--danger);
    font-size: 0.75rem;
    margin-top: 3px;
    display: none;
}

/* NEC Box Fill Styles */
.nec-box-fill {
    background: #fff3e0;
    border-left: 4px solid #ff9800;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
}

.nec-result {
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    font-weight: 600;
}

.nec-pass {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    color: #2e7d32;
}

.nec-fail {
    background: #ffebee;
    border: 1px solid #f44336;
    color: #c62828;
}

.nec-warning {
    background: #fff3e0;
    border: 1px solid #ff9800;
    color: #ef6c00;
}

.conductor-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 0.9em;
}

.conductor-table th, .conductor-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

.conductor-table th {
    background: #f5f5f5;
}

/* Circuit specific styles */
.circuit-item {
    background: #f8f9fa;
    border-left: 4px solid #3498db;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 4px;
}

.circuit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.circuit-title {
    font-weight: 600;
    color: var(--primary);
}

.circuit-wire-size {
    background: var(--secondary);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.circuit-summary {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
}

.circuit-totals {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.circuit-total-item {
    text-align: center;
    padding: 8px;
    background: white;
    border-radius: 4px;
}

/* Help section backgrounds */
.help-section {
    margin-bottom: 25px;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.how-to-use {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-left: 4px solid #2196f3;
}

.calculation-formulas {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-left: 4px solid #4caf50;
}

.standard-sizes {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border-left: 4px solid #ff9800;
}

.step-guide p {
    margin-bottom: 10px;
    display: flex;
    align-items: flex-start;
}

.step-number {
    display: inline-block;
    background: var(--secondary);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    margin-right: 10px;
    flex-shrink: 0;
}

.formula-box, .reference-box {
    padding: 15px;
    background: rgba(255,255,255,0.7);
    border-radius: 6px;
    margin-top: 10px;
}

.formula-box h4, .reference-box h4 {
    margin-top: 15px;
    margin-bottom: 8px;
    color: var(--primary);
}

.formula-box p, .reference-box ul {
    margin-bottom: 8px;
    color: var(--text-dark);
}

.reference-box ul {
    padding-left: 20px;
}

/* NEC Details indentation */
.nec-details ul {
    padding-left: 20px;
    margin-bottom: 10px;
}

.nec-details li {
    margin-bottom: 5px;
}

/* Procurement styles */
.procurement-note {
    background: #e3f2fd;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    font-size: 0.9em;
}

/* Scope checklist */
.scope-checklist {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
}

.checklist-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 8px;
}

.checklist-item input {
    width: auto;
    margin-right: 10px;
    margin-top: 3px;
}

/* Test cases */
.test-cases {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border-left: 4px solid #9c27b0;
}

.test-case {
    background: rgba(255,255,255,0.7);
    padding: 15px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 4px solid #7b1fa2;
}

/* Accessibility improvements */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: var(--secondary);
    color: white;
    padding: 8px;
    z-index: 100;
    text-decoration: none;
    border-radius: 4px;
}

.skip-link:focus {
    top: 6px;
}

/* Focus indicators */
*:focus {
    outline: 2px solid var(--secondary);
    outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    :root {
    --primary: #000000;
    --secondary: #0000ff;
    --success: #008000;
    --warning: #ffa500;
    --danger: #ff0000;
    --text-dark: #000000;
    --text-medium: #000000;
    --text-light: #000000;
}

.unit-label {
    font-weight: bold;
}
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    }
    }
    </style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<div class="container">
    <header>
    <div class="header-content">
    <h1>Professional Electrical Boxes & Covers Estimator</h1>
    <div class="controls">
    <button class="btn btn-success" id="exportPdfBtn" aria-label="Export results as PDF document">Export PDF</button>
    <button class="btn btn-success" id="exportExcelBtn" aria-label="Export results as Excel spreadsheet">Export Excel</button>
    <button class="btn btn-danger" id="resetBtn" aria-label="Reset all inputs and calculations">Reset</button>
    </div>
    </div>
</header>

<main id="main-content">
    <div class="calculator-grid">
    <div class="input-section">
    <h2 class="section-title">Project Inputs</h2>

    <div class="input-group">
    <label for="projectName">Project Name</label>
    <input type="text" id="projectName" placeholder="Enter project name"
    value="Commercial Fit-Out Project" aria-required="true">
    <div class="error-message" id="projectNameError">Project name is required</div>
    </div>

    <div class="input-group">
    <label for="bidNumber">Bid/Proposal Number</label>
    <input type="text" id="bidNumber" placeholder="BID-2024-001" value="BID-2024-001">
    </div>

    <div class="input-group">
    <label for="clientName">Client Name</label>
    <input type="text" id="clientName" placeholder="Enter client name" value="ABC Development Corporation">
    </div>

    <div class="input-group">
    <label for="projectLocation">Project Location</label>
    <input type="text" id="projectLocation" placeholder="e.g., Manila, Philippines" value="Makati City, Philippines">
    </div>

    <div class="input-group">
    <label for="preparedBy">Prepared By</label>
    <input type="text" id="preparedBy" placeholder="Enter preparer name" value="John Smith, Licensed Electrical Engineer">
    </div>

    <div class="input-group">
    <label for="projectDate">Date</label>
    <input type="date" id="projectDate">
</div>

<div class="tab-container">
    <div class="tabs" role="tablist" aria-label="Project input sections">
    <div class="tab active" role="tab" aria-selected="true" aria-controls="general-tab" data-tab="general" id="tab-general" tabindex="0">General Parameters</div>
    <div class="tab" role="tab" aria-selected="false" aria-controls="circuits-tab" data-tab="circuits" id="tab-circuits" tabindex="0">Circuit Types</div>
    <div class="tab" role="tab" aria-selected="false" aria-controls="boxes-tab" data-tab="boxes" id="tab-boxes" tabindex="0">Boxes & Covers</div>
    <div class="tab" role="tab" aria-selected="false" aria-controls="scope-tab" data-tab="scope" id="tab-scope" tabindex="0">Scope & Labor</div>
    <div class="tab" role="tab" aria-selected="false" aria-controls="help-tab" data-tab="help" id="tab-help" tabindex="0">Help & Reference</div>
    </div>

<div class="tab-content active" id="general-tab" role="tabpanel" aria-labelledby="tab-general">
    <div class="input-row">
    <div class="input-group">
    <label for="wallArea" class="tooltip">Total Wall Area (m²)<span class="tooltiptext">Total wall area where boxes will be installed</span></label>
    <input type="number" id="wallArea" value="250" min="1" aria-describedby="wallAreaDesc">
    <div class="error-message" id="wallAreaError">Wall area must be positive</div>
    <div class="unit-label">m²</div>
    <div id="wallAreaDesc" class="sr-only">Total wall area where boxes will be installed</div>
    </div>
    <div class="input-group">
    <label for="density" class="tooltip">Outlets per m²<span class="tooltiptext">Number of electrical outlets per square meter</span></label>
    <input type="number" id="density" value="0.6" step="0.1" min="0" aria-describedby="densityDesc">
    <div class="error-message" id="densityError">Density must be positive</div>
    <div id="densityDesc" class="sr-only">Number of electrical outlets per square meter</div>
    </div>
    <div class="input-group">
    <label for="wastage" class="tooltip">Wastage (%)<span class="tooltiptext">Percentage of additional materials for wastage</span></label>
    <input type="number" id="wastage" value="10" min="0" max="30" aria-describedby="wastageDesc">
    <div class="error-message" id="wastageError">Wastage must be between 0-30%</div>
    <div id="wastageDesc" class="sr-only">Percentage of additional materials for wastage</div>
    </div>
</div>
<div class="input-row">
    <div class="input-group">
    <label for="currency">Currency</label>
    <select id="currency" aria-describedby="currencyDesc">
    <option value="PHP">Philippine Peso (PHP)</option>
    <option value="USD">US Dollar ($)</option>
    <option value="EUR">Euro (€)</option>
    <option value="JPY">Japanese Yen (¥)</option>
</select>
<div id="currencyDesc" class="sr-only">Select the currency for cost calculations</div>
</div>
<div class="input-group">
    <label for="overheadRate" class="tooltip">Overhead Rate (%)<span class="tooltiptext">Percentage for general overhead costs</span></label>
    <input type="number" id="overheadRate" value="18" step="0.1" min="0" max="100" aria-describedby="overheadRateDesc">
    <div class="error-message" id="overheadRateError">Overhead rate must be between 0-100%</div>
    <div id="overheadRateDesc" class="sr-only">Percentage for general overhead costs</div>
</div>
<div class="input-group">
    <label for="profitMarginRate" class="tooltip">Profit Margin (%)<span class="tooltiptext">Desired profit margin percentage</span></label>
    <input type="number" id="profitMarginRate" value="22" step="0.1" min="0" max="100" aria-describedby="profitMarginDesc">
    <div class="error-message" id="profitMarginError">Profit margin must be between 0-100%</div>
    <div id="profitMarginDesc" class="sr-only">Desired profit margin percentage</div>
</div>
</div>

<div class="input-row">
    <div class="input-group">
    <label for="equipmentCost" class="tooltip">Equipment Cost (%)<span class="tooltiptext">Percentage of material cost for equipment/tools</span></label>
    <input type="number" id="equipmentCost" value="8" step="0.1" min="0" max="50" aria-describedby="equipmentCostDesc">
    <div class="error-message" id="equipmentCostError">Equipment cost must be between 0-50%</div>
    <div id="equipmentCostDesc" class="sr-only">Percentage of material cost for equipment/tools</div>
    </div>
    <div class="input-group">
    <label for="transportationCost" class="tooltip">Transportation Cost (%)<span class="tooltiptext">Percentage of material cost for transportation</span></label>
    <input type="number" id="transportationCost" value="5" step="0.1" min="0" max="50" aria-describedby="transportationCostDesc">
    <div class="error-message" id="transportationCostError">Transportation cost must be between 0-50%</div>
    <div id="transportationCostDesc" class="sr-only">Percentage of material cost for transportation</div>
    </div>
    <div class="input-group">
    <label for="miscCost" class="tooltip">Miscellaneous Cost (%)<span class="tooltiptext">Percentage of direct cost for miscellaneous expenses</span></label>
    <input type="number" id="miscCost" value="3" step="0.1" min="0" max="20" aria-describedby="miscCostDesc">
    <div class="error-message" id="miscCostError">Miscellaneous cost must be between 0-20%</div>
    <div id="miscCostDesc" class="sr-only">Percentage of direct cost for miscellaneous expenses</div>
    </div>
</div>

<div class="circuit-summary">
    <h4>Circuit Summary</h4>
    <div id="circuitSummaryContent">
        <p>No circuits defined yet. Add circuits in the Circuit Types tab.</p>
    </div>
</div>
</div>

<div class="tab-content" id="circuits-tab" role="tabpanel" aria-labelledby="tab-circuits">
    <div class="work-item">
    <div class="work-item-title">
    <span>Circuit Types Configuration</span>
    <button class="btn btn-primary btn-sm" id="addCircuitBtn" aria-label="Add new circuit type">Add Circuit Type</button>
    </div>
    <p style="margin-bottom: 15px; color: var(--text-medium);">Define different circuit types with their wire sizes and typical box fill requirements.</p>
    
    <div class="input-row-circuit" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto; margin-bottom: 15px; font-weight: 600; padding: 0 8px;">
        <div>Circuit Description</div>
        <div>Wire Size</div>
        <div>% of Total</div>
        <div>Conductors</div>
        <div>Devices</div>
        <div>Clamps</div>
        <div>Action</div>
    </div>
    
    <div id="circuitsContainer" aria-live="polite">
        <!-- Dynamic circuits will be added here -->
    </div>
    
    <div class="input-row" style="margin-top: 15px;">
        <div class="input-group">
            <label>Total Distribution</label>
            <input type="text" id="circuitDistributionTotal" value="0%" readonly style="background-color: #f8f9fa; font-weight: bold;">
        </div>
        <div class="input-group">
            <label>Total Boxes</label>
            <input type="text" id="circuitTotalBoxes" value="0 boxes" readonly style="background-color: #f8f9fa; font-weight: bold;">
        </div>
    </div>
    <div class="error-message" id="circuitDistributionError"></div>
    </div>
    
    <div class="work-item">
    <div class="work-item-title">
    <span>NEC Compliance by Circuit Type</span>
    </div>
    <div id="circuitNecResults">
        <p>NEC compliance calculations will appear here after circuits are defined and calculated.</p>
    </div>
    </div>
</div>

<div class="tab-content" id="boxes-tab" role="tabpanel" aria-labelledby="tab-boxes">
    <div class="work-item">
    <div class="work-item-title">
    <span>Box Types & Distribution</span>
</div>
<div class="input-row">
    <div class="input-group">
    <label for="pctJunc" class="tooltip">Junction Box (%)<span class="tooltiptext">Percentage of junction boxes (4x4")</span></label>
    <input type="number" id="pctJunc" value="30" min="0" max="100" aria-describedby="pctJuncDesc">
    <div id="pctJuncDesc" class="sr-only">Percentage of junction boxes</div>
    </div>
    <div class="input-group">
    <label for="pctUtil" class="tooltip">Utility Box (%)<span class="tooltiptext">Percentage of utility boxes</span></label>
    <input type="number" id="pctUtil" value="35" min="0" max="100" aria-describedby="pctUtilDesc">
    <div id="pctUtilDesc" class="sr-only">Percentage of utility boxes</div>
    </div>
    <div class="input-group">
    <label for="pctSq" class="tooltip">Square Box (%)<span class="tooltiptext">Percentage of square boxes</span></label>
    <input type="number" id="pctSq" value="15" min="0" max="100" aria-describedby="pctSqDesc">
    <div id="pctSqDesc" class="sr-only">Percentage of square boxes</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="pctPull" class="tooltip">Pull Box (%)<span class="tooltiptext">Percentage of pull boxes (8x8")</span></label>
    <input type="number" id="pctPull" value="5" min="0" max="100" aria-describedby="pctPullDesc">
    <div id="pctPullDesc" class="sr-only">Percentage of pull boxes (8x8")</div>
    </div>
    <div class="input-group">
    <label for="pctGutter" class="tooltip">Gutter (%)<span class="tooltiptext">Percentage of gutters</span></label>
    <input type="number" id="pctGutter" value="3" min="0" max="100" aria-describedby="pctGutterDesc">
    <div id="pctGutterDesc" class="sr-only">Percentage of gutters</div>
    </div>
    <div class="input-group">
    <label for="pctWire4" class="tooltip">Wireway 4x4" (%)<span class="tooltiptext">Percentage of 4x4 wireways</span></label>
    <input type="number" id="pctWire4" value="7" min="0" max="100" aria-describedby="pctWire4Desc">
    <div id="pctWire4Desc" class="sr-only">Percentage of 4x4 wireways</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="pctWire6" class="tooltip">Wireway 6x6" (%)<span class="tooltiptext">Percentage of 6x6 wireways</span></label>
    <input type="number" id="pctWire6" value="3" min="0" max="100" aria-describedby="pctWire6Desc">
    <div id="pctWire6Desc" class="sr-only">Percentage of 6x6 wireways</div>
    </div>
    <div class="input-group">
    <label for="pctWire8" class="tooltip">Wireway 8x8" (%)<span class="tooltiptext">Percentage of 8x8 wireways</span></label>
    <input type="number" id="pctWire8" value="2" min="0" max="100" aria-describedby="pctWire8Desc">
    <div id="pctWire8Desc" class="sr-only">Percentage of 8x8 wireways</div>
    </div>
    <div class="input-group">
    <label>Total Distribution</label>
    <input type="text" id="distributionTotal" value="100%" readonly style="background-color: #f8f9fa;">
    </div>
    </div>
    <div class="error-message" id="distributionError"></div>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Unit Costs & Procurement</span>
    </div>
    <div class="procurement-note">
    <strong>Procurement Notes:</strong> Quantities will be rounded up to nearest standard packaging (cartons of 10 for boxes, 25 for covers, 100 for nipples)
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="costJunc" class="tooltip">Junction Box<span class="tooltiptext">Cost per junction box (4x4")</span></label>
    <input type="number" id="costJunc" value="55" min="0" step="0.01" aria-describedby="costJuncDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costJuncDesc" class="sr-only">Cost per junction box (4x4")</div>
    </div>
    <div class="input-group">
    <label for="costUtil" class="tooltip">Utility Box<span class="tooltiptext">Cost per utility box</span></label>
    <input type="number" id="costUtil" value="65" min="0" step="0.01" aria-describedby="costUtilDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costUtilDesc" class="sr-only">Cost per utility box</div>
    </div>
    <div class="input-group">
    <label for="costSq" class="tooltip">Square Box<span class="tooltiptext">Cost per square box</span></label>
    <input type="number" id="costSq" value="60" min="0" step="0.01" aria-describedby="costSqDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costSqDesc" class="sr-only">Cost per square box</div>
    </div>
</div>
<div class="input-row">
    <div class="input-group">
    <label for="costPull" class="tooltip">Pull Box<span class="tooltiptext">Cost per pull box (8x8")</span></label>
    <input type="number" id="costPull" value="125" min="0" step="0.01" aria-describedby="costPullDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costPullDesc" class="sr-only">Cost per pull box (8x8")</div>
    </div>
    <div class="input-group">
    <label for="costGutter" class="tooltip">Gutter<span class="tooltiptext">Cost per gutter</span></label>
    <input type="number" id="costGutter" value="220" min="0" step="0.01" aria-describedby="costGutterDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costGutterDesc" class="sr-only">Cost per gutter</div>
    </div>
    <div class="input-group">
    <label for="costNip" class="tooltip">Closed Nipple<span class="tooltiptext">Cost per closed nipple</span></label>
    <input type="number" id="costNip" value="18" min="0" step="0.01" aria-describedby="costNipDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costNipDesc" class="sr-only">Cost per closed nipple</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="costWire4" class="tooltip">Wireway 4x4"<span class="tooltiptext">Cost per 4x4 wireway</span></label>
    <input type="number" id="costWire4" value="160" min="0" step="0.01" aria-describedby="costWire4Desc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costWire4Desc" class="sr-only">Cost per 4x4 wireway</div>
    </div>
    <div class="input-group">
    <label for="costWire6" class="tooltip">Wireway 6x6"<span class="tooltiptext">Cost per 6x6 wireway</span></label>
    <input type="number" id="costWire6" value="265" min="0" step="0.01" aria-describedby="costWire6Desc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costWire6Desc" class="sr-only">Cost per 6x6 wireway</div>
    </div>
    <div class="input-group">
    <label for="costWire8" class="tooltip">Wireway 8x8"<span class="tooltiptext">Cost per 8x8 wireway</span></label>
    <input type="number" id="costWire8" value="375" min="0" step="0.01" aria-describedby="costWire8Desc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costWire8Desc" class="sr-only">Cost per 8x8 wireway</div>
    </div>
    </div>
    <div class="input-row">
    <div class="input-group">
    <label for="costCover" class="tooltip">Covers<span class="tooltiptext">Cost per cover</span></label>
    <input type="number" id="costCover" value="25" min="0" step="0.01" aria-describedby="costCoverDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="costCoverDesc" class="sr-only">Cost per cover</div>
    </div>
    </div>
    </div>
    </div>

<div class="tab-content" id="scope-tab" role="tabpanel" aria-labelledby="tab-scope">
    <div class="work-item">
    <div class="work-item-title">
    <span>Scope of Work Definition</span>
    </div>
    <div class="scope-checklist">
    <h4>What's Included:</h4>
    <ul style="padding-left: 20px; margin-bottom: 15px;">
    <li>Supply and installation of all electrical boxes, covers, and accessories</li>
    <li>Box mounting and securing per NEC requirements</li>
    <li>Installation of necessary nipples and connectors</li>
    <li>Coordination with other trades for proper placement</li>
    <li>Compliance with local building codes and standards</li>
    </ul>
    <h4>What's Not Included:</h4>
    <ul style="padding-left: 20px;">
    <li>Wiring and terminations (by electrical team)</li>
    <li>Wall patching and finishing (by finishing team)</li>
    <li>Specialty boxes not listed in standard catalog</li>
    <li>Demolition of existing boxes or structures</li>
    <li>Permit fees and inspections</li>
    </ul>
    </div>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Labor & Crew Parameters</span>
    </div>
    <div class="input-row-2">
    <div class="input-group">
    <label for="laborRate" class="tooltip">Labor Rate (per hour)<span class="tooltiptext">Hourly rate for electrical workers</span></label>
    <input type="number" id="laborRate" value="85" min="0" step="0.01" aria-describedby="laborRateDesc">
    <div class="unit-label currency-unit">PHP</div>
    <div id="laborRateDesc" class="sr-only">Hourly rate for electrical workers</div>
    </div>
    <div class="input-group">
    <label for="productivity" class="tooltip">Productivity (boxes/hour)<span class="tooltiptext">Number of boxes installed per hour per worker</span></label>
    <input type="number" id="productivity" value="4.5" min="0.1" step="0.1" aria-describedby="productivityDesc">
    <div class="unit-label">boxes/hour</div>
    <div id="productivityDesc" class="sr-only">Number of boxes installed per hour per worker</div>
    </div>
    </div>
    <div class="input-row-2">
    <div class="input-group">
    <label for="crewSize" class="tooltip">Crew Size<span class="tooltiptext">Number of workers in the installation crew</span></label>
    <input type="number" id="crewSize" value="3" min="1" aria-describedby="crewSizeDesc">
    <div id="crewSizeDesc" class="sr-only">Number of workers in the installation crew</div>
    </div>
    <div class="input-group">
    <label for="workHours" class="tooltip">Daily Work Hours<span class="tooltiptext">Standard work hours per day</span></label>
    <input type="number" id="workHours" value="8" min="1" max="12" aria-describedby="workHoursDesc">
    <div class="unit-label">hours/day</div>
    <div id="workHoursDesc" class="sr-only">Standard work hours per day</div>
    </div>
    </div>
    <div class="crew-sizing">
    <h4>Crew Sizing Options</h4>
    <div class="crew-options">
    <div class="crew-option">
    <h5>Standard Crew</h5>
    <p>2 Electricians</p>
    <p>1 Helper</p>
    </div>
    <div class="crew-option">
    <h5>Small Crew</h5>
    <p>1 Electrician</p>
    <p>1 Helper</p>
    </div>
    <div class="crew-option">
    <h5>Large Crew</h5>
    <p>3 Electricians</p>
    <p>2 Helpers</p>
    </div>
    </div>
    </div>
    </div>
    </div>

<div class="tab-content" id="help-tab" role="tabpanel" aria-labelledby="tab-help">
    <div class="help-section how-to-use">
    <h3>How to Use This Multi-Wire Estimator</h3>
    <div class="step-guide">
    <p><span class="step-number">1</span> Enter project details and general parameters in the General tab</p>
    <p><span class="step-number">2</span> Define different circuit types with their wire sizes in the Circuit Types tab</p>
    <p><span class="step-number">3</span> Configure box distribution percentages and unit costs in the Boxes & Covers tab</p>
    <p><span class="step-number">4</span> Review scope of work and adjust labor parameters in the Scope & Labor tab</p>
    <p><span class="step-number">5</span> Click "Calculate" to generate your professional multi-wire estimate</p>
    <p><span class="step-number">6</span> Export results as PDF or Excel for your proposal</p>
    </div>
    </div>
    <div class="help-section calculation-formulas">
    <h3>Multi-Wire Calculation Formulas</h3>
    <div class="formula-box">
    <h4>Total Boxes by Circuit Type</h4>
    <p><strong>Total Outlets = Wall Area × Outlet Density</strong></p>
    <p><strong>Circuit Boxes = Total Outlets × Circuit Percentage</strong></p>
    <p>Example: 250 m² × 0.6 outlets/m² × 40% = 60 boxes for lighting circuits</p>
    <h4>NEC Box Fill Calculation</h4>
    <p><strong>Per Circuit Type based on wire size and conductor count</strong></p>
    <h4>Material Cost Calculation</h4>
    <p><strong>Material Cost = Σ(Circuit Quantity × Unit Cost) × (1 + Wastage%)</strong></p>
    <h4>Labor Cost Calculation</h4>
    <p><strong>Labor Hours = Total Boxes ÷ (Productivity Rate × Crew Size)</strong></p>
    <p><strong>Labor Cost = Labor Hours × Labor Rate</strong></p>
    <h4>Indirect Cost Calculation</h4>
    <p><strong>Equipment Cost = Material Cost × Equipment %</strong></p>
    <p><strong>Transportation Cost = Material Cost × Transportation %</strong></p>
    <p><strong>Miscellaneous Cost = Direct Cost × Miscellaneous %</strong></p>
    <h4>Total Cost Calculation</h4>
    <p><strong>Direct Cost = Material Cost + Labor Cost</strong></p>
    <p><strong>Indirect Cost = Equipment + Transportation + Miscellaneous</strong></p>
    <p><strong>Overhead = (Direct Cost + Indirect Cost) × Overhead Rate</strong></p>
    <p><strong>Profit = (Direct Cost + Indirect Cost + Overhead) × Profit Margin</strong></p>
    <p><strong>Total Cost = Direct Cost + Indirect Cost + Overhead + Profit</strong></p>
    </div>
    </div>
    <div class="help-section standard-sizes">
    <h3>Standard Box Volumes (cubic inches)</h3>
    <div class="reference-box">
    <ul>
    <li>Standard Switch Box: 18.0 cu. in.</li>
    <li>Deep Switch Box: 22.5 cu. in.</li>
    <li>4" Square Box (1-1/2" deep): 21.0 cu. in.</li>
    <li>4" Square Box (2-1/8" deep): 30.3 cu. in.</li>
    <li>4" Square Box (2-1/2" deep): 42.0 cu. in.</li>
    <li>4-11/16" Square Box (1-1/2" deep): 31.5 cu. in.</li>
    <li>4-11/16" Square Box (2-1/8" deep): 42.5 cu. in.</li>
    <li>Octagon Box (standard): 18.0 cu. in.</li>
    <li>Octagon Box (deep): 25.5 cu. in.</li>
    </ul>
    </div>
    </div>
    <div class="help-section standard-sizes">
    <h3>Volume Allowances per NEC 314.16</h3>
    <div class="reference-box">
    <ul>
    <li>Conductor Volume Allowances:
    <ul style="padding-left: 20px;">
    <li>18 AWG: 1.5 cu. in.</li>
    <li>16 AWG: 1.75 cu. in.</li>
    <li>14 AWG: 2.0 cu. in.</li>
    <li>12 AWG: 2.25 cu. in.</li>
    <li>10 AWG: 2.5 cu. in.</li>
    <li>8 AWG: 3.0 cu. in.</li>
    <li>6 AWG: 5.0 cu. in.</li>
    </ul>
    </li>
    <li>Device (yoke) allowance: 2 × conductor volume</li>
    <li>Grounding conductors: 1 × conductor volume (all grounds count as one)</li>
    <li>Cable clamps: 1 × conductor volume</li>
    <li>Pigtails: 1 × conductor volume (each)</li>
    </ul>
    </div>
    </div>
    <div class="help-section standard-sizes">
    <h3>Standard Procurement Packaging</h3>
    <div class="reference-box">
    <ul>
    <li>Standard Boxes: Cartons of 10 units</li>
    <li>Covers: Cartons of 25 units</li>
    <li>Nipples: Boxes of 100 units</li>
    <li>Gutters: Individual units</li>
    <li>Wireways: Individual units</li>
    </ul>
    </div>
    </div>
    <div class="help-section test-cases">
    <h3>Multi-Wire Test Cases</h3>
    <div class="test-case">
    <h4>Test Case: Mixed Commercial Office</h4>
    <p><strong>Lighting Circuits (14 AWG):</strong> 40% - 60 boxes</p>
    <p><strong>General Outlets (12 AWG):</strong> 50% - 75 boxes</p>
    <p><strong>Appliance Circuits (10 AWG):</strong> 10% - 15 boxes</p>
    <p><strong>Total:</strong> 150 boxes with optimized box selection per circuit type</p>
    </div>
    <div class="test-case">
    <h4>Test Case: High-Density Retail</h4>
    <p><strong>Lighting (12 AWG):</strong> 30% - 54 boxes</p>
    <p><strong>General Outlets (12 AWG):</strong> 60% - 108 boxes</p>
    <p><strong>Appliance (10 AWG):</strong> 10% - 18 boxes</p>
    <p><strong>Total:</strong> 180 boxes with circuit-specific NEC compliance</p>
    </div>
    </div>
    </div>
    </div>
    <div class="input-group" style="margin-top: 20px;">
    <button class="btn btn-primary" id="calculateBtn" style="width: 100%; padding: 12px; font-size: 1.1rem;">Calculate</button>
    </div>
    </div>
    <div class="output-section">
    <h2 class="section-title">Multi-Wire Estimate Results</h2>
    <div id="necComplianceWarning" class="nec-result nec-warning hidden">
    <strong>NEC Compliance Warning:</strong> Some box types may not meet NEC requirements. Review details below.
    </div>
    
    <div class="work-item">
    <div class="work-item-title">
    <span>Circuit Summary</span>
    </div>
    <div id="circuitResultsSummary">
        <p>Circuit breakdown will appear here after calculation.</p>
    </div>
    </div>
    
    <div class="work-item">
    <div class="work-item-title">
    <span>Bill of Quantities</span>
    </div>
    <table class="bill-of-quantity-table" id="billOfQuantity">
    <thead>
    <tr>
    <th>Item</th>
    <th>Description</th>
    <th>Qty</th>
    <th>Unit</th>
    <th>Unit Cost</th>
    <th>Material Cost</th>
    <th>Labor Cost</th>
    <th>Total</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td colspan="8" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="5">TOTAL</td>
    <td id="totalMaterialCost" class="text-right">-</td>
    <td id="totalLaborCost" class="text-right">-</td>
    <td id="totalCostColumn" class="text-right">-</td>
    </tr>
    </tfoot>
    </table>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Cost Breakdown</span>
    </div>
    <div class="cost-breakdown">
    <div class="cost-card">
    <div>Material Cost</div>
    <div id="materialCost" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card">
    <div>Labor Cost</div>
    <div id="laborCost" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card">
    <div>Equipment Cost</div>
    <div id="equipmentCostDisplay" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card">
    <div>Transportation Cost</div>
    <div id="transportationCostDisplay" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card">
    <div>Miscellaneous Cost</div>
    <div id="miscCostDisplay" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card">
    <div>Direct Cost</div>
    <div id="directCost" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card">
    <div>Indirect Cost</div>
    <div id="indirectCost" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card">
    <div>Overhead</div>
    <div id="overheadCost" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card">
    <div>Profit</div>
    <div id="profitCost" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    <div class="cost-card" style="border-top-color: var(--success);">
    <div>Total Cost</div>
    <div id="totalCost" class="cost-value">-</div>
    <div class="currency-display">PHP</div>
    </div>
    </div>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Project Summary</span>
    </div>
    <div class="input-row-2">
    <div class="input-group">
    <label>Total Boxes</label>
    <input type="text" id="totalBoxes" readonly style="background-color: #f8f9fa;">
    </div>
    <div class="input-group">
    <label>Total Labor Hours</label>
    <input type="text" id="totalLaborHours" readonly style="background-color: #f8f9fa;">
    </div>
    </div>
    <div class="input-row-2">
    <div class="input-group">
    <label>Project Duration (Standard Crew)</label>
    <input type="text" id="projectDuration" readonly style="background-color: #f8f9fa;">
    </div>
    <div class="input-group">
    <label>Cost per Box</label>
    <input type="text" id="costPerBox" readonly style="background-color: #f8f9fa;">
    </div>
    </div>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>Procurement Summary</span>
    </div>
    <table class="bill-of-quantity-table" id="procurementTable">
    <thead>
    <tr>
    <th>Item</th>
    <th>Qty Needed</th>
    <th>Packaging</th>
    <th>Units to Order</th>
    <th>Cost</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td colspan="5" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="4">TOTAL PROCUREMENT COST</td>
    <td id="totalProcurementCost" class="text-right">-</td>
    </tr>
    </tfoot>
    </table>
    </div>
    <div class="work-item">
    <div class="work-item-title">
    <span>NEC Compliance Summary</span>
    </div>
    <div id="necComplianceSummary">
    <p>NEC compliance details will appear here after calculation.</p>
    </div>
    </div>
    </div>
    </div>
    </main>
    </div>
    <script>
    // Global variables
    let projectData = {};
    let circuitNecResults = {};

    // Enhanced Box Capacities with NEC-driven selection
    const BOX_CAPACITIES = {
        'Utility Box (Standard)': { volume: 18.0, costMultiplier: 1.0, description: 'Standard Utility Box' },
        'Utility Box (Deep)': { volume: 22.5, costMultiplier: 1.2, description: 'Deep Utility Box' },
        '4x4 Junction Box (1.5")': { volume: 21.0, costMultiplier: 1.0, description: '4x4" Junction Box (1.5" deep)' },
        '4x4 Junction Box (2.125")': { volume: 30.3, costMultiplier: 1.4, description: '4x4" Junction Box (2.125" deep)' },
        '4x4 Square Box (1.5")': { volume: 21.0, costMultiplier: 1.0, description: '4x4" Square Box (1.5" deep)' },
        '4x4 Square Box (2.125")': { volume: 30.3, costMultiplier: 1.4, description: '4x4" Square Box (2.125" deep)' },
        'Two Gang Box (Standard)': { volume: 30.0, costMultiplier: 1.0, description: 'Two Gang Box (Standard)' },
        'Two Gang Box (Deep)': { volume: 42.0, costMultiplier: 1.3, description: 'Two Gang Box (Deep)' }
    };

    // Box type mappings for NEC-driven selection
    const BOX_TYPE_MAPPINGS = {
        'Utility Box (Standard)': 'Utility Box (Deep)',
        '4x4 Junction Box (1.5")': '4x4 Junction Box (2.125")',
        '4x4 Square Box (1.5")': '4x4 Square Box (2.125")',
        'Two Gang Box (Standard)': 'Two Gang Box (Deep)'
    };

    // Set default date to today
    document.getElementById('projectDate').valueAsDate = new Date();
    
    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(t => {
    t.classList.remove('active');
    t.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.tab-content').forEach(c => {
    c.classList.remove('active');
    });
    
    // Activate clicked tab
    this.classList.add('active');
    this.setAttribute('aria-selected', 'true');
    const tabId = this.getAttribute('data-tab') + '-tab';
    document.getElementById(tabId).classList.add('active');
    });
    
    // Keyboard navigation for tabs
    tab.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    this.click();
    }
    });
    });
    
    // Utility functions
    function safeNumber(v, fallback = 0) {
    if (v === "" || v === null || v === undefined) return fallback;
    const n = Number(v);
    return isNaN(n) ? fallback : n;
    }

    function formatNumber(num, dp = 2) {
    if (typeof num !== 'number' || isNaN(num)) return "0.00";
    const rounded = Math.round((num + Number.EPSILON) * Math.pow(10, dp)) / Math.pow(10, dp);
    return rounded.toLocaleString(undefined, { minimumFractionDigits: dp, maximumFractionDigits: dp });
    }

    function formatCurrency(n) {
    if (typeof n !== 'number' || isNaN(n)) return "PHP 0.00";
    const c = document.getElementById('currency').value;
    let symbol = "";
    switch (c) {
    case 'PHP': symbol = 'PHP'; break;
    case 'USD': symbol = '$'; break;
    case 'EUR': symbol = '€'; break;
    case 'JPY': symbol = '¥'; break;
    default: symbol = c + '';
    }
    return symbol + ' ' + formatNumber(n, 2);
    }
    
    // Update currency displays
    function updateCurrencyDisplays() {
    const currency = document.getElementById('currency').value;
    let symbol = "";
    switch (currency) {
    case 'PHP': symbol = 'PHP'; break;
    case 'USD': symbol = '$'; break;
    case 'EUR': symbol = '€'; break;
    case 'JPY': symbol = '¥'; break;
    default: symbol = currency;
    }
    
    // Update all currency displays
    document.querySelectorAll('.currency-display').forEach(el => {
    el.textContent = symbol;
    });
    
    // Update input labels
    document.querySelectorAll('.currency-unit').forEach(el => {
    el.textContent = symbol;
    });
    }
    
    // Initial currency update
    updateCurrencyDisplays();
    
    // Currency change listener
    document.getElementById('currency').addEventListener('change', updateCurrencyDisplays);
    
    // Circuit Management
    function addCircuit() {
    const container = document.getElementById('circuitsContainer');
    const circuitId = 'circuit_' + Date.now();
    
    const circuitHTML = `
    <div class="input-row-circuit circuit-item" id="${circuitId}">
    <div class="input-group">
    <input type="text" class="circuit-description" placeholder="e.g., Lighting Circuits" value="Lighting Circuits">
    </div>
    <div class="input-group">
    <select class="circuit-wire-size">
    <option value="14">14 AWG</option>
    <option value="12" selected>12 AWG</option>
    <option value="10">10 AWG</option>
    <option value="8">8 AWG</option>
    </select>
    </div>
    <div class="input-group">
    <input type="number" class="circuit-percentage" value="40" min="0" max="100" step="1">
    <div class="unit-label">%</div>
    </div>
    <div class="input-group">
    <input type="number" class="circuit-conductors" value="4" min="0" step="1">
    <div class="unit-label">pcs</div>
    </div>
    <div class="input-group">
    <input type="number" class="circuit-devices" value="1" min="0" step="1">
    <div class="unit-label">pcs</div>
    </div>
    <div class="input-group">
    <input type="number" class="circuit-clamps" value="2" min="0" step="1">
    <div class="unit-label">pcs</div>
    </div>
    <div class="input-group">
    <button class="remove-btn" type="button" onclick="removeCircuit('${circuitId}')" aria-label="Remove this circuit">Remove</button>
    </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', circuitHTML);
    
    // Add event listeners to update totals
    const newCircuit = document.getElementById(circuitId);
    const inputs = newCircuit.querySelectorAll('input');
    inputs.forEach(input => {
    input.addEventListener('input', updateCircuitTotals);
    });
    
    const select = newCircuit.querySelector('select');
    select.addEventListener('change', updateCircuitTotals);
    
    updateCircuitTotals();
    }
    
    function removeCircuit(id) {
    const element = document.getElementById(id);
    if (element) {
    element.remove();
    updateCircuitTotals();
    }
    }
    
    function updateCircuitTotals() {
    const circuits = document.querySelectorAll('.circuit-item');
    let totalPercentage = 0;
    
    circuits.forEach(circuit => {
    const percentage = safeNumber(circuit.querySelector('.circuit-percentage').value);
    totalPercentage += percentage;
    });
    
    document.getElementById('circuitDistributionTotal').value = totalPercentage.toFixed(1) + '%';
    
    // Update total boxes preview
    const wallArea = safeNumber(document.getElementById('wallArea').value);
    const density = safeNumber(document.getElementById('density').value);
    const totalBoxes = wallArea * density;
    document.getElementById('circuitTotalBoxes').value = Math.round(totalBoxes) + ' boxes';
    
    const errorElement = document.getElementById('circuitDistributionError');
    if (Math.abs(totalPercentage - 100) > 0.1) {
    errorElement.textContent = 'Circuit percentages must add up to 100% (Current: ' + totalPercentage.toFixed(1) + '%)';
    errorElement.style.display = 'block';
    return false;
    } else {
    errorElement.style.display = 'none';
    return true;
    }
    }
    
    // Add initial circuit
    document.getElementById('addCircuitBtn').addEventListener('click', addCircuit);
    
    // Distribution validation
    function validateDistribution() {
    const pctJunc = safeNumber(document.getElementById('pctJunc').value);
    const pctUtil = safeNumber(document.getElementById('pctUtil').value);
    const pctSq = safeNumber(document.getElementById('pctSq').value);
    const pctPull = safeNumber(document.getElementById('pctPull').value);
    const pctGutter = safeNumber(document.getElementById('pctGutter').value);
    const pctWire4 = safeNumber(document.getElementById('pctWire4').value);
    const pctWire6 = safeNumber(document.getElementById('pctWire6').value);
    const pctWire8 = safeNumber(document.getElementById('pctWire8').value);
    
    const total = pctJunc + pctUtil + pctSq + pctPull + pctGutter + pctWire4 + pctWire6 + pctWire8;
    document.getElementById('distributionTotal').value = total.toFixed(1) + '%';
    
    const errorElement = document.getElementById('distributionError');
    if (Math.abs(total - 100) > 0.1) {
    errorElement.textContent = 'Distribution percentages must add up to 100% (Current: ' + total.toFixed(1) + '%)';
    errorElement.style.display = 'block';
    return false;
    } else {
    errorElement.style.display = 'none';
    return true;
    }
    }
    
    // Add distribution validation to percentage inputs
    const percentageInputs = ['pctJunc', 'pctUtil', 'pctSq', 'pctPull', 'pctGutter', 'pctWire4', 'pctWire6', 'pctWire8'];
    percentageInputs.forEach(id => {
    document.getElementById(id).addEventListener('input', validateDistribution);
    });
    
    // Add circuit percentage validation to wall area and density
    document.getElementById('wallArea').addEventListener('input', updateCircuitTotals);
    document.getElementById('density').addEventListener('input', updateCircuitTotals);
    
    // CORRECTED NEC Box Fill Calculation for Circuits
    function calculateNECBoxFillForCircuit(circuitData) {
    const conductorSize = parseInt(circuitData.wireSize, 10);
    const currentConductors = safeNumber(circuitData.conductors);
    const groundingConductors = 1; // Always count as one per NEC
    const devicesCount = safeNumber(circuitData.devices);
    const cableClamps = safeNumber(circuitData.clamps);
    const pigtails = 2; // Standard assumption
    const safetyFactor = 0.20; // 20% safety factor

    const conductorVolumes = { 18:1.5, 16:1.75, 14:2.0, 12:2.25, 10:2.5, 8:3.0, 6:5.0 };
    const volPerConductor = conductorVolumes[conductorSize] || conductorVolumes[12];

    // NEC counting:
    const currentVolume = (currentConductors + pigtails) * volPerConductor;
    const groundVolume = volPerConductor; // counts as ONE equivalent
    const deviceVolume = devicesCount * 2 * volPerConductor;
    const clampVolume = cableClamps * volPerConductor;

    const totalVolumeRequired = currentVolume + groundVolume + deviceVolume + clampVolume;
    const volumeWithSafety = totalVolumeRequired * (1 + safetyFactor);

    // Find suitable box sizes
    const suitableBoxes = Object.entries(BOX_CAPACITIES)
        .filter(([boxName, boxData]) => boxData.volume >= volumeWithSafety)
        .sort((a, b) => a[1].volume - b[1].volume);

    const smallestSuitableBox = suitableBoxes[0];
    const isCompliant = smallestSuitableBox != undefined;

    const necResult = {
    conductorSize,
    currentConductors,
    pigtails,
    groundingConductors,
    devicesCount,
    cableClamps,
    volPerConductor,
    currentVolume,
    groundVolume,
    deviceVolume,
    clampVolume,
    totalVolumeRequired,
    volumeWithSafety,
    safetyFactor: safetyFactor * 100,
    requiredBoxVolume: volumeWithSafety,
    smallestSuitableBox: smallestSuitableBox ? smallestSuitableBox[0] : null,
    smallestSuitableBoxVolume: smallestSuitableBox ? smallestSuitableBox[1].volume : null,
    isCompliant,
    suitableBoxes
    };

    return necResult;
    }
    
    // Get NEC-compliant box selection and costs for circuits
    function getNECCompliantBoxesForCircuit(necResult) {
    if (!necResult) return {};
    
    const requiredVolume = necResult.volumeWithSafety;
    const boxUpgrades = {};
    
    // Check each standard box type and upgrade if necessary
    Object.entries(BOX_CAPACITIES).forEach(([boxName, boxData]) => {
        // If this box type doesn't meet requirements, check if there's an upgrade available
        if (boxData.volume < requiredVolume && BOX_TYPE_MAPPINGS[boxName]) {
            const upgradedBox = BOX_TYPE_MAPPINGS[boxName];
            const upgradedBoxData = BOX_CAPACITIES[upgradedBox];
            
            if (upgradedBoxData && upgradedBoxData.volume >= requiredVolume) {
                boxUpgrades[boxName] = upgradedBox;
            }
        }
    });
    
    return boxUpgrades;
    }
    
    // Main calculation function - MULTI-WIRE ENHANCED
    function calculateEstimate() {
    console.log('Calculate button clicked'); // Debug log
    
    // Validate inputs first
    if (!validateInputs()) {
    console.log('Input validation failed');
    return;
    }

    // Validate circuits
    if (!validateCircuits()) {
    console.log('Circuit validation failed');
    return;
    }

    // Get circuit data
    const circuits = [];
    const circuitElements = document.querySelectorAll('.circuit-item');
    
    circuitElements.forEach(circuitElement => {
    const description = circuitElement.querySelector('.circuit-description').value;
    const wireSize = circuitElement.querySelector('.circuit-wire-size').value;
    const percentage = safeNumber(circuitElement.querySelector('.circuit-percentage').value) / 100;
    const conductors = safeNumber(circuitElement.querySelector('.circuit-conductors').value);
    const devices = safeNumber(circuitElement.querySelector('.circuit-devices').value);
    const clamps = safeNumber(circuitElement.querySelector('.circuit-clamps').value);
    
    circuits.push({
        description,
        wireSize,
        percentage,
        conductors,
        devices,
        clamps
    });
    });

    // Calculate total outlets
    const wallArea = parseFloat(document.getElementById('wallArea').value);
    const density = parseFloat(document.getElementById('density').value);
    const totalOutlets = wallArea * density;
    
    // Calculate boxes per circuit and NEC requirements
    let totalMaterialCost = 0;
    let totalLaborCost = 0;
    const circuitResults = [];
    circuitNecResults = {};

    circuits.forEach(circuit => {
    const circuitBoxes = Math.ceil(totalOutlets * circuit.percentage);
    const necResult = calculateNECBoxFillForCircuit(circuit);
    const boxUpgrades = getNECCompliantBoxesForCircuit(necResult);
    
    circuitNecResults[circuit.description] = {
        necResult,
        boxUpgrades,
        circuitBoxes
    };
    
    circuitResults.push({
        ...circuit,
        circuitBoxes,
        necResult,
        boxUpgrades
    });
    });

    // Update circuit summary in General tab
    updateCircuitSummary(circuitResults, totalOutlets);
    
    // Update NEC results in Circuits tab
    updateCircuitNecResults(circuitResults);

    // Continue with existing calculation using the largest wire size for conservative estimate
    const largestWireSize = Math.max(...circuits.map(c => parseInt(c.wireSize)));
    
    // Get other input values
    const wastage = parseFloat(document.getElementById('wastage').value) / 100;
    const overheadRate = parseFloat(document.getElementById('overheadRate').value) / 100;
    const profitMarginRate = parseFloat(document.getElementById('profitMarginRate').value) / 100;
    const laborRate = parseFloat(document.getElementById('laborRate').value);
    const productivity = parseFloat(document.getElementById('productivity').value);
    const crewSize = parseFloat(document.getElementById('crewSize').value);
    const workHours = parseFloat(document.getElementById('workHours').value);
    
    // Get indirect cost rates
    const equipmentRate = parseFloat(document.getElementById('equipmentCost').value) / 100;
    const transportationRate = parseFloat(document.getElementById('transportationCost').value) / 100;
    const miscRate = parseFloat(document.getElementById('miscCost').value) / 100;
    
    // Get box distribution percentages
    const pctJunc = parseFloat(document.getElementById('pctJunc').value) / 100;
    const pctUtil = parseFloat(document.getElementById('pctUtil').value) / 100;
    const pctSq = parseFloat(document.getElementById('pctSq').value) / 100;
    const pctPull = parseFloat(document.getElementById('pctPull').value) / 100;
    const pctGutter = parseFloat(document.getElementById('pctGutter').value) / 100;
    const pctWire4 = parseFloat(document.getElementById('pctWire4').value) / 100;
    const pctWire6 = parseFloat(document.getElementById('pctWire6').value) / 100;
    const pctWire8 = parseFloat(document.getElementById('pctWire8').value) / 100;
    
    // Get base unit costs
    const baseCostJunc = parseFloat(document.getElementById('costJunc').value);
    const baseCostUtil = parseFloat(document.getElementById('costUtil').value);
    const baseCostSq = parseFloat(document.getElementById('costSq').value);
    const costPull = parseFloat(document.getElementById('costPull').value);
    const costGutter = parseFloat(document.getElementById('costGutter').value);
    const costNip = parseFloat(document.getElementById('costNip').value);
    const costWire4 = parseFloat(document.getElementById('costWire4').value);
    const costWire6 = parseFloat(document.getElementById('costWire6').value);
    const costWire8 = parseFloat(document.getElementById('costWire8').value);
    const costCover = parseFloat(document.getElementById('costCover').value);
    
    // Apply NEC-driven cost adjustments based on worst-case circuit
    let costJunc = baseCostJunc;
    let costUtil = baseCostUtil;
    let costSq = baseCostSq;
    
    let necAdjustments = [];
    
    // Find the circuit with the largest volume requirement
    let maxVolumeRequired = 0;
    let worstCaseCircuit = null;
    
    circuitResults.forEach(circuit => {
    if (circuit.necResult.volumeWithSafety > maxVolumeRequired) {
        maxVolumeRequired = circuit.necResult.volumeWithSafety;
        worstCaseCircuit = circuit;
    }
    });
    
    // Apply upgrades based on worst-case circuit
    if (worstCaseCircuit) {
    const worstCaseUpgrades = worstCaseCircuit.boxUpgrades;
    
    if (worstCaseUpgrades['Utility Box (Standard)']) {
        const upgradedBox = worstCaseUpgrades['Utility Box (Standard)'];
        costUtil = baseCostUtil * BOX_CAPACITIES[upgradedBox].costMultiplier;
        necAdjustments.push(`Utility boxes upgraded to ${upgradedBox} for ${worstCaseCircuit.description}`);
    }
    
    if (worstCaseUpgrades['4x4 Junction Box (1.5")']) {
        const upgradedBox = worstCaseUpgrades['4x4 Junction Box (1.5")'];
        costJunc = baseCostJunc * BOX_CAPACITIES[upgradedBox].costMultiplier;
        necAdjustments.push(`Junction boxes upgraded to ${upgradedBox} for ${worstCaseCircuit.description}`);
    }
    
    if (worstCaseUpgrades['4x4 Square Box (1.5")']) {
        const upgradedBox = worstCaseUpgrades['4x4 Square Box (1.5")'];
        costSq = baseCostSq * BOX_CAPACITIES[upgradedBox].costMultiplier;
        necAdjustments.push(`Square boxes upgraded to ${upgradedBox} for ${worstCaseCircuit.description}`);
    }
    }
    
    // Calculate quantities for each box type
    const qtyJunc = Math.ceil(totalOutlets * pctJunc);
    const qtyUtil = Math.ceil(totalOutlets * pctUtil);
    const qtySq = Math.ceil(totalOutlets * pctSq);
    const qtyPull = Math.ceil(totalOutlets * pctPull);
    const qtyGutter = Math.ceil(totalOutlets * pctGutter);
    const qtyWire4 = Math.ceil(totalOutlets * pctWire4);
    const qtyWire6 = Math.ceil(totalOutlets * pctWire6);
    const qtyWire8 = Math.ceil(totalOutlets * pctWire8);
    const qtyNip = Math.ceil(totalOutlets * 0.8); // Assume 80% of boxes need nipples
    const qtyCover = Math.ceil(totalOutlets); // One cover per box
    
    // Calculate material costs with wastage
    const materialCostJunc = qtyJunc * costJunc * (1 + wastage);
    const materialCostUtil = qtyUtil * costUtil * (1 + wastage);
    const materialCostSq = qtySq * costSq * (1 + wastage);
    const materialCostPull = qtyPull * costPull * (1 + wastage);
    const materialCostGutter = qtyGutter * costGutter * (1 + wastage);
    const materialCostNip = qtyNip * costNip * (1 + wastage);
    const materialCostWire4 = qtyWire4 * costWire4 * (1 + wastage);
    const materialCostWire6 = qtyWire6 * costWire6 * (1 + wastage);
    const materialCostWire8 = qtyWire8 * costWire8 * (1 + wastage);
    const materialCostCover = qtyCover * costCover * (1 + wastage);
    
    // Calculate total material cost
    totalMaterialCost = materialCostJunc + materialCostUtil + materialCostSq + materialCostPull + 
    materialCostGutter + materialCostNip + materialCostWire4 + materialCostWire6 + 
    materialCostWire8 + materialCostCover;
    
    // Calculate labor cost
    const totalLaborHours = totalOutlets / (productivity * crewSize);
    totalLaborCost = totalLaborHours * laborRate * crewSize;
    
    // Calculate direct cost
    const directCost = totalMaterialCost + totalLaborCost;
    
    // Calculate indirect costs
    const equipmentCost = totalMaterialCost * equipmentRate;
    const transportationCost = totalMaterialCost * transportationRate;
    const miscCost = directCost * miscRate;
    const indirectCost = equipmentCost + transportationCost + miscCost;
    
    // Calculate total before overhead
    const totalBeforeOverhead = directCost + indirectCost;
    
    // Calculate overhead and profit
    const overheadCost = totalBeforeOverhead * overheadRate;
    const totalBeforeProfit = totalBeforeOverhead + overheadCost;
    const profitCost = totalBeforeProfit * profitMarginRate;
    
    // Calculate total cost
    const totalCost = totalBeforeProfit + profitCost;
    
    // Calculate cost per box
    const costPerBox = totalCost / totalOutlets;
    
    // Update Bill of Quantities table with 8 columns (including Total)
    const boqTable = document.getElementById('billOfQuantity');
    const currencySymbol = getCurrencySymbol();
    
    // Determine box descriptions based on NEC upgrades
    const juncDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['4x4 Junction Box (1.5")'] ? 
        BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['4x4 Junction Box (1.5")']].description : '4x4" Junction Box';
    const utilDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['Utility Box (Standard)'] ? 
        BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['Utility Box (Standard)']].description : 'Standard Utility Box';
    const sqDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['4x4 Square Box (1.5")'] ? 
        BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['4x4 Square Box (1.5")']].description : '4x4" Square Box';
    
    boqTable.innerHTML = `
    <thead>
    <tr>
    <th>Item</th>
    <th>Description</th>
    <th>Qty</th>
    <th>Unit</th>
    <th>Unit Cost</th>
    <th>Material Cost</th>
    <th>Labor Cost</th>
    <th>Total</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>Junction Box</td>
    <td>${juncDescription}</td>
    <td>${qtyJunc}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costJunc, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostJunc, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyJunc / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostJunc + (qtyJunc / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Utility Box</td>
    <td>${utilDescription}</td>
    <td>${qtyUtil}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costUtil, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostUtil, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyUtil / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostUtil + (qtyUtil / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Square Box</td>
    <td>${sqDescription}</td>
    <td>${qtySq}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costSq, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostSq, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtySq / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostSq + (qtySq / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Pull Box</td>
    <td>8x8" Pull Box</td>
    <td>${qtyPull}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costPull, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostPull, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyPull / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostPull + (qtyPull / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Gutter</td>
    <td>Wire Gutter</td>
    <td>${qtyGutter}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costGutter, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostGutter, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyGutter / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostGutter + (qtyGutter / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Closed Nipple</td>
    <td>1/2" Closed Nipple</td>
    <td>${qtyNip}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costNip, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostNip, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyNip / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostNip + (qtyNip / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 4x4</td>
    <td>4x4" Wireway</td>
    <td>${qtyWire4}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costWire4, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire4, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyWire4 / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire4 + (qtyWire4 / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 6x6</td>
    <td>6x6" Wireway</td>
    <td>${qtyWire6}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costWire6, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire6, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyWire6 / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire6 + (qtyWire6 / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 8x8</td>
    <td>8x8" Wireway</td>
    <td>${qtyWire8}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costWire8, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire8, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyWire8 / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostWire8 + (qtyWire8 / productivity * laborRate), currencySymbol)}</td>
    </tr>
    <tr>
    <td>Covers</td>
    <td>Blank Covers</td>
    <td>${qtyCover}</td>
    <td>pc</td>
    <td class="text-right">${formatCurrency(costCover, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostCover, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(qtyCover / productivity * laborRate, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(materialCostCover + (qtyCover / productivity * laborRate), currencySymbol)}</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="5">TOTAL</td>
    <td class="text-right">${formatCurrency(totalMaterialCost, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(totalLaborCost, currencySymbol)}</td>
    <td class="text-right">${formatCurrency(totalMaterialCost + totalLaborCost, currencySymbol)}</td>
    </tr>
    </tfoot>
    `;
    
    // Update the total in the footer
    document.getElementById('totalCostColumn').textContent = formatCurrency(totalMaterialCost + totalLaborCost, currencySymbol);
    
    // Update cost breakdown
    document.getElementById('materialCost').textContent = formatCurrency(totalMaterialCost, currencySymbol);
    document.getElementById('laborCost').textContent = formatCurrency(totalLaborCost, currencySymbol);
    document.getElementById('equipmentCostDisplay').textContent = formatCurrency(equipmentCost, currencySymbol);
    document.getElementById('transportationCostDisplay').textContent = formatCurrency(transportationCost, currencySymbol);
    document.getElementById('miscCostDisplay').textContent = formatCurrency(miscCost, currencySymbol);
    document.getElementById('directCost').textContent = formatCurrency(directCost, currencySymbol);
    document.getElementById('indirectCost').textContent = formatCurrency(indirectCost, currencySymbol);
    document.getElementById('overheadCost').textContent = formatCurrency(overheadCost, currencySymbol);
    document.getElementById('profitCost').textContent = formatCurrency(profitCost, currencySymbol);
    document.getElementById('totalCost').textContent = formatCurrency(totalCost, currencySymbol);
    
    // Update project summary
    document.getElementById('totalBoxes').value = Math.round(totalOutlets) + ' boxes';
    document.getElementById('totalLaborHours').value = totalLaborHours.toFixed(1) + ' hours';
    document.getElementById('projectDuration').value = (totalLaborHours / workHours).toFixed(1) + ' days';
    document.getElementById('costPerBox').value = formatCurrency(costPerBox, currencySymbol) + ' per box';
    
    // Update procurement table with costs
    const procurementTable = document.getElementById('procurementTable');
    let totalProcurementCost = 0;
    
    procurementTable.innerHTML = `
    <thead>
    <tr>
    <th>Item</th>
    <th>Qty Needed</th>
    <th>Packaging</th>
    <th>Units to Order</th>
    <th>Cost</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>${juncDescription}</td>
    <td>${qtyJunc}</td>
    <td>Carton of 10</td>
    <td>${Math.ceil(qtyJunc / 10)}</td>
    <td class="text-right">${formatCurrency(materialCostJunc, currencySymbol)}</td>
    </tr>
    <tr>
    <td>${utilDescription}</td>
    <td>${qtyUtil}</td>
    <td>Carton of 10</td>
    <td>${Math.ceil(qtyUtil / 10)}</td>
    <td class="text-right">${formatCurrency(materialCostUtil, currencySymbol)}</td>
    </tr>
    <tr>
    <td>${sqDescription}</td>
    <td>${qtySq}</td>
    <td>Carton of 10</td>
    <td>${Math.ceil(qtySq / 10)}</td>
    <td class="text-right">${formatCurrency(materialCostSq, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Pull Box</td>
    <td>${qtyPull}</td>
    <td>Individual</td>
    <td>${qtyPull}</td>
    <td class="text-right">${formatCurrency(materialCostPull, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Gutter</td>
    <td>${qtyGutter}</td>
    <td>Individual</td>
    <td>${qtyGutter}</td>
    <td class="text-right">${formatCurrency(materialCostGutter, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Closed Nipple</td>
    <td>${qtyNip}</td>
    <td>Box of 100</td>
    <td>${Math.ceil(qtyNip / 100)}</td>
    <td class="text-right">${formatCurrency(materialCostNip, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 4x4</td>
    <td>${qtyWire4}</td>
    <td>Individual</td>
    <td>${qtyWire4}</td>
    <td class="text-right">${formatCurrency(materialCostWire4, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 6x6</td>
    <td>${qtyWire6}</td>
    <td>Individual</td>
    <td>${qtyWire6}</td>
    <td class="text-right">${formatCurrency(materialCostWire6, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Wireway 8x8</td>
    <td>${qtyWire8}</td>
    <td>Individual</td>
    <td>${qtyWire8}</td>
    <td class="text-right">${formatCurrency(materialCostWire8, currencySymbol)}</td>
    </tr>
    <tr>
    <td>Covers</td>
    <td>${qtyCover}</td>
    <td>Carton of 25</td>
    <td>${Math.ceil(qtyCover / 25)}</td>
    <td class="text-right">${formatCurrency(materialCostCover, currencySymbol)}</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="4">TOTAL PROCUREMENT COST</td>
    <td id="totalProcurementCost" class="text-right">${formatCurrency(totalMaterialCost, currencySymbol)}</td>
    </tr>
    </tfoot>
    `;

    // Update circuit results summary
    updateCircuitResultsSummary(circuitResults, totalOutlets);
    
    // Update NEC compliance summary
    checkNECCompliance(necAdjustments, circuitResults);
    
    // Update currency units
    updateCurrencyDisplays();

    // Store project data for export
    projectData = {
    projectName: document.getElementById('projectName').value,
    bidNumber: document.getElementById('bidNumber').value,
    clientName: document.getElementById('clientName').value,
    projectLocation: document.getElementById('projectLocation').value,
    preparedBy: document.getElementById('preparedBy').value,
    projectDate: document.getElementById('projectDate').value,
    currency: document.getElementById('currency').value,
    totals: {
        totalMaterialCost,
        totalLaborCost,
        equipmentCost,
        transportationCost,
        miscCost,
        indirectCost,
        directCost,
        overheadCost,
        profitCost,
        totalCost,
        costPerBox
    },
    quantities: {
        totalOutlets,
        qtyJunc,
        qtyUtil,
        qtySq,
        qtyPull,
        qtyGutter,
        qtyWire4,
        qtyWire6,
        qtyWire8,
        qtyNip,
        qtyCover
    },
    labor: {
        totalLaborHours,
        productivity,
        crewSize,
        laborRate,
        workHours
    },
    rates: {
        equipmentRate: equipmentRate * 100,
        transportationRate: transportationRate * 100,
        miscRate: miscRate * 100,
        overheadRate: overheadRate * 100,
        profitMarginRate: profitMarginRate * 100,
        wastage: wastage * 100
    },
    circuits: circuitResults,
    circuitNecResults,
    necAdjustments
    };

    console.log('Calculation completed successfully'); // Debug log
    }
    
    // Circuit validation
    function validateCircuits() {
    const circuits = document.querySelectorAll('.circuit-item');
    if (circuits.length === 0) {
    alert('Please add at least one circuit type in the Circuit Types tab.');
    return false;
    }
    
    return updateCircuitTotals(); // This also validates percentage totals
    }
    
    // Update circuit summary in General tab
    function updateCircuitSummary(circuitResults, totalOutlets) {
    const summaryElement = document.getElementById('circuitSummaryContent');
    let summaryHTML = '<div class="circuit-totals">';
    
    circuitResults.forEach(circuit => {
    summaryHTML += `
    <div class="circuit-total-item">
    <div style="font-weight: bold;">${circuit.description}</div>
    <div>${circuit.wireSize} AWG</div>
    <div>${(circuit.percentage * 100).toFixed(0)}% (${circuit.circuitBoxes} boxes)</div>
    </div>
    `;
    });
    
    summaryHTML += `
    <div class="circuit-total-item" style="background: #e8f5e8;">
    <div style="font-weight: bold;">TOTAL</div>
    <div>Multi-Wire</div>
    <div>100% (${Math.round(totalOutlets)} boxes)</div>
    </div>
    </div>
    `;
    
    summaryElement.innerHTML = summaryHTML;
    }
    
    // Update circuit NEC results in Circuits tab
    function updateCircuitNecResults(circuitResults) {
    const resultsElement = document.getElementById('circuitNecResults');
    let resultsHTML = '';
    
    circuitResults.forEach(circuit => {
    const nec = circuit.necResult;
    const statusClass = nec.isCompliant ? 'nec-pass' : 'nec-fail';
    const statusText = nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT';
    
    resultsHTML += `
    <div class="circuit-item">
    <div class="circuit-header">
    <span class="circuit-title">${circuit.description}</span>
    <span class="circuit-wire-size">${circuit.wireSize} AWG</span>
    </div>
    <div class="nec-result ${statusClass}">
    ${statusText}: ${formatNumber(nec.volumeWithSafety, 2)} cu. in. required
    ${nec.smallestSuitableBox ? ` - Minimum: ${nec.smallestSuitableBox}` : ' - Custom box needed'}
    </div>
    <div class="nec-details">
    <p><strong>Calculation Details:</strong></p>
    <ul>
    <li>Conductors: ${circuit.conductors} current + 2 pigtails = ${(circuit.conductors + 2)} × ${formatNumber(nec.volPerConductor, 2)} cu. in.</li>
    <li>Devices: ${circuit.devices} × 2 × ${formatNumber(nec.volPerConductor, 2)} cu. in.</li>
    <li>Clamps: ${circuit.clamps} × ${formatNumber(nec.volPerConductor, 2)} cu. in.</li>
    <li>Ground: 1 × ${formatNumber(nec.volPerConductor, 2)} cu. in.</li>
    </ul>
    </div>
    </div>
    `;
    });
    
    resultsElement.innerHTML = resultsHTML;
    }
    
    // Update circuit results summary in output
    function updateCircuitResultsSummary(circuitResults, totalOutlets) {
    const summaryElement = document.getElementById('circuitResultsSummary');
    let summaryHTML = '<div class="circuit-totals">';
    
    circuitResults.forEach(circuit => {
    const nec = circuit.necResult;
    const statusText = nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT';
    const statusColor = nec.isCompliant ? '#2e7d32' : '#c62828';
    
    summaryHTML += `
    <div class="circuit-total-item">
    <div style="font-weight: bold;">${circuit.description}</div>
    <div>${circuit.wireSize} AWG</div>
    <div>${circuit.circuitBoxes} boxes</div>
    <div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
    </div>
    `;
    });
    
    summaryHTML += `
    <div class="circuit-total-item" style="background: #e8f5e8;">
    <div style="font-weight: bold;">PROJECT TOTAL</div>
    <div>Multi-Wire</div>
    <div>${Math.round(totalOutlets)} boxes</div>
    <div style="font-weight: bold;">OPTIMIZED</div>
    </div>
    </div>
    `;
    
    summaryElement.innerHTML = summaryHTML;
    }
    
    // Enhanced NEC compliance check for multi-wire
    function checkNECCompliance(necAdjustments = [], circuitResults = []) {
    const summaryElement = document.getElementById('necComplianceSummary');
    const warningElement = document.getElementById('necComplianceWarning');
    
    let summaryHTML = '<p><strong>Multi-Wire NEC 314.16 Compliance Summary:</strong></p>';
    
    let hasComplianceIssue = false;
    let allCompliant = true;
    
    circuitResults.forEach(circuit => {
    const nec = circuit.necResult;
    if (!nec.isCompliant) {
        allCompliant = false;
        hasComplianceIssue = true;
    }
    
    summaryHTML += `
    <p><strong>${circuit.description} (${circuit.wireSize} AWG):</strong></p>
    <ul>
    <li>Required Volume: ${formatNumber(nec.volumeWithSafety, 2)} cu. in.</li>
    <li>Status: <span style="color: ${nec.isCompliant ? '#2e7d32' : '#c62828'}">${nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT'}</span></li>
    <li>Minimum Box: ${nec.smallestSuitableBox || 'Custom box required'}</li>
    </ul>
    `;
    });
    
    if (necAdjustments.length > 0) {
    summaryHTML += '<p><strong>Automatic Adjustments Applied:</strong></p><ul>';
    necAdjustments.forEach(adjustment => {
        summaryHTML += `<li>${adjustment}</li>`;
    });
    summaryHTML += '</ul>';
    }
    
    summaryHTML += `<p><strong>Overall Project Status:</strong> <span style="color: ${allCompliant ? '#2e7d32' : '#c62828'}">${allCompliant ? 'FULLY COMPLIANT' : 'REVIEW REQUIRED'}</span></p>`;
    
    summaryElement.innerHTML = summaryHTML;
    
    if (hasComplianceIssue) {
    warningElement.classList.remove('hidden');
    } else {
    warningElement.classList.add('hidden');
    }
    }
    
    // Input validation function
    function validateInputs() {
    let isValid = true;
    
    // Project name validation
    const projectName = document.getElementById('projectName').value.trim();
    if (!projectName) {
    document.getElementById('projectNameError').style.display = 'block';
    document.getElementById('projectName').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('projectNameError').style.display = 'none';
    document.getElementById('projectName').classList.remove('input-error');
    }
    
    // Wall area validation
    const wallArea = parseFloat(document.getElementById('wallArea').value);
    if (isNaN(wallArea) || wallArea <= 0) {
    document.getElementById('wallAreaError').style.display = 'block';
    document.getElementById('wallArea').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('wallAreaError').style.display = 'none';
    document.getElementById('wallArea').classList.remove('input-error');
    }
    
    // Density validation
    const density = parseFloat(document.getElementById('density').value);
    if (isNaN(density) || density < 0) {
    document.getElementById('densityError').style.display = 'block';
    document.getElementById('density').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('densityError').style.display = 'none';
    document.getElementById('density').classList.remove('input-error');
    }
    
    // Wastage validation
    const wastage = parseFloat(document.getElementById('wastage').value);
    if (isNaN(wastage) || wastage < 0 || wastage > 30) {
    document.getElementById('wastageError').style.display = 'block';
    document.getElementById('wastage').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('wastageError').style.display = 'none';
    document.getElementById('wastage').classList.remove('input-error');
    }
    
    // Overhead rate validation
    const overheadRate = parseFloat(document.getElementById('overheadRate').value);
    if (isNaN(overheadRate) || overheadRate < 0 || overheadRate > 100) {
    document.getElementById('overheadRateError').style.display = 'block';
    document.getElementById('overheadRate').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('overheadRateError').style.display = 'none';
    document.getElementById('overheadRate').classList.remove('input-error');
    }
    
    // Profit margin validation
    const profitMargin = parseFloat(document.getElementById('profitMarginRate').value);
    if (isNaN(profitMargin) || profitMargin < 0 || profitMargin > 100) {
    document.getElementById('profitMarginError').style.display = 'block';
    document.getElementById('profitMarginRate').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('profitMarginError').style.display = 'none';
    document.getElementById('profitMarginRate').classList.remove('input-error');
    }
    
    // Equipment cost validation
    const equipmentCost = parseFloat(document.getElementById('equipmentCost').value);
    if (isNaN(equipmentCost) || equipmentCost < 0 || equipmentCost > 50) {
    document.getElementById('equipmentCostError').style.display = 'block';
    document.getElementById('equipmentCost').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('equipmentCostError').style.display = 'none';
    document.getElementById('equipmentCost').classList.remove('input-error');
    }
    
    // Transportation cost validation
    const transportationCost = parseFloat(document.getElementById('transportationCost').value);
    if (isNaN(transportationCost) || transportationCost < 0 || transportationCost > 50) {
    document.getElementById('transportationCostError').style.display = 'block';
    document.getElementById('transportationCost').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('transportationCostError').style.display = 'none';
    document.getElementById('transportationCost').classList.remove('input-error');
    }
    
    // Misc cost validation
    const miscCost = parseFloat(document.getElementById('miscCost').value);
    if (isNaN(miscCost) || miscCost < 0 || miscCost > 20) {
    document.getElementById('miscCostError').style.display = 'block';
    document.getElementById('miscCost').classList.add('input-error');
    isValid = false;
    } else {
    document.getElementById('miscCostError').style.display = 'none';
    document.getElementById('miscCost').classList.remove('input-error');
    }
    
    // Distribution validation
    if (!validateDistribution()) {
    isValid = false;
    }
    
    return isValid;
    }
    
    // Currency formatting functions
    function getCurrencySymbol() {
    const currency = document.getElementById('currency').value;
    switch (currency) {
    case 'USD': return '$';
    case 'EUR': return '€';
    case 'JPY': return '¥';
    default: return 'PHP';
    }
    }

    function formatCurrency(amount, symbol = null) {
    if (symbol === null) {
        symbol = getCurrencySymbol();
    }
    if (typeof amount !== 'number' || isNaN(amount)) return symbol + ' 0.00';
    return symbol + ' ' + formatNumber(amount, 2);
    }
    
    // Enhanced PDF Export Functions for Multi-Wire
function getSelectedCurrency() {
    const el = document.getElementById('currency');
    return el ? el.value : 'PHP';
}

function getPdfCurrencyPrefix(code) {
    switch (code) {
        case 'PHP': return 'PHP ';
        case 'USD': return '$';
        case 'EUR': return '€';
        case 'JPY': return '¥';
        default: return code + ' ';
    }
}

function formatNumberForPDF(num, decimals = 2) {
    if (typeof num !== 'number' || isNaN(num)) return '0';
    return num.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

function formatCurrencyForPDF(n) {
    if (typeof n !== 'number' || isNaN(n)) return '0.00';
    const prefix = getPdfCurrencyPrefix(getSelectedCurrency());
    return prefix + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function exportToPDF() {
    if (!projectData.totals) {
        alert('No results to export. Please calculate an estimate first.');
        return;
    }

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        // Reserved areas
        const HEADER_H = 65;
        const FOOTER_H = 30;
        const CONTENT_MARGIN_L = 35;
        const CONTENT_MARGIN_R = 35;

        // Common styles
        const BRAND = { r: 44, g: 62, b: 80 }; // #2c3e50
        doc.setFont('helvetica', 'normal');

        // Header/Footer drawer (runs on every page)
        function drawHeaderFooter(data) {
            // Header bar
            doc.setFillColor(240, 240, 240);
            doc.rect(0, 0, pageWidth, HEADER_H, 'F');

            // Title
            doc.setFont('helvetica', 'bold'); 
            doc.setFontSize(13);
            doc.setTextColor(BRAND.r, BRAND.g, BRAND.b);
            doc.text('PROFESSIONAL ELECTRICAL BOXES & COVERS ESTIMATE', pageWidth / 2, 24, { align: 'center' });

            // Meta
            doc.setFont('helvetica', 'normal'); 
            doc.setFontSize(8); 
            doc.setTextColor(0);

            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            const clientName = document.getElementById('clientName').value || 'Not specified';
            const preparedBy = document.getElementById('preparedBy').value || 'Not specified';
            const bidNumber = document.getElementById('bidNumber').value || 'Not specified';
            const dateStr = document.getElementById('projectDate').value || '';

            doc.text(`Project: ${projectName}`, CONTENT_MARGIN_L, 40);
            doc.text(`Client: ${clientName}`, CONTENT_MARGIN_L, 52);
            doc.text(`Bid Number: ${bidNumber}`, pageWidth - CONTENT_MARGIN_R, 40, { align: 'right' });
            doc.text(`Prepared By: ${preparedBy}`, pageWidth - CONTENT_MARGIN_R, 52, { align: 'right' });

            // Header rule
            doc.setDrawColor(BRAND.r, BRAND.g, BRAND.b); 
            doc.setLineWidth(0.5);
            doc.line(CONTENT_MARGIN_L, HEADER_H - 6, pageWidth - CONTENT_MARGIN_R, HEADER_H - 6);

            // Footer
            const pageNumber = doc.internal.getNumberOfPages();
            doc.setFontSize(8); 
            doc.setTextColor(100);
            doc.text(`Page ${pageNumber}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, CONTENT_MARGIN_L, pageHeight - 12);
            doc.text(`Multi-Wire NEC 2023 Compliant`, pageWidth - CONTENT_MARGIN_R, pageHeight - 12, { align: 'right' });
        }

        // Common AutoTable options - Full width tables
        const TABLE_OPTS = {
            margin: { 
                left: CONTENT_MARGIN_L, 
                right: CONTENT_MARGIN_R, 
                top: HEADER_H + 6, 
                bottom: FOOTER_H + 6 
            },
            styles: {
                font: 'helvetica',
                fontSize: 7,
                cellPadding: 3,
                lineWidth: 0.25,
                lineColor: 100,
                overflow: 'linebreak',
                valign: 'middle'
            },
            headStyles: {
                fillColor: [BRAND.r, BRAND.g, BRAND.b],
                textColor: 255,
                fontStyle: 'bold',
                fontSize: 7
            },
            alternateRowStyles: { fillColor: [245, 245, 245] },
            didDrawPage: drawHeaderFooter,
            tableWidth: 'auto' // This makes tables stretch to full width
        };

        // Section helper
        function sectionTitle(text) {
            doc.setFont('helvetica', 'bold'); 
            doc.setFontSize(10);
            doc.setTextColor(BRAND.r, BRAND.g, BRAND.b);
            const y = (doc.lastAutoTable?.finalY || (HEADER_H + 12)) + 12;
            doc.text(text, CONTENT_MARGIN_L, y);
            return y + 4;
        }

        // Calculate available width for tables
        const availableWidth = pageWidth - CONTENT_MARGIN_L - CONTENT_MARGIN_R;

        // ==== Circuit Summary ====
        let startY = sectionTitle('CIRCUIT SUMMARY');
        
        const circuitHead = [
            ['Circuit Type', 'Wire Size', 'Percentage', 'Boxes', 'NEC Status']
        ];
        
        const circuitBody = [];
        let totalBoxes = 0;

        if (projectData.circuits && projectData.circuits.length > 0) {
            projectData.circuits.forEach(circuit => {
                const nec = circuit.necResult;
                const status = nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT';
                circuitBody.push([
                    circuit.description,
                    circuit.wireSize + ' AWG',
                    (circuit.percentage * 100).toFixed(0) + '%',
                    circuit.circuitBoxes.toString(),
                    status
                ]);
                totalBoxes += circuit.circuitBoxes;
            });

            // Add total row
            circuitBody.push([
                'TOTAL',
                'Multi-Wire',
                '100%',
                totalBoxes.toString(),
                'OPTIMIZED'
            ]);

            // Column widths for circuit summary
            const circuitColumnStyles = {
                0: { cellWidth: availableWidth * 0.35 }, // Circuit Type
                1: { cellWidth: availableWidth * 0.15 }, // Wire Size
                2: { cellWidth: availableWidth * 0.15 }, // Percentage
                3: { cellWidth: availableWidth * 0.15 }, // Boxes
                4: { cellWidth: availableWidth * 0.20 }  // NEC Status
            };

            doc.autoTable({
                ...TABLE_OPTS,
                startY: startY,
                head: circuitHead,
                body: circuitBody,
                columnStyles: circuitColumnStyles,
                didParseCell: function(data) {
                    // Style the total row
                    if (data.section === 'body' && data.row.index === circuitBody.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [220, 240, 220];
                    }
                    // Color code NEC status
                    if (data.column.index === 4) {
                        if (data.cell.raw === 'COMPLIANT') {
                            data.cell.styles.textColor = [46, 125, 50];
                        } else if (data.cell.raw === 'NON-COMPLIANT') {
                            data.cell.styles.textColor = [198, 40, 40];
                        } else if (data.cell.raw === 'OPTIMIZED') {
                            data.cell.styles.textColor = [30, 136, 229];
                        }
                    }
                }
            });
        }

        // ==== Bill of Quantity ====
        startY = sectionTitle('BILL OF QUANTITY');
        
        const boqHead = [
            ['Item', 'Description', 'Qty', 'Unit', 'Unit Cost', 'Material Cost', 'Labor Cost', 'Total']
        ];
        
        const boqBody = [];
        let totalMaterialCost = 0;
        let totalLaborCost = 0;

        // Get data from the current table and calculate totals
        const boqTable = document.getElementById('billOfQuantity');
        const rows = boqTable.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 8) {
                const rowData = [
                    cells[0].textContent.trim(),
                    cells[1].textContent.trim(),
                    cells[2].textContent.trim(),
                    cells[3].textContent.trim(),
                    cells[4].textContent.trim(),
                    cells[5].textContent.trim(),
                    cells[6].textContent.trim(),
                    cells[7].textContent.trim()
                ];
                boqBody.push(rowData);
                
                // Extract numeric values for totals
                const materialCost = parseFloat(cells[5].textContent.replace(/[^0-9.-]+/g,"")) || 0;
                const laborCost = parseFloat(cells[6].textContent.replace(/[^0-9.-]+/g,"")) || 0;
                totalMaterialCost += materialCost;
                totalLaborCost += laborCost;
            }
        });

        // Add total direct cost row
        const totalDirectCost = totalMaterialCost + totalLaborCost;
        boqBody.push([
            'TOTAL DIRECT COST',
            '',
            '',
            '',
            '',
            formatCurrencyForPDF(totalMaterialCost),
            formatCurrencyForPDF(totalLaborCost),
            formatCurrencyForPDF(totalDirectCost)
        ]);

        // Column widths for full width table
        const boqColumnStyles = {
            0: { cellWidth: availableWidth * 0.10 }, // Item
            1: { cellWidth: availableWidth * 0.22 }, // Description
            2: { cellWidth: availableWidth * 0.07 }, // Qty
            3: { cellWidth: availableWidth * 0.07 }, // Unit
            4: { cellWidth: availableWidth * 0.10 }, // Unit Cost
            5: { cellWidth: availableWidth * 0.13 }, // Material Cost
            6: { cellWidth: availableWidth * 0.13 }, // Labor Cost
            7: { cellWidth: availableWidth * 0.18 }  // Total
        };

        doc.autoTable({
            ...TABLE_OPTS,
            startY: startY,
            head: boqHead,
            body: boqBody,
            columnStyles: boqColumnStyles,
            didParseCell: function(data) {
                // Bold and style the total direct cost row
                if (data.section === 'body' && data.row.index === boqBody.length - 1) {
                    data.cell.styles.fontStyle = 'bold';
                    data.cell.styles.fillColor = [240, 240, 240];
                    data.cell.styles.textColor = [BRAND.r, BRAND.g, BRAND.b];
                }
                // Right align numeric columns
                if (data.column.index >= 4) {
                    data.cell.styles.halign = 'right';
                }
                if (data.column.index === 2) { // Qty column
                    data.cell.styles.halign = 'right';
                }
            }
        });

        // ==== Complete Cost Breakdown ====
        startY = sectionTitle('COMPLETE COST BREAKDOWN');
        
        const costData = [
            ['Material Cost', formatCurrencyForPDF(projectData.totals.totalMaterialCost)],
            ['Labor Cost', formatCurrencyForPDF(projectData.totals.totalLaborCost)],
            ['DIRECT COST', formatCurrencyForPDF(projectData.totals.directCost)],
            ['', ''],
            ['Equipment Cost', formatCurrencyForPDF(projectData.totals.equipmentCost) + ` (${projectData.rates.equipmentRate}%)`],
            ['Transportation Cost', formatCurrencyForPDF(projectData.totals.transportationCost) + ` (${projectData.rates.transportationRate}%)`],
            ['Miscellaneous Cost', formatCurrencyForPDF(projectData.totals.miscCost) + ` (${projectData.rates.miscRate}%)`],
            ['INDIRECT COST', formatCurrencyForPDF(projectData.totals.indirectCost)],
            ['', ''],
            ['Overhead', formatCurrencyForPDF(projectData.totals.overheadCost) + ` (${projectData.rates.overheadRate}%)`],
            ['Profit Margin', formatCurrencyForPDF(projectData.totals.profitCost) + ` (${projectData.rates.profitMarginRate}%)`],
            ['TOTAL COST', formatCurrencyForPDF(projectData.totals.totalCost)]
        ];

        // Column widths for cost breakdown
        const costColumnStyles = {
            0: { cellWidth: availableWidth * 0.6, fontStyle: 'bold' },
            1: { cellWidth: availableWidth * 0.4, halign: 'right', fontStyle: 'bold' }
        };

        doc.autoTable({
            ...TABLE_OPTS,
            startY: startY,
            head: [['Category', 'Amount']],
            body: costData,
            columnStyles: costColumnStyles,
            didParseCell: function(data) {
                if (data.section === 'body') {
                    // Style section headers
                    if (data.cell.raw === 'DIRECT COST' || data.cell.raw === 'INDIRECT COST' || data.cell.raw === 'TOTAL COST') {
                        data.cell.styles.fillColor = [240, 240, 240];
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [BRAND.r, BRAND.g, BRAND.b];
                    }
                    // Style the total row
                    if (data.row.index === costData.length - 1) {
                        data.cell.styles.fillColor = [220, 240, 220];
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [BRAND.r, BRAND.g, BRAND.b];
                    }
                    // Empty rows for spacing
                    if (data.cell.raw === '') {
                        data.cell.styles.fontSize = 4;
                    }
                }
            }
        });

        // ==== Project Summary ====
        startY = sectionTitle('PROJECT SUMMARY');
        
        const summaryData = [
            ['Total Boxes', Math.round(projectData.quantities.totalOutlets) + ' boxes'],
            ['Total Labor Hours', formatNumberForPDF(projectData.labor.totalLaborHours, 1) + ' hours'],
            ['Project Duration', formatNumberForPDF(projectData.labor.totalLaborHours / projectData.labor.workHours, 1) + ' days'],
            ['Cost per Box', formatCurrencyForPDF(projectData.totals.costPerBox)],
            ['Crew Size', projectData.labor.crewSize + ' workers'],
            ['Productivity', projectData.labor.productivity + ' boxes/hour/worker'],
            ['Labor Rate', formatCurrencyForPDF(projectData.labor.laborRate) + '/hour'],
            ['Wastage', projectData.rates.wastage + '%']
        ];

        // Column widths for project summary
        const summaryColumnStyles = {
            0: { cellWidth: availableWidth * 0.5 },
            1: { cellWidth: availableWidth * 0.5, halign: 'right' }
        };

        doc.autoTable({
            ...TABLE_OPTS,
            startY: startY,
            head: [['Parameter', 'Value']],
            body: summaryData,
            columnStyles: summaryColumnStyles
        });

        // ==== Multi-Wire NEC Compliance Details ====
        if (projectData.circuits && projectData.circuits.length > 0) {
            startY = sectionTitle('MULTI-WIRE NEC 314.16 COMPLIANCE DETAILS');
            
            // Find the worst-case circuit for overall compliance
            let worstCaseCircuit = null;
            let maxVolumeRequired = 0;
            
            projectData.circuits.forEach(circuit => {
                if (circuit.necResult.volumeWithSafety > maxVolumeRequired) {
                    maxVolumeRequired = circuit.necResult.volumeWithSafety;
                    worstCaseCircuit = circuit;
                }
            });

            if (worstCaseCircuit) {
                const nec = worstCaseCircuit.necResult;
                const necData = [
                    ['Worst-Case Circuit', worstCaseCircuit.description + ' (' + worstCaseCircuit.wireSize + ' AWG)'],
                    ['Conductor Size', worstCaseCircuit.wireSize + ' AWG'],
                    ['Current Conductors', worstCaseCircuit.conductors],
                    ['Pigtails', nec.pigtails],
                    ['Grounding Conductors', nec.groundingConductors],
                    ['Devices', worstCaseCircuit.devices],
                    ['Cable Clamps', worstCaseCircuit.clamps],
                    ['Volume per Conductor', formatNumberForPDF(nec.volPerConductor, 2) + ' cu. in.'],
                    ['Total Volume Required', formatNumberForPDF(nec.totalVolumeRequired, 2) + ' cu. in.'],
                    ['Safety Factor', nec.safetyFactor + '%'],
                    ['Volume with Safety', formatNumberForPDF(nec.volumeWithSafety, 2) + ' cu. in.'],
                    ['Minimum Required Box', nec.smallestSuitableBox || 'Custom box required'],
                    ['Compliance Status', nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT']
                ];

                // Add NEC adjustments if any
                if (projectData.necAdjustments && projectData.necAdjustments.length > 0) {
                    necData.push(['', '']);
                    necData.push(['NEC-Driven Adjustments:', '']);
                    projectData.necAdjustments.forEach(adjustment => {
                        necData.push(['', adjustment]);
                    });
                }

                // Column widths for NEC details
                const necColumnStyles = {
                    0: { cellWidth: availableWidth * 0.6, fontStyle: 'bold' },
                    1: { cellWidth: availableWidth * 0.4 }
                };

                doc.autoTable({
                    ...TABLE_OPTS,
                    startY: startY,
                    head: [['Parameter', 'Value']],
                    body: necData,
                    columnStyles: necColumnStyles,
                    didParseCell: function(data) {
                        if (data.section === 'body') {
                            // Highlight compliance status
                            if (data.cell.raw === 'COMPLIANT') {
                                data.cell.styles.textColor = [46, 125, 50]; // Green
                                data.cell.styles.fontStyle = 'bold';
                            } else if (data.cell.raw === 'NON-COMPLIANT') {
                                data.cell.styles.textColor = [198, 40, 40]; // Red
                                data.cell.styles.fontStyle = 'bold';
                            }
                            
                            // Style adjustments section
                            if (data.row.raw[0] === 'NEC-Driven Adjustments:') {
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.fillColor = [255, 243, 224];
                            } else if (data.row.raw[0] === '' && data.column.index === 1 && data.row.index > 12) {
                                data.cell.styles.fontStyle = 'italic';
                            }
                        }
                    }
                });
            }
        }

        // ==== Procurement Summary ====
        startY = sectionTitle('PROCUREMENT SUMMARY');
        
        const procurementData = [];
        const procurementTable = document.getElementById('procurementTable');
        const procurementRows = procurementTable.querySelectorAll('tbody tr');
        
        procurementRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 5) {
                procurementData.push([
                    cells[0].textContent.trim(),
                    cells[1].textContent.trim(),
                    cells[2].textContent.trim(),
                    cells[3].textContent.trim(),
                    cells[4].textContent.trim()
                ]);
            }
        });

        // Get total procurement cost
        const totalProcurementRow = procurementTable.querySelector('tfoot tr');
        const totalProcurementCost = totalProcurementRow ? totalProcurementRow.querySelector('td:last-child').textContent : '0.00';

        procurementData.push([
            'TOTAL PROCUREMENT COST',
            '',
            '',
            '',
            totalProcurementCost
        ]);

        // Column widths for procurement summary
        const procurementColumnStyles = {
            0: { cellWidth: availableWidth * 0.25 }, // Item
            1: { cellWidth: availableWidth * 0.12, halign: 'right' }, // Qty Needed
            2: { cellWidth: availableWidth * 0.18 }, // Packaging
            3: { cellWidth: availableWidth * 0.15, halign: 'right' }, // Units to Order
            4: { cellWidth: availableWidth * 0.30, halign: 'right' } // Cost
        };

        doc.autoTable({
            ...TABLE_OPTS,
            startY: startY,
            head: [['Item', 'Qty Needed', 'Packaging', 'Units to Order', 'Cost']],
            body: procurementData,
            columnStyles: procurementColumnStyles,
            didParseCell: function(data) {
                if (data.section === 'body') {
                    // Style the total row
                    if (data.row.index === procurementData.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [240, 240, 240];
                        data.cell.styles.textColor = [BRAND.r, BRAND.g, BRAND.b];
                    }
                    // Right align numeric columns
                    if (data.column.index === 1 || data.column.index === 3 || data.column.index === 4) {
                        data.cell.styles.halign = 'right';
                    }
                }
            }
        });

        const fileName = (projectData.projectName || 'estimate').replace(/[^a-z0-9]/gi, '-') + '_multi_wire_electrical_estimate.pdf';
        doc.save(fileName);

    } catch (e) {
        console.error('PDF Generation Error:', e);
        alert('Error generating PDF: ' + e.message);
    }
}

// Update the event listener to use the new function
document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
    
    // Export to Excel
    function exportToExcel() {
    if (!projectData.totals) {
    alert('No results to export. Please calculate an estimate first.');
    return;
    }
    // Create a new workbook
    const wb = XLSX.utils.book_new();
    
    // Prepare data for the Bill of Quantities sheet
    const boqData = [
    ['Item', 'Description', 'Qty', 'Unit', 'Unit Cost', 'Material Cost', 'Labor Cost', 'Total']
    ];
    
    // Get data from the table
    const boqTable = document.getElementById('billOfQuantity');
    const rows = boqTable.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length > 1) { // Skip empty rows
    const rowData = [];
    cells.forEach(cell => {
    rowData.push(cell.textContent);
    });
    boqData.push(rowData);
    }
    });
    
    // Add total row
    const totalRow = boqTable.querySelector('tfoot tr');
    const totalCells = totalRow.querySelectorAll('td');
    const totalData = [];
    totalCells.forEach(cell => {
    totalData.push(cell.textContent);
    });
    boqData.push(totalData);
    
    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(boqData);
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Bill of Quantities');
    
    // Create Circuit Summary sheet
    const circuitData = [
    ['Multi-Wire Circuit Summary'],
    ['Circuit Type', 'Wire Size', 'Percentage', 'Boxes', 'NEC Status', 'Required Volume', 'Minimum Box']
    ];
    
    projectData.circuits.forEach(circuit => {
    const nec = circuit.necResult;
    circuitData.push([
        circuit.description,
        circuit.wireSize + ' AWG',
        (circuit.percentage * 100).toFixed(0) + '%',
        circuit.circuitBoxes,
        nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT',
        formatNumberForPDF(nec.volumeWithSafety, 2) + ' cu. in.',
        nec.smallestSuitableBox || 'Custom box required'
    ]);
    });
    
    // Add totals
    circuitData.push([
    'TOTAL',
    'Multi-Wire',
    '100%',
    Math.round(projectData.quantities.totalOutlets),
    'OPTIMIZED',
    '',
    ''
    ]);
    
    const circuitWs = XLSX.utils.aoa_to_sheet(circuitData);
    XLSX.utils.book_append_sheet(wb, circuitWs, 'Circuit Summary');
    
    // Create Complete Cost Breakdown sheet
    const costData = [
    ['COMPLETE COST BREAKDOWN'],
    ['Category', 'Amount', 'Percentage'],
    ['Material Cost', formatCurrencyForPDF(projectData.totals.totalMaterialCost), ''],
    ['Labor Cost', formatCurrencyForPDF(projectData.totals.totalLaborCost), ''],
    ['DIRECT COST', formatCurrencyForPDF(projectData.totals.directCost), ''],
    ['', '', ''],
    ['Equipment Cost', formatCurrencyForPDF(projectData.totals.equipmentCost), projectData.rates.equipmentRate + '%'],
    ['Transportation Cost', formatCurrencyForPDF(projectData.totals.transportationCost), projectData.rates.transportationRate + '%'],
    ['Miscellaneous Cost', formatCurrencyForPDF(projectData.totals.miscCost), projectData.rates.miscRate + '%'],
    ['INDIRECT COST', formatCurrencyForPDF(projectData.totals.indirectCost), ''],
    ['', '', ''],
    ['Overhead', formatCurrencyForPDF(projectData.totals.overheadCost), projectData.rates.overheadRate + '%'],
    ['Profit Margin', formatCurrencyForPDF(projectData.totals.profitCost), projectData.rates.profitMarginRate + '%'],
    ['TOTAL COST', formatCurrencyForPDF(projectData.totals.totalCost), '']
    ];
    
    const costWs = XLSX.utils.aoa_to_sheet(costData);
    XLSX.utils.book_append_sheet(wb, costWs, 'Cost Breakdown');
    
    // Create Project Summary sheet
    const summaryData = [
    ['PROJECT SUMMARY'],
    ['Parameter', 'Value'],
    ['Total Boxes', Math.round(projectData.quantities.totalOutlets) + ' boxes'],
    ['Total Labor Hours', formatNumberForPDF(projectData.labor.totalLaborHours, 1) + ' hours'],
    ['Project Duration', formatNumberForPDF(projectData.labor.totalLaborHours / projectData.labor.workHours, 1) + ' days'],
    ['Cost per Box', formatCurrencyForPDF(projectData.totals.costPerBox)],
    ['Crew Size', projectData.labor.crewSize + ' workers'],
    ['Productivity', projectData.labor.productivity + ' boxes/hour/worker'],
    ['Labor Rate', formatCurrencyForPDF(projectData.labor.laborRate) + '/hour'],
    ['Wastage', projectData.rates.wastage + '%']
    ];
    
    const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, summaryWs, 'Project Summary');
    
    // Create NEC compliance sheet
    const necData = [
    ['Multi-Wire NEC 314.16 Compliance Details']
    ];
    
    projectData.circuits.forEach(circuit => {
    const nec = circuit.necResult;
    necData.push([`${circuit.description} (${circuit.wireSize} AWG)`]);
    necData.push(['Conductor Size', circuit.wireSize + ' AWG']);
    necData.push(['Current Conductors', circuit.conductors]);
    necData.push(['Pigtails', nec.pigtails]);
    necData.push(['Grounding Conductors', nec.groundingConductors]);
    necData.push(['Devices', circuit.devices]);
    necData.push(['Cable Clamps', circuit.clamps]);
    necData.push(['Volume per Conductor', formatNumberForPDF(nec.volPerConductor, 2) + ' cu. in.']);
    necData.push(['Total Volume Required', formatNumberForPDF(nec.totalVolumeRequired, 2) + ' cu. in.']);
    necData.push(['Safety Factor', nec.safetyFactor + '%']);
    necData.push(['Volume with Safety', formatNumberForPDF(nec.volumeWithSafety, 2) + ' cu. in.']);
    necData.push(['Minimum Required Box', nec.smallestSuitableBox || 'Custom box required']);
    necData.push(['NEC Compliance Status', nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT']);
    necData.push(['']);
    });
    
    // Add NEC adjustments if any
    if (projectData.necAdjustments && projectData.necAdjustments.length > 0) {
    necData.push(['NEC-Driven Adjustments:']);
    projectData.necAdjustments.forEach(adjustment => {
        necData.push([adjustment]);
    });
    }
    
    const necWs = XLSX.utils.aoa_to_sheet(necData);
    XLSX.utils.book_append_sheet(wb, necWs, 'NEC Compliance');
    
    // Save the workbook
    XLSX.writeFile(wb, 'Multi_Wire_Electrical_Estimate_' + projectData.projectName.replace(/\s+/g, '_') + '.xlsx');
    }
    
    // Reset function
    function resetCalculator() {
    if (confirm('Are you sure you want to reset all inputs? This action cannot be undone.')) {
    // Reset form inputs to default values
    document.getElementById('projectName').value = 'Commercial Fit-Out Project';
    document.getElementById('bidNumber').value = 'BID-2024-001';
    document.getElementById('clientName').value = 'ABC Development Corporation';
    document.getElementById('projectLocation').value = 'Makati City, Philippines';
    document.getElementById('preparedBy').value = 'John Smith, Licensed Electrical Engineer';
    document.getElementById('projectDate').valueAsDate = new Date();
    
    document.getElementById('wallArea').value = '250';
    document.getElementById('density').value = '0.6';
    document.getElementById('wastage').value = '10';
    document.getElementById('overheadRate').value = '18';
    document.getElementById('profitMarginRate').value = '22';
    document.getElementById('equipmentCost').value = '8';
    document.getElementById('transportationCost').value = '5';
    document.getElementById('miscCost').value = '3';
    
    // Reset circuits
    document.getElementById('circuitsContainer').innerHTML = '';
    
    // Reset results with updated 8-column structure
    document.getElementById('billOfQuantity').innerHTML = `
    <thead>
    <tr>
    <th>Item</th>
    <th>Description</th>
    <th>Qty</th>
    <th>Unit</th>
    <th>Unit Cost</th>
    <th>Material Cost</th>
    <th>Labor Cost</th>
    <th>Total</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td colspan="8" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="5">TOTAL</td>
    <td id="totalMaterialCost" class="text-right">-</td>
    <td id="totalLaborCost" class="text-right">-</td>
    <td id="totalCostColumn" class="text-right">-</td>
    </tr>
    </tfoot>
    `;
    
    document.getElementById('procurementTable').innerHTML = `
    <thead>
    <tr>
    <th>Item</th>
    <th>Qty Needed</th>
    <th>Packaging</th>
    <th>Units to Order</th>
    <th>Cost</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td colspan="5" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="total-row">
    <td colspan="4">TOTAL PROCUREMENT COST</td>
    <td id="totalProcurementCost" class="text-right">-</td>
    </tr>
    </tfoot>
    `;
    
    // Reset cost breakdown
    document.getElementById('materialCost').textContent = '-';
    document.getElementById('laborCost').textContent = '-';
    document.getElementById('equipmentCostDisplay').textContent = '-';
    document.getElementById('transportationCostDisplay').textContent = '-';
    document.getElementById('miscCostDisplay').textContent = '-';
    document.getElementById('directCost').textContent = '-';
    document.getElementById('indirectCost').textContent = '-';
    document.getElementById('overheadCost').textContent = '-';
    document.getElementById('profitCost').textContent = '-';
    document.getElementById('totalCost').textContent = '-';
    
    // Reset project summary
    document.getElementById('totalBoxes').value = '';
    document.getElementById('totalLaborHours').value = '';
    document.getElementById('projectDuration').value = '';
    document.getElementById('costPerBox').value = '';
    
    // Reset circuit summaries
    document.getElementById('circuitSummaryContent').innerHTML = '<p>No circuits defined yet. Add circuits in the Circuit Types tab.</p>';
    document.getElementById('circuitNecResults').innerHTML = '<p>NEC compliance calculations will appear here after circuits are defined and calculated.</p>';
    document.getElementById('circuitResultsSummary').innerHTML = '<p>Circuit breakdown will appear here after calculation.</p>';
    
    // Reset NEC compliance
    document.getElementById('necComplianceSummary').innerHTML = '<p>NEC compliance details will appear here after calculation.</p>';
    document.getElementById('necComplianceWarning').classList.add('hidden');
    
    // Clear validation errors
    document.querySelectorAll('.error-message').forEach(el => {
    el.style.display = 'none';
    });
    document.querySelectorAll('.input-error').forEach(el => {
    el.classList.remove('input-error');
    });
    
    // Reset project data
    projectData = {};
    circuitNecResults = {};
    
    // Add default circuit
    addCircuit();
    
    // Update currency displays
    updateCurrencyDisplays();
    }
    }
    
    // Event listeners
    document.getElementById('calculateBtn').addEventListener('click', calculateEstimate);
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
    document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
    document.getElementById('resetBtn').addEventListener('click', resetCalculator);
    
    // Currency change handler
    document.getElementById('currency').addEventListener('change', function() {
    // Update currency display in results if they exist
    if (document.getElementById('materialCost').textContent !== '-') {
    calculateEstimate();
    }
    });
    
    // Initial distribution validation
    validateDistribution();
    
    // Add default circuit on load
    addCircuit();
    </script>
    </body>
    </html>
