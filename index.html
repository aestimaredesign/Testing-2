<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Distribution Systems Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        .input-section, .output-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light);
            color: var(--primary);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .financial-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .unit-toggle, .standard-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .unit-btn, .standard-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--light);
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .unit-btn.active, .standard-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .work-item {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }

        .bill-of-quantity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .bill-of-quantity-table th,
        .bill-of-quantity-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .bill-of-quantity-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .bill-of-quantity-table tr:hover {
            background-color: #f5f5f5;
        }

        .total-row {
            font-weight: 600;
            background-color: var(--light) !important;
        }

        .text-right {
            text-align: right;
        }

        .cost-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 1rem;
        }

        .cost-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-top: 4px solid var(--secondary);
        }

        .cost-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin: 10px 0;
        }

        .validation-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }

        .tab-container {
            margin-bottom: 1rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .crew-sizing {
            margin-top: 1rem;
            padding: 15px;
            background: var(--light);
            border-radius: 6px;
            border-left: 4px solid var(--success);
        }

        .crew-sizing h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Power Distribution Systems Calculator</h1>
                <div class="controls">
                    <button class="btn btn-primary" id="saveBtn">Save Project</button>
                    <button class="btn btn-warning" id="loadBtn">Load Project</button>
                    <button class="btn btn-success" id="exportPdfBtn">Export PDF</button>
                    <button class="btn btn-success" id="exportExcelBtn">Export Excel</button>
                    <button class="btn btn-danger" id="resetBtn">Reset</button>
                </div>
            </div>
        </header>

        <div class="calculator-grid">
            <div class="input-section">
                <h2 class="section-title">Project Inputs</h2>
                <div class="input-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" placeholder="Enter project name">
                </div>
                
                <div class="input-group">
                    <label>Unit System</label>
                    <div class="unit-toggle">
                        <div class="unit-btn active" data-unit="metric">Metric (SI)</div>
                        <div class="unit-btn" data-unit="imperial">Imperial (US)</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Electrical Standards</label>
                    <div class="standard-toggle">
                        <div class="standard-btn active" data-standard="philippine">Philippine (PEC)</div>
                        <div class="standard-btn" data-standard="international">International (IEC)</div>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tabs" role="tablist">
                        <div class="tab active" data-tab="general" role="tab" aria-selected="true" tabindex="0">General Parameters</div>
                        <div class="tab" data-tab="circuits" role="tab" aria-selected="false" tabindex="0">Circuits</div>
                        <div class="tab" data-tab="cables" role="tab" aria-selected="false" tabindex="0">Cables & Wiring</div>
                        <div class="tab" data-tab="costs" role="tab" aria-selected="false" tabindex="0">Cost Settings</div>
                        <div class="tab" data-tab="help" role="tab" aria-selected="false" tabindex="0">Help & Reference</div>
                    </div>
                    
                    <div class="tab-content active" id="general-tab" role="tabpanel">
                        <div class="input-row">
                            <div class="input-group">
                                <label class="tooltip">Labor Rate (per hour)<span class="tooltiptext">Hourly rate for labor, adjust based on region and standards</span></label>
                                <input type="number" id="laborRate" value="250" step="0.01">
                                <div class="unit-label">PHP/hour</div>
                            </div>
                            <div class="input-group">
                                <label class="tooltip">Overhead Rate (%)<span class="tooltiptext">Percentage for general overhead costs</span></label>
                                <input type="number" id="overheadRate" value="15" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="tooltip">Profit Margin (%)<span class="tooltiptext">Desired profit margin percentage</span></label>
                                <input type="number" id="profitMarginRate" value="20" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="tab-content" id="circuits-tab" role="tabpanel">
                        <button class="btn btn-primary" id="addCircuitBtn">Add Circuit</button>
                        <div id="circuitList"></div>
                    </div>
                    <div class="tab-content" id="cables-tab" role="tabpanel">
                        <div class="input-group">
                            <label>Cable Type</label>
                            <select id="cableType">
                                <option value="THHN">THHN Copper</option>
                                <option value="THWN">THWN Copper</option>
                                <option value="XLPE">XLPE Aluminum</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Conduit Type</label>
                            <select id="conduitType">
                                <option value="PVC">PVC</option>
                                <option value="EMT">EMT</option>
                                <option value="IMC">IMC</option>
                            </select>
                        </div>
                    </div>
                    <div class="tab-content" id="costs-tab" role="tabpanel">
                        <div class="input-row">
                            <div class="input-group">
                                <label>Material Cost Multiplier</label>
                                <input type="number" id="materialMultiplier" value="1.2" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Contingency Rate (%)</label>
                                <input type="number" id="contingencyRate" value="10" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="tab-content" id="help-tab" role="tabpanel">
                        <div class="help-section">
                            <h3>Help & Reference</h3>
                            <div class="formula-box">
                                Voltage Drop (%) = (2 × I × L × R) / V × 100<br>
                                Total Cost = (Material + Labor + Equipment) × (1 + Overhead%) × (1 + Profit%) × (1 + Contingency%)
                            </div>
                            <div class="reference-box">
                                PEC: Use 125% of continuous load for ampacity.<br>
                                IEC: Refer to IEC 60364 for cable sizing.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="output-section">
                <h2 class="section-title">Calculation Results</h2>
                <table class="bill-of-quantity-table">
                    <thead>
                        <tr>
                            <th>Circuit</th>
                            <th>Load (kVA)</th>
                            <th>Current (A)</th>
                            <th>Cable Size (mm²)</th>
                            <th>Length (m)</th>
                            <th>Voltage Drop (%)</th>
                            <th>Material Cost (PHP)</th>
                            <th>Labor Cost (PHP)</th>
                        </tr>
                    </thead>
                    <tbody id="boqTable"></tbody>
                </table>
                <div class="cost-breakdown">
                    <div class="cost-card">
                        <h3>Total Material Cost</h3>
                        <div class="cost-value" id="totalMaterial">0.00 PHP</div>
                    </div>
                    <div class="cost-card">
                        <h3>Total Labor Cost</h3>
                        <div class="cost-value" id="totalLabor">0.00 PHP</div>
                    </div>
                    <div class="cost-card">
                        <h3>Overhead Cost</h3>
                        <div class="cost-value" id="overheadCost">0.00 PHP</div>
                    </div>
                    <div class="cost-card">
                        <h3>Total Project Cost</h3>
                        <div class="cost-value" id="totalCost">0.00 PHP</div>
                    </div>
                </div>
                <div class="crew-sizing">
                    <h3>Crew Sizing Estimate</h3>
                    <div id="laborHours">Total Labor Hours: 0</div>
                    <div id="laborDays">Total Labor Days: 0</div>
                    <div id="crewSize">Suggested Crew Size: 0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utility function to clamp empty/NaN to zero
        function safeNumber(value) {
            return isNaN(value) || value === '' ? 0 : parseFloat(value);
        }

        // Circuit data storage
        let circuits = [];

        // Cable data (resistance in ohms/km, cost in PHP/m)
        const cableData = {
            THHN: { resistance: 0.005, costPerMeter: 50, sizes: [2, 3.5, 5.5, 8, 14] },
            THWN: { resistance: 0.006, costPerMeter: 55, sizes: [2, 3.5, 5.5, 8, 14] },
            XLPE: { resistance: 0.008, costPerMeter: 45, sizes: [4, 6, 10, 16, 25] }
        };

        // Add circuit dynamically
        document.getElementById('addCircuitBtn').addEventListener('click', () => {
            const circuitId = circuits.length + 1;
            const circuitDiv = document.createElement('div');
            circuitDiv.className = 'work-item';
            circuitDiv.innerHTML = `
                <div class="work-item-title">Circuit ${circuitId}</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Load (kVA)</label>
                        <input type="number" class="circuit-load" value="10" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Power Factor</label>
                        <input type="number" class="circuit-pf" value="0.85" step="0.01" min="0.1" max="1">
                    </div>
                    <div class="input-group">
                        <label>Length (m)</label>
                        <input type="number" class="circuit-length" value="50" step="1">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Voltage (V)</label>
                        <input type="number" class="circuit-voltage" value="230" step="1">
                    </div>
                    <div class="input-group">
                        <label>Phase</label>
                        <select class="circuit-phase">
                            <option value="single">Single Phase</option>
                            <option value="three">Three Phase</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-danger remove-circuit" data-id="${circuitId}">Remove</button>
                    </div>
                </div>
            `;
            document.getElementById('circuitList').appendChild(circuitDiv);
            circuits.push({ id: circuitId });
            calculate();
        });

        // Remove circuit
        document.getElementById('circuitList').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-circuit')) {
                const id = parseInt(e.target.dataset.id);
                circuits = circuits.filter(c => c.id !== id);
                e.target.closest('.work-item').remove();
                calculate();
            }
        });

        // Tab switching with ARIA and keyboard support
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab));
            tab.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    switchTab(tab);
                }
            });
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
                t.setAttribute('tabindex', '0');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
            tab.setAttribute('tabindex', '-1');
            document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        }

        // Unit and standard toggle
        document.querySelectorAll('.unit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                calculate();
            });
        });

        document.querySelectorAll('.standard-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.standard-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                calculate();
            });
        });

        // Calculation logic
        function calculate() {
            const laborRate = safeNumber(document.getElementById('laborRate').value);
            const overheadRate = safeNumber(document.getElementById('overheadRate').value) / 100;
            const profitMarginRate = safeNumber(document.getElementById('profitMarginRate').value) / 100;
            const contingencyRate = safeNumber(document.getElementById('contingencyRate').value) / 100;
            const materialMultiplier = safeNumber(document.getElementById('materialMultiplier').value);
            const cableType = document.getElementById('cableType').value;
            const standard = document.querySelector('.standard-btn.active').dataset.standard;

            let totalMaterialCost = 0;
            let totalLaborCost = 0;
            let totalLaborHours = 0;
            const boqRows = [];

            document.querySelectorAll('.work-item').forEach((item, index) => {
                const load = safeNumber(item.querySelector('.circuit-load').value);
                const pf = safeNumber(item.querySelector('.circuit-pf').value);
                const length = safeNumber(item.querySelector('.circuit-length').value);
                const voltage = safeNumber(item.querySelector('.circuit-voltage').value);
                const phase = item.querySelector('.circuit-phase').value;

                // Calculate current (I = P / (V * PF * sqrt(3) for three-phase))
                const current = phase === 'three' ? (load * 1000) / (voltage * pf * Math.sqrt(3)) : (load * 1000) / (voltage * pf);

                // Cable sizing (simplified, using PEC 125% rule for continuous loads)
                const adjustedCurrent = standard === 'philippine' ? current * 1.25 : current;
                const cableSizes = cableData[cableType].sizes;
                let selectedSize = cableSizes.find(size => size * 15 >= adjustedCurrent) || cableSizes[cableSizes.length - 1];

                // Voltage drop calculation (VD% = (2 * I * L * R) / V * 100)
                const resistance = cableData[cableType].resistance * length / 1000;
                const voltageDrop = (2 * current * resistance / voltage) * 100;

                // Costs
                const materialCost = length * cableData[cableType].costPerMeter * materialMultiplier;
                const laborHours = length * 0.05 + 2; // 0.05 hours/meter + 2 hours for termination
                const laborCost = laborHours * laborRate;

                totalMaterialCost += materialCost;
                totalLaborCost += laborCost;
                totalLaborHours += laborHours;

                boqRows.push({
                    circuit: `Circuit ${index + 1}`,
                    load: load.toFixed(2),
                    current: current.toFixed(2),
                    cableSize: selectedSize,
                    length: length.toFixed(2),
                    voltageDrop: voltageDrop.toFixed(2),
                    materialCost: materialCost.toFixed(2),
                    laborCost: laborCost.toFixed(2)
                });
            });

            // Update BOQ table
            const boqTable = document.getElementById('boqTable');
            boqTable.innerHTML = boqRows.map(row => `
                <tr>
                    <td>${row.circuit}</td>
                    <td>${row.load} kVA</td>
                    <td>${row.current} A</td>
                    <td>${row.cableSize} mm²</td>
                    <td>${row.length} m</td>
                    <td>${row.voltageDrop} %</td>
                    <td>${row.materialCost} PHP</td>
                    <td>${row.laborCost} PHP</td>
                </tr>
            `).join('');

            // Total cost calculation
            const subtotal = totalMaterialCost + totalLaborCost;
            const overheadCost = subtotal * overheadRate;
            const totalCost = (subtotal + overheadCost) * (1 + profitMarginRate) * (1 + contingencyRate);

            // Update cost breakdown
            document.getElementById('totalMaterial').textContent = totalMaterialCost.toFixed(2) + ' PHP';
            document.getElementById('totalLabor').textContent = totalLaborCost.toFixed(2) + ' PHP';
            document.getElementById('overheadCost').textContent = overheadCost.toFixed(2) + ' PHP';
            document.getElementById('totalCost').textContent = totalCost.toFixed(2) + ' PHP';

            // Crew sizing (8-hour workday)
            const laborDays = totalLaborHours / 8;
            const suggestedCrew = Math.min(Math.max(Math.ceil(laborDays / 10), 2), 15); // 10 days, 2-15 workers
            document.getElementById('laborHours').textContent = `Total Labor Hours: ${totalLaborHours.toFixed(1)}`;
            document.getElementById('laborDays').textContent = `Total Labor Days: ${laborDays.toFixed(1)}`;
            document.getElementById('crewSize').textContent = `Suggested Crew Size: ${suggestedCrew}`;
        }

        // Export to Excel with currency formatting
        document.getElementById('exportExcelBtn').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Project Name', document.getElementById('projectName').value],
                ['Unit System', document.querySelector('.unit-btn.active').dataset.unit],
                ['Standard', document.querySelector('.standard-btn.active').dataset.standard],
                [],
                ['Circuit', 'Load (kVA)', 'Current (A)', 'Cable Size (mm²)', 'Length (m)', 'Voltage Drop (%)', 'Material Cost (PHP)', 'Labor Cost (PHP)']
            ];

            document.querySelectorAll('.work-item').forEach((item, index) => {
                const load = safeNumber(item.querySelector('.circuit-load').value);
                const pf = safeNumber(item.querySelector('.circuit-pf').value);
                const length = safeNumber(item.querySelector('.circuit-length').value);
                const voltage = safeNumber(item.querySelector('.circuit-voltage').value);
                const phase = item.querySelector('.circuit-phase').value;
                const current = phase === 'three' ? (load * 1000) / (voltage * pf * Math.sqrt(3)) : (load * 1000) / (voltage * pf);
                const standard = document.querySelector('.standard-btn.active').dataset.standard;
                const adjustedCurrent = standard === 'philippine' ? current * 1.25 : current;
                const cableType = document.getElementById('cableType').value;
                const cableSizes = cableData[cableType].sizes;
                const selectedSize = cableSizes.find(size => size * 15 >= adjustedCurrent) || cableSizes[cableSizes.length - 1];
                const resistance = cableData[cableType].resistance * length / 1000;
                const voltageDrop = (2 * current * resistance / voltage) * 100;
                const materialCost = length * cableData[cableType].costPerMeter * safeNumber(document.getElementById('materialMultiplier').value);
                const laborCost = (length * 0.05 + 2) * safeNumber(document.getElementById('laborRate').value);

                wsData.push([
                    `Circuit ${index + 1}`,
                    load,
                    current,
                    selectedSize,
                    length,
                    voltageDrop,
                    materialCost,
                    laborCost
                ]);
            });

            wsData.push([]);
            wsData.push(['Total Material Cost', parseFloat(document.getElementById('totalMaterial').textContent), 'PHP']);
            wsData.push(['Total Labor Cost', parseFloat(document.getElementById('totalLabor').textContent), 'PHP']);
            wsData.push(['Overhead Cost', parseFloat(document.getElementById('overheadCost').textContent), 'PHP']);
            wsData.push(['Total Project Cost', parseFloat(document.getElementById('totalCost').textContent), 'PHP']);
            wsData.push(['Labor Hours', parseFloat(document.getElementById('laborHours').textContent.replace('Total Labor Hours: ', '')), 'Hours']);
            wsData.push(['Labor Days', parseFloat(document.getElementById('laborDays').textContent.replace('Total Labor Days: ', '')), 'Days']);
            wsData.push(['Suggested Crew Size', parseInt(document.getElementById('crewSize').textContent.replace('Suggested Crew Size: ', '')), 'Workers']);

            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Apply currency formatting
            const currencyCells = ['B' + (wsData.length - 4), 'B' + (wsData.length - 3), 'B' + (wsData.length - 2)];
            currencyCells.forEach(cell => {
                ws[cell] = { v: ws[cell].v, t: 'n', z: '"PHP"#,##0.00' };
            });

            // Apply currency to circuit material/labor costs
            for (let i = 5; i < wsData.length - 7; i++) {
                ws[`G${i + 1}`] = { v: wsData[i][6], t: 'n', z: '"PHP"#,##0.00' };
                ws[`H${i + 1}`] = { v: wsData[i][7], t: 'n', z: '"PHP"#,##0.00' };
            }

            XLSX.utils.book_append_sheet(wb, ws, 'Project Summary');
            XLSX.write(wb, 'Power_Distribution_Calculator.xlsx');
        });

        // Export to PDF
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Power Distribution Systems Calculator', 10, 10);
            doc.autoTable({
                head: [['Circuit', 'Load (kVA)', 'Current (A)', 'Cable Size (mm²)', 'Length (m)', 'Voltage Drop (%)', 'Material Cost (PHP)', 'Labor Cost (PHP)']],
                body: circuits.map((_, index) => {
                    const item = document.querySelectorAll('.work-item')[index];
                    const load = safeNumber(item.querySelector('.circuit-load').value);
                    const pf = safeNumber(item.querySelector('.circuit-pf').value);
                    const length = safeNumber(item.querySelector('.circuit-length').value);
                    const voltage = safeNumber(item.querySelector('.circuit-voltage').value);
                    const phase = item.querySelector('.circuit-phase').value;
                    const current = phase === 'three' ? (load * 1000) / (voltage * pf * Math.sqrt(3)) : (load * 1000) / (voltage * pf);
                    const standard = document.querySelector('.standard-btn.active').dataset.standard;
                    const adjustedCurrent = standard === 'philippine' ? current * 1.25 : current;
                    const cableType = document.getElementById('cableType').value;
                    const cableSizes = cableData[cableType].sizes;
                    const selectedSize = cableSizes.find(size => size * 15 >= adjustedCurrent) || cableSizes[cableSizes.length - 1];
                    const resistance = cableData[cableType].resistance * length / 1000;
                    const voltageDrop = (2 * current * resistance / voltage) * 100;
                    const materialCost = length * cableData[cableType].costPerMeter * safeNumber(document.getElementById('materialMultiplier').value);
                    const laborCost = (length * 0.05 + 2) * safeNumber(document.getElementById('laborRate').value);
                    return [
                        `Circuit ${index + 1}`,
                        load.toFixed(2),
                        current.toFixed(2),
                        selectedSize,
                        length.toFixed(2),
                        voltageDrop.toFixed(2),
                        materialCost.toFixed(2),
                        laborCost.toFixed(2)
                    ];
                }).concat([
                    [],
                    ['Total Material Cost', document.getElementById('totalMaterial').textContent, '', '', '', '', '', ''],
                    ['Total Labor Cost', document.getElementById('totalLabor').textContent, '', '', '', '', '', ''],
                    ['Overhead Cost', document.getElementById('overheadCost').textContent, '', '', '', '', '', ''],
                    ['Total Project Cost', document.getElementById('totalCost').textContent, '', '', '', '', '', ''],
                    ['Labor Hours', document.getElementById('laborHours').textContent, '', '', '', '', '', ''],
                    ['Labor Days', document.getElementById('laborDays').textContent, '', '', '', '', '', ''],
                    ['Suggested Crew Size', document.getElementById('crewSize').textContent, '', '', '', '', '', '']
                ])
            });
            doc.save('Power_Distribution_Calculator.pdf');
        });

        // Reset project
        document.getElementById('resetBtn').addEventListener('click', () => {
            circuits = [];
            document.getElementById('circuitList').innerHTML = '';
            document.getElementById('projectName').value = '';
            document.getElementById('laborRate').value = '250';
            document.getElementById('overheadRate').value = '15';
            document.getElementById('profitMarginRate').value = '20';
            document.getElementById('materialMultiplier').value = '1.2';
            document.getElementById('contingencyRate').value = '10';
            calculate();
        });

        // Recalculate on input change
        document.addEventListener('input', (e) => {
            if (e.target.closest('.input-section')) calculate();
        });

        // Initial calculation
        calculate();
    </script>
</body>
</html>
