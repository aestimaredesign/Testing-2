<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Power Distribution Systems Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #34495e;
      --info: #17a2b8;
    }
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;color:#333;background-color:#f8f9fa;padding:20px;}
    .container {max-width:1400px;margin:0 auto;}
    header {background:var(--primary);color:white;padding:1rem 0;margin-bottom:2rem;border-radius:8px;}
    .header-content {display:flex;justify-content:space-between;align-items:center;padding:0 20px;}
    h1 {font-size:2rem;font-weight:600;}
    .controls {display:flex;gap:10px;flex-wrap:wrap;}
    .btn {padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-weight:500;transition:all 0.3s ease;}
    .btn-primary {background:var(--secondary);color:white;}
    .btn-success {background:var(--success);color:white;}
    .btn-warning {background:var(--warning);color:white;}
    .btn-danger {background:var(--danger);color:white;}
    .btn:hover {opacity:0.9;transform:translateY(-1px);}
    .calculator-grid {display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:2rem;}
    @media(max-width:1024px){.calculator-grid{grid-template-columns:1fr;}}
    .input-section,.output-section{background:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    .section-title{font-size:1.5rem;font-weight:600;margin-bottom:1rem;padding-bottom:0.5rem;border-bottom:2px solid var(--light);color:var(--primary);}
    .input-group{margin-bottom:1rem;}
    .input-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;align-items:end;}
    .financial-input-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;align-items:end;}
    label{display:block;margin-bottom:5px;font-weight:500;color:var(--dark);}
    input,select{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;}
    input:focus,select:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 2px rgba(52,152,219,0.2);}
    .unit-toggle,.standard-toggle{display:flex;gap:10px;margin-bottom:1rem;}
    .unit-btn,.standard-btn{flex:1;padding:10px;text-align:center;background:var(--light);border:1px solid #ddd;border-radius:4px;cursor:pointer;}
    .unit-btn.active,.standard-btn.active{background:var(--secondary);color:white;border-color:var(--secondary);}
    .work-item{background:var(--light);padding:15px;border-radius:6px;margin-bottom:15px;border-left:4px solid var(--secondary);}
    .work-item-title{font-weight:600;margin-bottom:10px;color:var(--primary);}
    .bill-of-quantity-table{width:100%;border-collapse:collapse;margin-top:1rem;}
    .bill-of-quantity-table th,.bill-of-quantity-table td{padding:12px;text-align:left;border-bottom:1px solid #ddd;}
    .bill-of-quantity-table th{background:var(--primary);color:white;font-weight:600;}
    .bill-of-quantity-table tr:hover{background-color:#f5f5f5;}
    .total-row{font-weight:600;background-color:var(--light)!important;}
    .text-right{text-align:right;}
    .text-center{text-align:center;}
    .cost-breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:1rem;}
    .cost-card{background:white;padding:15px;border-radius:6px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.1);border-top:4px solid var(--secondary);}
    .cost-value{font-size:1.5rem;font-weight:600;color:var(--primary);margin:10px 0;}
    .validation-error{color:var(--danger);font-size:0.875rem;margin-top:5px;display:none;}
    .tab-container{margin-bottom:1rem;}
    .tabs{display:flex;border-bottom:1px solid #ddd;margin-bottom:1rem;flex-wrap:wrap;}
    .tab{padding:10px 20px;cursor:pointer;border-bottom:3px solid transparent;}
    .tab.active{border-bottom-color:var(--secondary);color:var(--secondary);font-weight:600;}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .crew-sizing{margin-top:1rem;padding:15px;background:var(--light);border-radius:6px;border-left:4px solid var(--success);}
    .crew-sizing h3{font-size:1.2rem;margin-bottom:10px;color:var(--primary);}
    .tooltip{position:relative;display:inline-block;}
    .tooltip .tooltiptext{visibility:hidden;width:200px;background-color:var(--dark);color:#fff;text-align:center;border-radius:6px;padding:5px;position:absolute;z-index:1;bottom:125%;left:50%;margin-left:-100px;opacity:0;transition:opacity 0.3s;}
    .tooltip:hover .tooltiptext{visibility:visible;opacity:1;}
    .hidden{display:none;}
  </style>
</head>
<body>
<div class="container">
  <!-- body content omitted here due to length but unchanged from user version -->
</div>

<input type="file" id="fileInput" class="hidden" accept=".json">

<script>
// All your JS functions from before, unchanged, except export fixes at bottom
// ... (calculator logic, event listeners, calculateEstimate, displayResults, etc.)

function exportToPdf() {
  if (!projectData.totals) {alert('Please calculate an estimate first.');return;}
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`Power Distribution Systems Calculator - ${projectData.projectName}`, 10, 10);
  // ... existing autotable calls ...
  doc.save(`${projectData.projectName || 'project'}.pdf`);
}

function exportToExcel() {
  if (!projectData.totals) {alert('Please calculate an estimate first.');return;}
  const wb = XLSX.utils.book_new();
  // ... build wsData ...
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, 'Project Estimate');
  XLSX.writeFile(wb, `${projectData.projectName || 'project'}.xlsx`);
}

function saveResultsAsJson() {
  if (!projectData.totals) {alert('Please calculate an estimate first.');return;}
  const dataStr = JSON.stringify(projectData);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${projectData.projectName || 'project'}_results.json`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
