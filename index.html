<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Power Distribution Systems Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #34495e;
      --info: #17a2b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f8f9fa;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 1rem 0;
      margin-bottom: 2rem;
      border-radius: 8px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }

    h1 {
      font-size: 2rem;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--secondary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .calculator-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 2rem;
    }

    @media (max-width: 1024px) {
      .calculator-grid {
        grid-template-columns: 1fr;
      }
    }

    .input-section, .output-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--light);
      color: var(--primary);
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
    }

    .financial-input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--dark);
    }

    input, select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .unit-toggle, .standard-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 1rem;
    }

    .unit-btn, .standard-btn {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: var(--light);
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .unit-btn.active, .standard-btn.active {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }

    .work-item {
      background: var(--light);
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid var(--secondary);
    }

    .work-item-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .bill-of-quantity-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .bill-of-quantity-table th,
    .bill-of-quantity-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .bill-of-quantity-table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    .bill-of-quantity-table tr:hover {
      background-color: #f5f5f5;
    }

    .total-row {
      font-weight: 600;
      background-color: var(--light) !important;
    }

    .text-right {
      text-align: right;
    }

    .text-center {
      text-align: center;
    }

    .cost-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 1rem;
    }

    .cost-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-top: 4px solid var(--secondary);
    }

    .cost-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin: 10px 0;
    }

    .validation-error {
      color: var(--danger);
      font-size: 0.875rem;
      margin-top: 5px;
      display: none;
    }

    .tab-container {
      margin-bottom: 1rem;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      border-bottom-color: var(--secondary);
      color: var(--secondary);
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .crew-sizing {
      margin-top: 1rem;
      padding: 15px;
      background: var(--light);
      border-radius: 6px;
      border-left: 4px solid var(--success);
    }

    .crew-sizing h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--dark);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-content">
      <h1>Power Distribution Systems Calculator</h1>
      <div class="controls">
        <button class="btn btn-primary" id="saveBtn">Save Project</button>
        <button class="btn btn-warning" id="loadBtn">Load Project</button>
        <button class="btn btn-success" id="exportPdfBtn">Export PDF</button>
        <button class="btn btn-success" id="exportExcelBtn">Export Excel</button>
        <button class="btn btn-danger" id="resetBtn">Reset</button>
      </div>
    </div>
  </header>

  <div class="calculator-grid">
    <div class="input-section">
      <h2 class="section-title">Project Inputs</h2>

      <div class="input-group">
        <label class="tooltip">Project Name<span class="tooltiptext">Enter a unique name for the project</span></label>
        <input type="text" id="projectName" placeholder="Enter project name" value="Sample Project">
      </div>

      <div class="input-group">
        <label>Unit System</label>
        <div class="unit-toggle">
          <div class="unit-btn active" data-unit="metric">Metric (SI)</div>
          <div class="unit-btn" data-unit="imperial">Imperial (US)</div>
        </div>
      </div>

      <div class="input-group">
        <label>Electrical Standards</label>
        <div class="standard-toggle">
          <div class="standard-btn active" data-standard="philippine">Philippine (PEC)</div>
          <div class="standard-btn" data-standard="international">International (IEC)</div>
        </div>
      </div>

      <div class="tab-container">
        <div class="tabs" role="tablist">
          <div class="tab active" data-tab="general" role="tab" aria-selected="true" tabindex="0">General Parameters</div>
          <div class="tab" data-tab="circuits" role="tab" aria-selected="false" tabindex="0">Circuits</div>
          <div class="tab" data-tab="distribution" role="tab" aria-selected="false" tabindex="0">Distribution Systems</div>
          <div class="tab" data-tab="cables" role="tab" aria-selected="false" tabindex="0">Cables & Wiring</div>
          <div class="tab" data-tab="costs" role="tab" aria-selected="false" tabindex="0">Cost Settings</div>
          <div class="tab" data-tab="help" role="tab" aria-selected="false" tabindex="0">Help & Reference</div>
        </div>

        <div class="tab-content active" id="general-tab" role="tabpanel">
          <div class="input-row">
            <div class="input-group">
              <label class="tooltip">Labor Rate (per hour)<span class="tooltiptext">Typical: 200-500 PHP or 30-60 USD</span></label>
              <input type="number" id="laborRate" value="250" step="0.01" min="0">
              <div class="unit-label">currency/hour</div>
            </div>
            <div class="input-group">
              <label class="tooltip">Overhead Rate (%)<span class="tooltiptext">Typical: 10-20%</span></label>
              <input type="number" id="overheadRate" value="15" step="0.1" min="0">
            </div>
            <div class="input-group">
              <label class="tooltip">Profit Margin (%)<span class="tooltiptext">Typical: 15-25%</span></label>
              <input type="number" id="profitMarginRate" value="20" step="0.1" min="0">
            </div>
          </div>
          <div class="input-row">
            <div class="input-group">
              <label>Currency</label>
              <select id="currency">
                <option value="PHP">Philippine Peso (₱)</option>
                <option value="USD">US Dollar ($)</option>
                <option value="EUR">Euro (€)</option>
                <option value="JPY">Japanese Yen (¥)</option>
              </select>
            </div>
            <div class="input-group">
              <label>Project Location</label>
              <input type="text" id="projectLocation" placeholder="e.g., Manila, Philippines" value="Manila, Philippines">
            </div>
            <div class="input-group">
              <label>Project Date</label>
              <input type="date" id="projectDate">
            </div>
          </div>
        </div>

        <div class="tab-content" id="circuits-tab" role="tabpanel">
          <button class="btn btn-primary" id="addCircuitBtn">Add Circuit</button>
          <div id="circuitList"></div>
        </div>

        <div class="tab-content" id="distribution-tab" role="tabpanel">
          <div class="work-item">
            <div class="work-item-title">Main Distribution Boards (MDBs)</div>
            <div class="input-row">
              <div class="input-group">
                <label class="tooltip">Quantity<span class="tooltiptext">Typical: 1-5</span></label>
                <input type="number" id="mdbQty" value="1" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Unit Cost<span class="tooltiptext">Typical: 30,000-100,000 PHP</span></label>
                <input type="number" id="mdbUnitCost" value="50000" step="0.01" min="0">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Labor Hours per Unit<span class="tooltiptext">Typical: 12-20 hours</span></label>
                <input type="number" id="mdbLaborHours" value="16" step="0.1" min="0">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
          <div class="work-item">
            <div class="work-item-title">Sub-Main Distribution Boards (SMDBs)</div>
            <div class="input-row">
              <div class="input-group">
                <label class="tooltip">Quantity<span class="tooltiptext">Typical: 2-10</span></label>
                <input type="number" id="smdbQty" value="4" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Unit Cost<span class="tooltiptext">Typical: 15,000-50,000 PHP</span></label>
                <input type="number" id="smdbUnitCost" value="25000" step="0.01" min="0">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Labor Hours per Unit<span class="tooltiptext">Typical: 8-16 hours</span></label>
                <input type="number" id="smdbLaborHours" value="12" step="0.1" min="0">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
          <div class="work-item">
            <div class="work-item-title">Distribution Panels</div>
            <div class="input-row">
              <div class="input-group">
                <label class="tooltip">Quantity<span class="tooltiptext">Typical: 5-20</span></label>
                <input type="number" id="panelQty" value="8" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Unit Cost<span class="tooltiptext">Typical: 5,000-15,000 PHP</span></label>
                <input type="number" id="panelUnitCost" value="8000" step="0.01" min="0">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Labor Hours per Unit<span class="tooltiptext">Typical: 4-8 hours</span></label>
                <input type="number" id="panelLaborHours" value="6" step="0.1" min="0">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
          <div class="work-item">
            <div class="work-item-title">Circuit Breakers</div>
            <div class="input-row">
              <div class="input-group">
                <label class="tooltip">Quantity<span class="tooltiptext">Typical: 10-50</span></label>
                <input type="number" id="breakerQty" value="24" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Unit Cost<span class="tooltiptext">Typical: 800-2,000 PHP</span></label>
                <input type="number" id="breakerUnitCost" value="1200" step="0.01" min="0">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Labor Hours per Unit<span class="tooltiptext">Typical: 0.3-1 hour</span></label>
                <input type="number" id="breakerLaborHours" value="0.5" step="0.1" min="0">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="cables-tab" role="tabpanel">
          <div class="work-item">
            <div class="work-item-title">Power Cables</div>
            <div class="input-row">
              <div class="input-group">
                <label class="tooltip">Length<span class="tooltiptext">Typical: 100-1000 m</span></label>
                <input type="number" id="cableLength" value="500" min="0" step="0.1">
                <div class="unit-label length-unit">meters</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Cost per Unit<span class="tooltiptext">Typical: 100-300 PHP/m (THHN 4mm²)</span></label>
                <input type="number" id="cableCostPerUnit" value="150" step="0.01" min="0">
                <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
              </div>
              <div class="input-group">
                <label class="tooltip">Labor Hours per 100m<span class="tooltiptext">Typical: 6-10 hours</span></label>
                <input type="number" id="cableLaborHours" value="8" step="0.1" min="0">
                <div class="unit-label">hours</div>
              </div>
            </div>
            <div class="input-group">
              <label>Cable Type</label>
              <select id="cableType">
                <option value="THHN">THHN Copper</option>
                <option value="THWN">THWN Copper</option>
                <option value="XLPE">XLPE Aluminum</option>
              </select>
            </div>
          </div>
          <div class="work-item">
            <div class="work-item-title">Cable Trays/Conduits</div>
            <div class="input-row">
              <div class="input-group">
                <label class="tooltip">Length<span class="tooltiptext">Typical: 50-500 m</span></label>
                <input type="number" id="trayLength" value="300" min="0" step="0.1">
                <div class="unit-label length-unit">meters</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Cost per Unit<span class="tooltiptext">Typical: 50-150 PHP/m</span></label>
                <input type="number" id="trayCostPerUnit" value="80" step="0.01" min="0">
                <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
              </div>
              <div class="input-group">
                <label class="tooltip">Labor Hours per 100m<span class="tooltiptext">Typical: 10-15 hours</span></label>
                <input type="number" id="trayLaborHours" value="12" step="0.1" min="0">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
          <div class="work-item">
            <div class="work-item-title">Bus Ducts</div>
            <div class="input-row">
              <div class="input-group">
                <label class="tooltip">Length<span class="tooltiptext">Typical: 10-100 m</span></label>
                <input type="number" id="busductLength" value="50" min="0" step="0.1">
                <div class="unit-label length-unit">meters</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Cost per Unit<span class="tooltiptext">Typical: 1,500-3,000 PHP/m</span></label>
                <input type="number" id="busductCostPerUnit" value="2000" step="0.01" min="0">
                <div class="unit-label">currency/<span class="length-unit-short">m</span></div>
              </div>
              <div class="input-group">
                <label class="tooltip">Labor Hours per 10m<span class="tooltiptext">Typical: 12-20 hours</span></label>
                <input type="number" id="busductLaborHours" value="16" step="0.1" min="0">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
          <div class="work-item">
            <div class="work-item-title">Wiring Devices (Outlets, Switches)</div>
            <div class="input-row">
              <div class="input-group">
                <label class="tooltip">Quantity<span class="tooltiptext">Typical: 20-100</span></label>
                <input type="number" id="wiringDeviceQty" value="60" min="0">
                <div class="unit-label">pcs</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Unit Cost<span class="tooltiptext">Typical: 100-300 PHP</span></label>
                <input type="number" id="wiringDeviceUnitCost" value="150" step="0.01" min="0">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Labor Hours per Unit<span class="tooltiptext">Typical: 0.2-0.5 hours</span></label>
                <input type="number" id="wiringDeviceLaborHours" value="0.25" step="0.1" min="0">
                <div class="unit-label">hours</div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="costs-tab" role="tabpanel">
          <div class="work-item">
            <div class="work-item-title">Direct Costs</div>
            <div class="financial-input-row">
              <div class="input-group">
                <label class="tooltip">Equipment Rental/Mobilization<span class="tooltiptext">Typical: 10,000-50,000 PHP</span></label>
                <input type="number" id="equipmentCost" value="15000" step="0.01" min="0">
                <div class="unit-label">currency</div>
              </div>
              <div class="input-group">
                <label class="tooltip">Tools & Consumables<span class="tooltiptext">Typical: 2,000-10,000 PHP</span></label>
                <input type="number" id="toolsCost" value="5000" step="0.01" min="0">
                <div class="unit-label">currency</div>
              </div>
            </div>
          </div>
          <div class="work-item">
            <div class="work-item-title">Indirect Costs</div>
            <div class="financial-input-row">
              <div class="input-group">
                <label class="tooltip">Contingency (%)<span class="tooltiptext">Typical: 5-15%</span></label>
                <input type="number" id="contingencyRate" value="10" step="0.1" min="0">
              </div>
              <div class="input-group">
                <label class="tooltip">VAT Tax Rate (%)<span class="tooltiptext">Typical: 0-12% (12% for Philippines)</span></label>
                <input type="number" id="taxRate" value="12" step="0.1" min="0">
              </div>
            </div>
            <div class="financial-input-row">
              <div class="input-group">
                <label class="tooltip">Permits & Fees<span class="tooltiptext">Typical: 5,000-20,000 PHP</span></label>
                <input type="number" id="permitsCost" value="10000" step="0.01" min="0">
                <div class="unit-label">currency</div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="help-tab" role="tabpanel">
          <div class="help-section">
            <h3>How to Use This Calculator</h3>
            <div class="step-guide">
              <p><span class="step-number">1</span> <strong>Project Information:</strong> Enter project name, location, date, unit system, and electrical standards.</p>
              <p><span class="step-number">2</span> <strong>Circuits:</strong> Add circuits with load, power factor, voltage, and phase for electrical calculations.</p>
              <p><span class="step-number">3</span> <strong>Distribution Systems:</strong> Input quantities and costs for MDBs, SMDBs, panels, and breakers.</p>
              <p><span class="step-number">4</span> <strong>Cables & Wiring:</strong> Specify lengths, cable types, and costs for cables, trays, bus ducts, and wiring devices.</p>
              <p><span class="step-number">5</span> <strong>Cost Settings:</strong> Configure direct (equipment, tools) and indirect costs (contingency, tax, permits).</p>
              <p><span class="step-number">6</span> <strong>Calculate:</strong> Click "Calculate" to generate BOQ, cost breakdown, and crew sizing.</p>
              <p><span class="step-number">7</span> <strong>Export:</strong> Save results as PDF, Excel, or JSON for professional submissions.</p>
            </div>
            <div class="formula-box">
              Voltage Drop (%) = (2 × I × L × R) / V × 100<br>
              Total Cost = (Material + Labor + Equipment + Tools) × (1 + Overhead%) × (1 + Contingency%) + Permits × (1 + Profit%) × (1 + Tax%)
            </div>
            <div class="reference-box">
              PEC: Use 125% of continuous load for ampacity.<br>
              IEC: Refer to IEC 60364 for cable sizing.
            </div>
          </div>
        </div>
      </div>

      <div class="validation-error" id="validationError">
        Please check your inputs. Some values are missing or invalid.
      </div>

      <button class="btn btn-primary" id="calculateBtn" style="width: 100%; padding: 12px; margin-top: 20px;">
        Calculate Estimate
      </button>
    </div>

    <div class="output-section">
      <h2 class="section-title">Estimate Results</h2>

      <div id="resultsPlaceholder">
        <p style="text-align: center; padding: 40px; color: #666; font-style: italic;">
          Enter your project details and click "Calculate" to see results.
        </p>
      </div>

      <div id="resultsContent" class="hidden">
        <h3>Project: <span id="resultProjectName"></span></h3>
        <p><strong>Location:</strong> <span id="resultProjectLocation"></span></p>
        <p><strong>Date:</strong> <span id="resultProjectDate"></span></p>
        <p><strong>Standard:</strong> <span id="resultStandard"></span></p>

        <h4 style="margin-top: 20px;">Circuit Details</h4>
        <table class="bill-of-quantity-table" id="circuitTable">
          <thead>
            <tr>
              <th class="text-center">Circuit No.</th>
              <th class="text-center">Load (kVA)</th>
              <th class="text-center">Power Factor</th>
              <th class="text-center">Voltage (V)</th>
              <th class="text-center">Phase</th>
              <th class="text-center">Length (m)</th>
              <th class="text-center">Current (A)</th>
              <th class="text-center">Cable Size (mm²)</th>
              <th class="text-center">Voltage Drop (%)</th>
            </tr>
          </thead>
          <tbody id="circuitTableBody"></tbody>
        </table>

        <h4 style="margin-top: 20px;">Bill of Quantity</h4>
        <table class="bill-of-quantity-table" id="billOfQuantityTable">
          <thead>
            <tr>
              <th class="text-center">Item No.</th>
              <th>Scope of Work</th>
              <th class="text-center">Quantity</th>
              <th class="text-center">Unit</th>
              <th class="text-right">Material Cost</th>
              <th class="text-right">Labor Hours</th>
              <th class="text-right">Labor Cost</th>
              <th class="text-right">Total Cost</th>
            </tr>
          </thead>
          <tbody id="billOfQuantityTableBody"></tbody>
        </table>

        <h4 style="margin-top: 20px;">Summary</h4>
        <table class="bill-of-quantity-table">
          <thead>
            <tr>
              <th>Category</th>
              <th class="text-right">Material Cost</th>
              <th class="text-right">Labor Hours</th>
              <th class="text-right">Labor Cost</th>
              <th class="text-right">Total Cost</th>
            </tr>
          </thead>
          <tbody id="summaryTableBody"></tbody>
        </table>

        <div class="crew-sizing">
          <h3>Crew Sizing Estimate</h3>
          <div id="laborHours">Total Labor Hours: 0</div>
          <div id="laborDays">Total Labor Days: 0</div>
          <div id="crewSize">Suggested Crew Size: 0</div>
        </div>

        <div class="export-options">
          <button class="btn btn-success" id="saveResultsBtn">Save Results as JSON</button>
        </div>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" class="hidden" accept=".json">

<script>
// Global variables
let currentUnitSystem = 'metric';
let currentStandard = 'philippine';
let projectData = {};
let circuits = [];
const FEET_PER_METER = 3.28084;

// Cable data (resistance in ohms/km, cost in PHP/m)
const cableData = {
  THHN: { resistance: 0.005, costPerMeter: 150, sizes: [2, 3.5, 5.5, 8, 14] },
  THWN: { resistance: 0.006, costPerMeter: 160, sizes: [2, 3.5, 5.5, 8, 14] },
  XLPE: { resistance: 0.008, costPerMeter: 120, sizes: [4, 6, 10, 16, 25] }
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  // Set today's date
  const today = new Date();
  document.getElementById('projectDate').value = today.toISOString().split('T')[0];
  
  // Initialize event listeners
  initializeEventListeners();
  
  // Update unit labels
  updateUnitLabels();
});

function initializeEventListeners() {
  // Unit system toggle
  document.querySelectorAll('.unit-btn').forEach(button => {
    button.addEventListener('click', function() {
      const newUnit = this.dataset.unit;
      document.querySelectorAll('.unit-btn').forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      if (newUnit !== currentUnitSystem) {
        convertUnits(newUnit);
      }
      currentUnitSystem = newUnit;
      updateUnitLabels();
      calculateEstimate();
    });
  });

  // Standard toggle
  document.querySelectorAll('.standard-btn').forEach(button => {
    button.addEventListener('click', function() {
      const newStandard = this.dataset.standard;
      document.querySelectorAll('.standard-btn').forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      currentStandard = newStandard;
      updateStandards();
      calculateEstimate();
    });
  });

  // Tab navigation with ARIA and keyboard support
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab));
    tab.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        switchTab(tab);
      }
    });
  });

  function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => {
      t.classList.remove('active');
      t.setAttribute('aria-selected', 'false');
      t.setAttribute('tabindex', '0');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    tab.classList.add('active');
    tab.setAttribute('aria-selected', 'true');
    tab.setAttribute('tabindex', '-1');
    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
  }

  // Add circuit
  document.getElementById('addCircuitBtn').addEventListener('click', () => {
    const circuitId = circuits.length + 1;
    const circuitDiv = document.createElement('div');
    circuitDiv.className = 'work-item';
    circuitDiv.innerHTML = `
      <div class="work-item-title">Circuit ${circuitId}</div>
      <div class="input-row">
        <div class="input-group">
          <label class="tooltip">Load (kVA)<span class="tooltiptext">Typical: 5-50 kVA</span></label>
          <input type="number" class="circuit-load" value="10" step="0.1" min="0">
        </div>
        <div class="input-group">
          <label class="tooltip">Power Factor<span class="tooltiptext">Typical: 0.8-0.95</span></label>
          <input type="number" class="circuit-pf" value="0.85" step="0.01" min="0.1" max="1">
        </div>
        <div class="input-group">
          <label class="tooltip">Length (m)<span class="tooltiptext">Typical: 10-200 m</span></label>
          <input type="number" class="circuit-length" value="50" step="1" min="0">
        </div>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label class="tooltip">Voltage (V)<span class="tooltiptext">Typical: 230/400 V</span></label>
          <input type="number" class="circuit-voltage" value="230" step="1" min="0">
        </div>
        <div class="input-group">
          <label>Phase</label>
          <select class="circuit-phase">
            <option value="single">Single Phase</option>
            <option value="three">Three Phase</option>
          </select>
        </div>
        <div class="input-group">
          <button class="btn btn-danger remove-circuit" data-id="${circuitId}">Remove</button>
        </div>
      </div>
    `;
    document.getElementById('circuitList').appendChild(circuitDiv);
    circuits.push({ id: circuitId });
    calculateEstimate();
  });

  // Remove circuit
  document.getElementById('circuitList').addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-circuit')) {
      const id = parseInt(e.target.dataset.id);
      circuits = circuits.filter(c => c.id !== id);
      e.target.closest('.work-item').remove();
      calculateEstimate();
    }
  });

  // Calculate button
  document.getElementById('calculateBtn').addEventListener('click', calculateEstimate);

  // Input change
  document.addEventListener('input', (e) => {
    if (e.target.closest('.input-section')) calculateEstimate();
  });

  // Other buttons
  document.getElementById('saveBtn').addEventListener('click', saveProject);
  document.getElementById('loadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
  document.getElementById('fileInput').addEventListener('change', loadProject);
  document.getElementById('resetBtn').addEventListener('click', resetCalculator);
  document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
  document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
  document.getElementById('saveResultsBtn').addEventListener('click', saveResultsAsJson);
}

// Utility functions
function safeNumber(v, fallback = 0) {
  if (v === '' || v === null || v === undefined) return fallback;
  const n = Number(v);
  return isNaN(n) || n < 0 ? fallback : n;
}

function formatNumber(num, dp = 2) {
  if (typeof num !== 'number' || isNaN(num)) return "0.00";
  return num.toLocaleString(undefined, { minimumFractionDigits: dp, maximumFractionDigits: dp });
}

function formatCurrency(n) {
  if (typeof n !== 'number' || isNaN(n)) return "₱0.00";
  const c = document.getElementById('currency').value;
  const symbol = c === 'PHP' ? '₱' : (c === 'USD' ? '$' : (c === 'EUR' ? '€' : '¥'));
  return `${symbol}${formatNumber(n, 2)}`;
}

function updateUnitLabels() {
  const lengthUnit = currentUnitSystem === 'metric' ? 'meters' : 'feet';
  const lengthUnitShort = currentUnitSystem === 'metric' ? 'm' : 'ft';
  document.querySelectorAll('.length-unit').forEach(unit => unit.textContent = lengthUnit);
  document.querySelectorAll('.length-unit-short').forEach(unit => unit.textContent = lengthUnitShort);
  document.querySelectorAll('.unit-label.currency').forEach(unit => unit.textContent = document.getElementById('currency').value);
}

function convertUnits(newUnit) {
  const factor = (newUnit === 'imperial' && currentUnitSystem === 'metric') ? FEET_PER_METER :
    (newUnit === 'metric' && currentUnitSystem === 'imperial') ? 1 / FEET_PER_METER : 1;
  if (factor === 1) return;
  const lengthIds = ['cableLength', 'trayLength', 'busductLength', 'circuit-length'];
  document.querySelectorAll('[id*="circuit-length"]').forEach(input => {
    input.value = formatNumber(safeNumber(input.value) * factor, 1);
  });
  lengthIds.forEach(id => {
    const input = document.getElementById(id);
    if (input) input.value = formatNumber(safeNumber(input.value) * factor, 1);
  });
}

function updateStandards() {
  const laborRateInput = document.getElementById('laborRate');
  const taxRateInput = document.getElementById('taxRate');
  if (currentStandard === 'philippine') {
    laborRateInput.value = '250';
    taxRateInput.value = '12';
  } else {
    laborRateInput.value = '45';
    taxRateInput.value = '0';
  }
}

function calculateEstimate() {
  // Validate inputs
  const inputs = document.querySelectorAll('input[type="number"]');
  let valid = true;
  inputs.forEach(input => {
    if (safeNumber(input.value) < 0) valid = false;
  });
  const validationError = document.getElementById('validationError');
  if (!valid) {
    validationError.style.display = 'block';
    return;
  } else {
    validationError.style.display = 'none';
  }

  // Get input values
  const laborRate = safeNumber(document.getElementById('laborRate').value);
  const overheadRate = safeNumber(document.getElementById('overheadRate').value) / 100;
  const profitMarginRate = safeNumber(document.getElementById('profitMarginRate').value) / 100;
  const contingencyRate = safeNumber(document.getElementById('contingencyRate').value) / 100;
  const taxRate = safeNumber(document.getElementById('taxRate').value) / 100;
  const equipmentCost = safeNumber(document.getElementById('equipmentCost').value);
  const toolsCost = safeNumber(document.getElementById('toolsCost').value);
  const permitsCost = safeNumber(document.getElementById('permitsCost').value);

  // Circuit calculations
  const circuitRows = [];
  let totalCircuitMaterialCost = 0;
  let totalCircuitLaborHours = 0;
  let totalCircuitLaborCost = 0;

  document.querySelectorAll('.work-item[id*="circuit"]').forEach((item, index) => {
    const load = safeNumber(item.querySelector('.circuit-load').value);
    const pf = safeNumber(item.querySelector('.circuit-pf').value);
    const length = safeNumber(item.querySelector('.circuit-length').value);
    const voltage = safeNumber(item.querySelector('.circuit-voltage').value);
    const phase = item.querySelector('.circuit-phase').value;
    const cableType = document.getElementById('cableType').value;

    // Calculate current
    const current = phase === 'three' ? (load * 1000) / (voltage * pf * Math.sqrt(3)) : (load * 1000) / (voltage * pf);

    // Cable sizing (simplified, using PEC 125% rule for continuous loads)
    const adjustedCurrent = currentStandard === 'philippine' ? current * 1.25 : current;
    const cableSizes = cableData[cableType].sizes;
    const selectedSize = cableSizes.find(size => size * 15 >= adjustedCurrent) || cableSizes[cableSizes.length - 1];

    // Voltage drop
    const resistance = cableData[cableType].resistance * length / 1000;
    const voltageDrop = (2 * current * resistance / voltage) * 100;

    // Costs
    const materialCost = length * cableData[cableType].costPerMeter;
    const laborHours = length * (safeNumber(document.getElementById('cableLaborHours').value) / 100);
    const laborCost = laborHours * laborRate;

    totalCircuitMaterialCost += materialCost;
    totalCircuitLaborHours += laborHours;
    totalCircuitLaborCost += laborCost;

    circuitRows.push({
      circuit: `Circuit ${index + 1}`,
      load: load.toFixed(2),
      pf: pf.toFixed(2),
      voltage: voltage.toFixed(0),
      phase: phase === 'single' ? 'Single' : 'Three',
      length: length.toFixed(1),
      current: current.toFixed(2),
      cableSize: selectedSize,
      voltageDrop: voltageDrop.toFixed(2)
    });
  });

  // Work items
  const workItems = [
    {
      name: 'Main Distribution Boards (MDBs)',
      quantity: safeNumber(document.getElementById('mdbQty').value),
      unitCost: safeNumber(document.getElementById('mdbUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('mdbLaborHours').value),
      unit: 'pcs'
    },
    {
      name: 'Sub-Main Distribution Boards (SMDBs)',
      quantity: safeNumber(document.getElementById('smdbQty').value),
      unitCost: safeNumber(document.getElementById('smdbUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('smdbLaborHours').value),
      unit: 'pcs'
    },
    {
      name: 'Distribution Panels',
      quantity: safeNumber(document.getElementById('panelQty').value),
      unitCost: safeNumber(document.getElementById('panelUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('panelLaborHours').value),
      unit: 'pcs'
    },
    {
      name: 'Circuit Breakers',
      quantity: safeNumber(document.getElementById('breakerQty').value),
      unitCost: safeNumber(document.getElementById('breakerUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('breakerLaborHours').value),
      unit: 'pcs'
    },
    {
      name: 'Power Cables',
      quantity: safeNumber(document.getElementById('cableLength').value),
      unitCost: safeNumber(document.getElementById('cableCostPerUnit').value),
      laborHoursPerUnit: safeNumber(document.getElementById('cableLaborHours').value) / 100,
      unit: currentUnitSystem === 'metric' ? 'm' : 'ft'
    },
    {
      name: 'Cable Trays/Conduits',
      quantity: safeNumber(document.getElementById('trayLength').value),
      unitCost: safeNumber(document.getElementById('trayCostPerUnit').value),
      laborHoursPerUnit: safeNumber(document.getElementById('trayLaborHours').value) / 100,
      unit: currentUnitSystem === 'metric' ? 'm' : 'ft'
    },
    {
      name: 'Bus Ducts',
      quantity: safeNumber(document.getElementById('busductLength').value),
      unitCost: safeNumber(document.getElementById('busductCostPerUnit').value),
      laborHoursPerUnit: safeNumber(document.getElementById('busductLaborHours').value) / 10,
      unit: currentUnitSystem === 'metric' ? 'm' : 'ft'
    },
    {
      name: 'Wiring Devices',
      quantity: safeNumber(document.getElementById('wiringDeviceQty').value),
      unitCost: safeNumber(document.getElementById('wiringDeviceUnitCost').value),
      laborHoursPerUnit: safeNumber(document.getElementById('wiringDeviceLaborHours').value),
      unit: 'pcs'
    }
  ];

  // Calculate totals
  let totalMaterialCost = totalCircuitMaterialCost;
  let totalLaborHours = totalCircuitLaborHours;
  let totalLaborCost = totalCircuitLaborCost;

  workItems.forEach(item => {
    item.materialCost = item.quantity * item.unitCost;
    item.laborHours = item.quantity * item.laborHoursPerUnit;
    item.laborCost = item.laborHours * laborRate;
    item.totalCost = item.materialCost + item.laborCost;

    totalMaterialCost += item.materialCost;
    totalLaborHours += item.laborHours;
    totalLaborCost += item.laborCost;
  });

  // Add direct costs
  const totalDirectCost = totalMaterialCost + totalLaborCost + equipmentCost + toolsCost;

  // Calculate indirect costs
  const overheadCost = totalDirectCost * overheadRate;
  const contingencyCost = totalDirectCost * contingencyRate;
  const totalIndirectCost = overheadCost + contingencyCost + permitsCost;

  // Calculate profit and tax
  const costBeforeProfit = totalDirectCost + totalIndirectCost;
  const profit = costBeforeProfit * profitMarginRate;
  const totalBeforeTax = costBeforeProfit + profit;
  const tax = totalBeforeTax * taxRate;
  const finalPrice = totalBeforeTax + tax;

  // Crew sizing
  const laborDays = totalLaborHours / 8;
  const suggestedCrew = Math.min(Math.max(Math.ceil(laborDays / 10), 2), 15);

  // Store results
  projectData = {
    projectName: document.getElementById('projectName').value || 'Unnamed Project',
    projectLocation: document.getElementById('projectLocation').value,
    projectDate: document.getElementById('projectDate').value,
    unitSystem: currentUnitSystem,
    standard: currentStandard,
    currency: document.getElementById('currency').value,
    circuits: circuitRows,
    workItems: workItems,
    totals: {
      totalMaterialCost,
      totalLaborHours,
      totalLaborCost,
      totalDirectCost,
      overheadCost,
      contingencyCost,
      totalIndirectCost,
      costBeforeProfit,
      profit,
      tax,
      finalPrice,
      laborDays,
      suggestedCrew
    }
  };

  // Display results
  displayResults();
}

function displayResults() {
  const resultsContent = document.getElementById('resultsContent');
  const resultsPlaceholder = document.getElementById('resultsPlaceholder');
  
  // Update project info
  document.getElementById('resultProjectName').textContent = projectData.projectName;
  document.getElementById('resultProjectLocation').textContent = projectData.projectLocation || 'Not specified';
  document.getElementById('resultProjectDate').textContent = projectData.projectDate || 'Not specified';
  document.getElementById('resultStandard').textContent = projectData.standard === 'philippine' ? 'Philippine Electrical Code (PEC)' : 'International (IEC)';

  // Update circuit table
  const circuitTableBody = document.getElementById('circuitTableBody');
  circuitTableBody.innerHTML = projectData.circuits.map(row => `
    <tr>
      <td class="text-center">${row.circuit}</td>
      <td class="text-center">${row.load}</td>
      <td class="text-center">${row.pf}</td>
      <td class="text-center">${row.voltage}</td>
      <td class="text-center">${row.phase}</td>
      <td class="text-center">${row.length}</td>
      <td class="text-center">${row.current}</td>
      <td class="text-center">${row.cableSize}</td>
      <td class="text-center">${row.voltageDrop}</td>
    </tr>
  `).join('');

  // Update bill of quantity table
  const billOfQuantityTableBody = document.getElementById('billOfQuantityTableBody');
  billOfQuantityTableBody.innerHTML = '';
  let itemNo = 1;

  projectData.workItems.forEach(item => {
    if (item.quantity > 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="text-center">${itemNo++}</td>
        <td>${item.name}</td>
        <td class="text-center">${formatNumber(item.quantity)}</td>
        <td class="text-center">${item.unit}</td>
        <td class="text-right">${formatCurrency(item.materialCost)}</td>
        <td class="text-right">${formatNumber(item.laborHours, 1)}</td>
        <td class="text-right">${formatCurrency(item.laborCost)}</td>
        <td class="text-right">${formatCurrency(item.totalCost)}</td>
      `;
      billOfQuantityTableBody.appendChild(row);
    }
  });

  // Add equipment and tools
  if (projectData.totals.equipmentCost > 0) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="text-center">${itemNo++}</td>
      <td>Equipment Rental/Mobilization</td>
      <td class="text-center">1</td>
      <td class="text-center">lot</td>
      <td class="text-right">${formatCurrency(projectData.totals.equipmentCost)}</td>
      <td class="text-right">-</td>
      <td class="text-right">-</td>
      <td class="text-right">${formatCurrency(projectData.totals.equipmentCost)}</td>
    `;
    billOfQuantityTableBody.appendChild(row);
  }

  if (projectData.totals.toolsCost > 0) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="text-center">${itemNo++}</td>
      <td>Tools & Consumables</td>
      <td class="text-center">1</td>
      <td class="text-center">lot</td>
      <td class="text-right">${formatCurrency(projectData.totals.toolsCost)}</td>
      <td class="text-right">-</td>
      <td class="text-right">-</td>
      <td class="text-right">${formatCurrency(projectData.totals.toolsCost)}</td>
    `;
    billOfQuantityTableBody.appendChild(row);
  }

  // Update summary table
  const summaryTableBody = document.getElementById('summaryTableBody');
  summaryTableBody.innerHTML = '';

  const summaryData = [
    { label: 'Materials', material: projectData.totals.totalMaterialCost, laborHours: 0, labor: 0, total: projectData.totals.totalMaterialCost },
    { label: 'Labor', material: 0, laborHours: projectData.totals.totalLaborHours, labor: projectData.totals.totalLaborCost, total: projectData.totals.totalLaborCost },
    { label: 'Equipment & Tools', material: projectData.totals.equipmentCost + projectData.totals.toolsCost, laborHours: 0, labor: 0, total: projectData.totals.equipmentCost + projectData.totals.toolsCost },
    { label: 'Direct Costs Subtotal', material: projectData.totals.totalMaterialCost + projectData.totals.equipmentCost + projectData.totals.toolsCost, laborHours: projectData.totals.totalLaborHours, labor: projectData.totals.totalLaborCost, total: projectData.totals.totalDirectCost },
    { label: 'Overhead & Contingency', material: projectData.totals.overheadCost + projectData.totals.contingencyCost, laborHours: 0, labor: 0, total: projectData.totals.overheadCost + projectData.totals.contingencyCost },
    { label: 'Permits & Fees', material: projectData.totals.permitsCost, laborHours: 0, labor: 0, total: projectData.totals.permitsCost },
    { label: 'Profit', material: projectData.totals.profit, laborHours: 0, labor: 0, total: projectData.totals.profit },
    { label: 'VAT Tax', material: projectData.totals.tax, laborHours: 0, labor: 0, total: projectData.totals.tax }
  ];

  summaryData.forEach(item => {
    const row = document.createElement('tr');
    if (item.label.includes('Subtotal') || item.label.includes('FINAL')) {
      row.className = 'total-row';
    }
    row.innerHTML = `
      <td>${item.label}</td>
      <td class="text-right">${item.material > 0 ? formatCurrency(item.material) : '-'}</td>
      <td class="text-right">${item.laborHours > 0 ? formatNumber(item.laborHours, 1) : '-'}</td>
      <td class="text-right">${item.labor > 0 ? formatCurrency(item.labor) : '-'}</td>
      <td class="text-right">${formatCurrency(item.total)}</td>
    `;
    summaryTableBody.appendChild(row);
  });

  // Add final price row
  const finalRow = document.createElement('tr');
  finalRow.className = 'total-row';
  finalRow.innerHTML = `
    <td><strong>FINAL PRICE</strong></td>
    <td class="text-right"><strong>-</strong></td>
    <td class="text-right"><strong>-</strong></td>
    <td class="text-right"><strong>-</strong></td>
    <td class="text-right"><strong>${formatCurrency(projectData.totals.finalPrice)}</strong></td>
  `;
  summaryTableBody.appendChild(finalRow);

  // Update crew sizing
  document.getElementById('laborHours').textContent = `Total Labor Hours: ${formatNumber(projectData.totals.totalLaborHours, 1)}`;
  document.getElementById('laborDays').textContent = `Total Labor Days: ${formatNumber(projectData.totals.laborDays, 1)}`;
  document.getElementById('crewSize').textContent = `Suggested Crew Size: ${projectData.totals.suggestedCrew}`;

  // Show results
  resultsPlaceholder.classList.add('hidden');
  resultsContent.classList.remove('hidden');
}

function saveProject() {
  const dataStr = JSON.stringify(projectData);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${projectData.projectName || 'project'}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function loadProject(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      // Update inputs
      document.getElementById('projectName').value = data.projectName;
      document.getElementById('projectLocation').value = data.projectLocation;
      document.getElementById('projectDate').value = data.projectDate;
      document.getElementById('currency').value = data.currency;
      document.getElementById('laborRate').value = data.totals.laborRate || 250;
      document.getElementById('overheadRate').value = data.totals.overheadRate * 100 || 15;
      document.getElementById('profitMarginRate').value = data.totals.profitMarginRate * 100 || 20;
      document.getElementById('contingencyRate').value = data.totals.contingencyRate * 100 || 10;
      document.getElementById('taxRate').value = data.totals.taxRate * 100 || 12;
      document.getElementById('equipmentCost').value = data.totals.equipmentCost || 15000;
      document.getElementById('toolsCost').value = data.totals.toolsCost || 5000;
      document.getElementById('permitsCost').value = data.totals.permitsCost || 10000;
      data.workItems.forEach(item => {
        const idPrefix = item.name.toLowerCase().replace(/[^a-z0-9]/g, '');
        document.getElementById(`${idPrefix}Qty`)?.value = item.quantity;
        document.getElementById(`${idPrefix}UnitCost`)?.value = item.unitCost;
        document.getElementById(`${idPrefix}LaborHours`)?.value = item.laborHoursPerUnit * (item.name.includes('Cables') || item.name.includes('Trays') ? 100 : item.name.includes('Bus Ducts') ? 10 : 1);
      });
      // Clear and rebuild circuits
      circuits = [];
      document.getElementById('circuitList').innerHTML = '';
      data.circuits?.forEach((circuit, index) => {
        const circuitDiv = document.createElement('div');
        circuitDiv.className = 'work-item';
        circuitDiv.innerHTML = `
          <div class="work-item-title">Circuit ${index + 1}</div>
          <div class="input-row">
            <div class="input-group">
              <label class="tooltip">Load (kVA)<span class="tooltiptext">Typical: 5-50 kVA</span></label>
              <input type="number" class="circuit-load" value="${circuit.load}" step="0.1" min="0">
            </div>
            <div class="input-group">
              <label class="tooltip">Power Factor<span class="tooltiptext">Typical: 0.8-0.95</span></label>
              <input type="number" class="circuit-pf" value="${circuit.pf}" step="0.01" min="0.1" max="1">
            </div>
            <div class="input-group">
              <label class="tooltip">Length (m)<span class="tooltiptext">Typical: 10-200 m</span></label>
              <input type="number" class="circuit-length" value="${circuit.length}" step="1" min="0">
            </div>
          </div>
          <div class="input-row">
            <div class="input-group">
              <label class="tooltip">Voltage (V)<span class="tooltiptext">Typical: 230/400 V</span></label>
              <input type="number" class="circuit-voltage" value="${circuit.voltage}" step="1" min="0">
            </div>
            <div class="input-group">
              <label>Phase</label>
              <select class="circuit-phase">
                <option value="single" ${circuit.phase === 'Single' ? 'selected' : ''}>Single Phase</option>
                <option value="three" ${circuit.phase === 'Three' ? 'selected' : ''}>Three Phase</option>
              </select>
            </div>
            <div class="input-group">
              <button class="btn btn-danger remove-circuit" data-id="${index + 1}">Remove</button>
            </div>
          </div>
        `;
        document.getElementById('circuitList').appendChild(circuitDiv);
        circuits.push({ id: index + 1 });
      });
      calculateEstimate();
    } catch (err) {
      alert('Error loading project file.');
    }
  };
  reader.readAsText(file);
}

function resetCalculator() {
  if (confirm('Are you sure you want to reset all inputs?')) {
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.value = input.getAttribute('value') || '0';
    });
    document.getElementById('projectName').value = 'Sample Project';
    document.getElementById('projectLocation').value = 'Manila, Philippines';
    document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('currency').value = 'PHP';
    circuits = [];
    document.getElementById('circuitList').innerHTML = '';
    document.getElementById('resultsContent').classList.add('hidden');
    document.getElementById('resultsPlaceholder').classList.remove('hidden');
    projectData = {};
    calculateEstimate();
  }
}

function exportToPdf() {
  if (!projectData.totals) {
    alert('Please calculate an estimate first.');
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`Power Distribution Systems Calculator - ${projectData.projectName}`, 10, 10);
  doc.autoTable({
    head: [['Item No.', 'Scope of Work', 'Quantity', 'Unit', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']],
    body: projectData.workItems
      .filter(item => item.quantity > 0)
      .map((item, index) => [
        index + 1,
        item.name,
        formatNumber(item.quantity),
        item.unit,
        formatCurrency(item.materialCost),
        formatNumber(item.laborHours, 1),
        formatCurrency(item.laborCost),
        formatCurrency(item.totalCost)
      ])
      .concat([
        ['', 'Equipment Rental/Mobilization', '1', 'lot', formatCurrency(projectData.totals.equipmentCost), '-', '-', formatCurrency(projectData.totals.equipmentCost)],
        ['', 'Tools & Consumables', '1', 'lot', formatCurrency(projectData.totals.toolsCost), '-', '-', formatCurrency(projectData.totals.toolsCost)]
      ]),
    startY: 20
  });
  let finalY = doc.lastAutoTable.finalY;
  doc.autoTable({
    head: [['Category', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']],
    body: [
      ['Materials', formatCurrency(projectData.totals.totalMaterialCost), '-', '-', formatCurrency(projectData.totals.totalMaterialCost)],
      ['Labor', '-', formatNumber(projectData.totals.totalLaborHours, 1), formatCurrency(projectData.totals.totalLaborCost), formatCurrency(projectData.totals.totalLaborCost)],
      ['Equipment & Tools', formatCurrency(projectData.totals.equipmentCost + projectData.totals.toolsCost), '-', '-', formatCurrency(projectData.totals.equipmentCost + projectData.totals.toolsCost)],
      ['Direct Costs Subtotal', formatCurrency(projectData.totals.totalMaterialCost + projectData.totals.equipmentCost + projectData.totals.toolsCost), formatNumber(projectData.totals.totalLaborHours, 1), formatCurrency(projectData.totals.totalLaborCost), formatCurrency(projectData.totals.totalDirectCost)],
      ['Overhead & Contingency', formatCurrency(projectData.totals.overheadCost + projectData.totals.contingencyCost), '-', '-', formatCurrency(projectData.totals.overheadCost + projectData.totals.contingencyCost)],
      ['Permits & Fees', formatCurrency(projectData.totals.permitsCost), '-', '-', formatCurrency(projectData.totals.permitsCost)],
      ['Profit', formatCurrency(projectData.totals.profit), '-', '-', formatCurrency(projectData.totals.profit)],
      ['VAT Tax', formatCurrency(projectData.totals.tax), '-', '-', formatCurrency(projectData.totals.tax)],
      ['FINAL PRICE', '-', '-', '-', formatCurrency(projectData.totals.finalPrice)]
    ],
    startY: finalY + 10
  });
  finalY = doc.lastAutoTable.finalY;
  doc.autoTable({
    head: [['Circuit No.', 'Load (kVA)', 'Power Factor', 'Voltage (V)', 'Phase', 'Length (m)', 'Current (A)', 'Cable Size (mm²)', 'Voltage Drop (%)']],
    body: projectData.circuits.map(row => [
      row.circuit,
      row.load,
      row.pf,
      row.voltage,
      row.phase,
      row.length,
      row.current,
      row.cableSize,
      row.voltageDrop
    ]),
    startY: finalY + 10
  });
  doc.save(`${projectData.projectName || 'project'.pdf);
}function exportToExcel() {
  if (!projectData.totals) {
    alert('Please calculate an estimate first.');
    return;
  }
  const wb = XLSX.utils.book_new();
  const wsData = [
    ['Project Name', projectData.projectName],
    ['Location', projectData.projectLocation || 'Not specified'],
    ['Date', projectData.projectDate || 'Not specified'],
    ['Unit System', projectData.unitSystem],
    ['Standard', projectData.standard === 'philippine' ? 'Philippine Electrical Code (PEC)' : 'International (IEC)'],
    ['Currency', projectData.currency],
    [],
    ['Circuit No.', 'Load (kVA)', 'Power Factor', 'Voltage (V)', 'Phase', 'Length (m)', 'Current (A)', 'Cable Size (mm²)', 'Voltage Drop (%)']
  ];  projectData.circuits.forEach(row => {
    wsData.push([
      row.circuit,
      parseFloat(row.load),
      parseFloat(row.pf),
      parseFloat(row.voltage),
      row.phase,
      parseFloat(row.length),
      parseFloat(row.current),
      parseFloat(row.cableSize),
      parseFloat(row.voltageDrop)
    ]);
  });  wsData.push([]);
  wsData.push(['Item No.', 'Scope of Work', 'Quantity', 'Unit', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']);  projectData.workItems
    .filter(item => item.quantity > 0)
    .forEach((item, index) => {
      wsData.push([
        index + 1,
        item.name,
        item.quantity,
        item.unit,
        item.materialCost,
        item.laborHours,
        item.laborCost,
        item.totalCost
      ]);
    });  wsData.push([
    '',
    'Equipment Rental/Mobilization',
    1,
    'lot',
    projectData.totals.equipmentCost,
    0,
    0,
    projectData.totals.equipmentCost
  ]);
  wsData.push([
    '',
    'Tools & Consumables',
    1,
    'lot',
    projectData.totals.toolsCost,
    0,
    0,
    projectData.totals.toolsCost
  ]);  wsData.push([]);
  wsData.push(['Category', 'Material Cost', 'Labor Hours', 'Labor Cost', 'Total Cost']);
  wsData.push(['Materials', projectData.totals.totalMaterialCost, 0, 0, projectData.totals.totalMaterialCost]);
  wsData.push(['Labor', 0, projectData.totals.totalLaborHours, projectData.totals.totalLaborCost, projectData.totals.totalLaborCost]);
  wsData.push(['Equipment & Tools', projectData.totals.equipmentCost + projectData.totals.toolsCost, 0, 0, projectData.totals.equipmentCost + projectData.totals.toolsCost]);
  wsData.push(['Direct Costs Subtotal', projectData.totals.totalMaterialCost + projectData.totals.equipmentCost + projectData.totals.toolsCost, projectData.totals.totalLaborHours, projectData.totals.totalLaborCost, projectData.totals.totalDirectCost]);
  wsData.push(['Overhead & Contingency', projectData.totals.overheadCost + projectData.totals.contingencyCost, 0, 0, projectData.totals.overheadCost + projectData.totals.contingencyCost]);
  wsData.push(['Permits & Fees', projectData.totals.permitsCost, 0, 0, projectData.totals.permitsCost]);
  wsData.push(['Profit', projectData.totals.profit, 0, 0, projectData.totals.profit]);
  wsData.push(['VAT Tax', projectData.totals.tax, 0, 0, projectData.totals.tax]);
  wsData.push(['FINAL PRICE', 0, 0, 0, projectData.totals.finalPrice]);
  wsData.push([]);
  wsData.push(['Labor Hours', projectData.totals.totalLaborHours, '', '', 'Hours']);
  wsData.push(['Labor Days', projectData.totals.laborDays, '', '', 'Days']);
  wsData.push(['Suggested Crew Size', projectData.totals.suggestedCrew, '', '', 'Workers']);  const ws = XLSX.utils.aoa_to_sheet(wsData);  // Apply currency formatting
  const currencyCells = [
    'E10', 'G10', 'H10', // BOQ table
    'B14', 'D14', 'E14', // Summary table
    'B15', 'D15', 'E15',
    'B16', 'E16',
    'B17', 'E17',
    'B18', 'E18',
    'B19', 'E19',
    'B20', 'E20',
    'B21', 'E21'
  ];
  currencyCells.forEach(cell => {
    if (ws[cell]) ws[cell].z = projectData.currency === 'PHP' ? '"₱"#,##0.00' : projectData.currency === 'USD' ? '"$"#,##0.00' : projectData.currency === 'EUR' ? '"€"#,##0.00' : '"¥"#,##0';
  });  // Apply number formatting for quantities and hours
  const numberCells = ['C10', 'F10', 'B12', 'C12', 'B13', 'C13'];
  numberCells.forEach(cell => {
    if (ws[cell]) ws[cell].z = '#,##0.0';
  });  XLSX.utils.book_append_sheet(wb, ws, 'Project Estimate');
  XLSX.write(wb, ${projectData.projectName || 'project'}.xlsx);
}function saveResultsAsJson() {
  if (!projectData.totals) {
    alert('Please calculate an estimate first.');
    return;
  }
  const dataStr = JSON.stringify(projectData);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = ${projectData.projectName || 'project'}_results.json;
  a.click();
  URL.revokeObjectURL(url);
}
</script></body>
</html>


              
